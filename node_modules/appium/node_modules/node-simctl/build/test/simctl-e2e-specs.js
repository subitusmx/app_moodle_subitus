/* global it:true, describe:true*/
require('source-map-support').install();

'use strict';

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _getIterator = require('babel-runtime/core-js/get-iterator')['default'];

var _Object$keys = require('babel-runtime/core-js/object/keys')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

var _chai = require('chai');

var _chai2 = _interopRequireDefault(_chai);

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _libSimctlJs = require('../lib/simctl.js');

var _appiumXcode = require('appium-xcode');

var _appiumXcode2 = _interopRequireDefault(_appiumXcode);

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

var _appiumSupport = require('appium-support');

var _asyncbox = require('asyncbox');

var should = _chai2['default'].should();

describe('simctl', function () {
  var _this = this;

  var DEVICE_NAME = 'iPhone 6';
  var MOCHA_TIMEOUT = 200000;
  this.timeout(MOCHA_TIMEOUT);

  var randName = undefined;
  var randDeviceUdid = null;
  var validSdks = [];

  before(function callee$1$0() {
    var devices, i, randNum, nameFound, _iteratorNormalCompletion, _didIteratorError, _iteratorError, _iterator, _step, list;

    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          context$2$0.next = 2;
          return _regeneratorRuntime.awrap((0, _libSimctlJs.getDevices)());

        case 2:
          devices = context$2$0.sent;

          validSdks = _lodash2['default'].keys(devices).sort(function (a, b) {
            return a - b;
          });

          if (validSdks.length) {
            context$2$0.next = 6;
            break;
          }

          throw new Error('No valid SDKs');

        case 6:
          console.log('Found valid SDKs: ' + validSdks.join(', ')); // eslint-disable-line no-console

          // need to find a random name that does not already exist
          // give it 5 tries
          i = 0;

        case 8:
          if (!(i < 5)) {
            context$2$0.next = 44;
            break;
          }

          randNum = parseInt(Math.random() * 100, 10);

          randName = 'device' + randNum;

          nameFound = false;
          _iteratorNormalCompletion = true;
          _didIteratorError = false;
          _iteratorError = undefined;
          context$2$0.prev = 15;
          _iterator = _getIterator(_lodash2['default'].values(devices));

        case 17:
          if (_iteratorNormalCompletion = (_step = _iterator.next()).done) {
            context$2$0.next = 25;
            break;
          }

          list = _step.value;

          if (!_lodash2['default'].includes(_lodash2['default'].map(list, 'name'), randName)) {
            context$2$0.next = 22;
            break;
          }

          // need to find another random name
          nameFound = true;
          return context$2$0.abrupt('break', 25);

        case 22:
          _iteratorNormalCompletion = true;
          context$2$0.next = 17;
          break;

        case 25:
          context$2$0.next = 31;
          break;

        case 27:
          context$2$0.prev = 27;
          context$2$0.t0 = context$2$0['catch'](15);
          _didIteratorError = true;
          _iteratorError = context$2$0.t0;

        case 31:
          context$2$0.prev = 31;
          context$2$0.prev = 32;

          if (!_iteratorNormalCompletion && _iterator['return']) {
            _iterator['return']();
          }

        case 34:
          context$2$0.prev = 34;

          if (!_didIteratorError) {
            context$2$0.next = 37;
            break;
          }

          throw _iteratorError;

        case 37:
          return context$2$0.finish(34);

        case 38:
          return context$2$0.finish(31);

        case 39:
          if (nameFound) {
            context$2$0.next = 41;
            break;
          }

          return context$2$0.abrupt('break', 44);

        case 41:
          i++;
          context$2$0.next = 8;
          break;

        case 44:
        case 'end':
          return context$2$0.stop();
      }
    }, null, _this, [[15, 27, 31, 39], [32,, 34, 38]]);
  });

  // eslint-disable-line curly
  it('should create a device', function callee$1$0() {
    var udid;
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          context$2$0.next = 2;
          return _regeneratorRuntime.awrap((0, _libSimctlJs.createDevice)(randName, DEVICE_NAME, _lodash2['default'].last(validSdks)));

        case 2:
          udid = context$2$0.sent;

          (typeof udid).should.equal('string');
          udid.length.should.equal(36);

        case 5:
        case 'end':
          return context$2$0.stop();
      }
    }, null, this);
  });

  it('should get devices', function callee$1$0() {
    var sdkDevices;
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          context$2$0.next = 2;
          return _regeneratorRuntime.awrap((0, _libSimctlJs.getDevices)(_lodash2['default'].last(validSdks)));

        case 2:
          sdkDevices = context$2$0.sent;

          _lodash2['default'].map(sdkDevices, 'name').should.include(randName);
          randDeviceUdid = sdkDevices.filter(function (d) {
            return d.name === randName;
          })[0].udid;

        case 5:
        case 'end':
          return context$2$0.stop();
      }
    }, null, this);
  });

  it('should erase devices', function callee$1$0() {
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          context$2$0.next = 2;
          return _regeneratorRuntime.awrap((0, _libSimctlJs.eraseDevice)(randDeviceUdid, 16000));

        case 2:
        case 'end':
          return context$2$0.stop();
      }
    }, null, this);
  });

  it('should delete devices', function callee$1$0() {
    var sdkDevices;
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          context$2$0.next = 2;
          return _regeneratorRuntime.awrap((0, _libSimctlJs.deleteDevice)(randDeviceUdid));

        case 2:
          context$2$0.next = 4;
          return _regeneratorRuntime.awrap((0, _libSimctlJs.getDevices)(_lodash2['default'].last(validSdks)));

        case 4:
          sdkDevices = context$2$0.sent;

          _lodash2['default'].map(sdkDevices, 'name').should.not.include(randName);

        case 6:
        case 'end':
          return context$2$0.stop();
      }
    }, null, this);
  });

  it('should return a nice error for invalid usage', function callee$1$0() {
    var err;
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          err = null;
          context$2$0.prev = 1;
          context$2$0.next = 4;
          return _regeneratorRuntime.awrap((0, _libSimctlJs.createDevice)('foo', 'bar', 'baz'));

        case 4:
          context$2$0.next = 9;
          break;

        case 6:
          context$2$0.prev = 6;
          context$2$0.t0 = context$2$0['catch'](1);

          err = context$2$0.t0;

        case 9:
          should.exist(err);
          err.message.should.include('Invalid device type: bar');

        case 11:
        case 'end':
          return context$2$0.stop();
      }
    }, null, this, [[1, 6]]);
  });

  it('should create a device and be able to see it in devices list right away', function callee$1$0() {
    var sdk, numSimsBefore, udid, numSimsAfter;
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          sdk = _lodash2['default'].last(validSdks);
          context$2$0.next = 3;
          return _regeneratorRuntime.awrap((0, _libSimctlJs.getDevices)());

        case 3:
          context$2$0.t0 = sdk;
          numSimsBefore = context$2$0.sent[context$2$0.t0].length;
          context$2$0.next = 7;
          return _regeneratorRuntime.awrap((0, _libSimctlJs.createDevice)('node-simctl test', DEVICE_NAME, sdk));

        case 7:
          udid = context$2$0.sent;
          context$2$0.next = 10;
          return _regeneratorRuntime.awrap((0, _libSimctlJs.getDevices)());

        case 10:
          context$2$0.t1 = sdk;
          numSimsAfter = context$2$0.sent[context$2$0.t1].length;

          numSimsAfter.should.equal(numSimsBefore + 1);
          (0, _libSimctlJs.deleteDevice)(udid);

        case 14:
        case 'end':
          return context$2$0.stop();
      }
    }, null, this);
  });

  it('should create a device with compatible properties', function callee$1$0() {
    var sdk, devices, firstDevice, expectedList;
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          sdk = _lodash2['default'].last(validSdks);
          context$2$0.next = 3;
          return _regeneratorRuntime.awrap((0, _libSimctlJs.getDevices)());

        case 3:
          context$2$0.t0 = sdk;
          devices = context$2$0.sent[context$2$0.t0];
          firstDevice = devices[0];
          expectedList = ['name', 'sdk', 'state', 'udid'];

          _Object$keys(firstDevice).sort().should.eql(expectedList);

        case 8:
        case 'end':
          return context$2$0.stop();
      }
    }, null, this);
  });

  describe('on running Simulator', function () {
    if (process.env.TRAVIS) {
      this.retries(3);
    }

    var udid = undefined;
    var major = undefined,
        minor = undefined;

    before(function callee$2$0() {
      var _ref, sdk;

      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            context$3$0.next = 2;
            return _regeneratorRuntime.awrap(_appiumXcode2['default'].getVersion(true));

          case 2:
            _ref = context$3$0.sent;
            major = _ref.major;
            minor = _ref.minor;

            if (!(major < 8 || major === 8 && minor < 1)) {
              context$3$0.next = 7;
              break;
            }

            return context$3$0.abrupt('return', this.skip());

          case 7:
            sdk = _lodash2['default'].last(validSdks);
            context$3$0.next = 10;
            return _regeneratorRuntime.awrap((0, _libSimctlJs.createDevice)('runningSimTest', DEVICE_NAME, sdk));

          case 10:
            udid = context$3$0.sent;
            context$3$0.next = 13;
            return _regeneratorRuntime.awrap((0, _libSimctlJs.bootDevice)(udid));

          case 13:
            context$3$0.next = 15;
            return _regeneratorRuntime.awrap((0, _libSimctlJs.launch)(udid, 'com.apple.springboard', MOCHA_TIMEOUT));

          case 15:
            context$3$0.next = 17;
            return _regeneratorRuntime.awrap(_bluebird2['default'].delay(5000));

          case 17:
          case 'end':
            return context$3$0.stop();
        }
      }, null, this);
    });
    after(function callee$2$0() {
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            if (!udid) {
              context$3$0.next = 10;
              break;
            }

            context$3$0.prev = 1;
            context$3$0.next = 4;
            return _regeneratorRuntime.awrap((0, _libSimctlJs.shutdown)(udid));

          case 4:
            context$3$0.next = 8;
            break;

          case 6:
            context$3$0.prev = 6;
            context$3$0.t0 = context$3$0['catch'](1);

          case 8:
            context$3$0.next = 10;
            return _regeneratorRuntime.awrap((0, _libSimctlJs.deleteDevice)(udid));

          case 10:
          case 'end':
            return context$3$0.stop();
        }
      }, null, this, [[1, 6]]);
    });

    describe('pasteboard', function () {
      var pbRetries = 0;
      before(function callee$3$0() {
        return _regeneratorRuntime.async(function callee$3$0$(context$4$0) {
          while (1) switch (context$4$0.prev = context$4$0.next) {
            case 0:
              if (!(major < 8 || major === 8 && minor < 1)) {
                context$4$0.next = 2;
                break;
              }

              return context$4$0.abrupt('return', this.skip());

            case 2:
              if (!(major === 9)) {
                context$4$0.next = 7;
                break;
              }

              if (!process.env.TRAVIS) {
                context$4$0.next = 5;
                break;
              }

              return context$4$0.abrupt('return', this.skip());

            case 5:
              // TODO: recheck when full Xcode 9 comes out to see if pasteboard works better
              pbRetries = 200;
              this.timeout(200 * 1000 * 2);

            case 7:
            case 'end':
              return context$4$0.stop();
          }
        }, null, this);
      });
      it('should set and get the content of the pasteboard', function callee$3$0() {
        var pbContent, encoding;
        return _regeneratorRuntime.async(function callee$3$0$(context$4$0) {
          var _this2 = this;

          while (1) switch (context$4$0.prev = context$4$0.next) {
            case 0:
              pbContent = 'blablabla';
              encoding = 'ascii';
              context$4$0.next = 4;
              return _regeneratorRuntime.awrap((0, _libSimctlJs.setPasteboard)(udid, pbContent, encoding));

            case 4:
              context$4$0.next = 6;
              return _regeneratorRuntime.awrap((0, _asyncbox.retryInterval)(pbRetries, 1000, function callee$4$0() {
                return _regeneratorRuntime.async(function callee$4$0$(context$5$0) {
                  while (1) switch (context$5$0.prev = context$5$0.next) {
                    case 0:
                      context$5$0.next = 2;
                      return _regeneratorRuntime.awrap((0, _libSimctlJs.getPasteboard)(udid, encoding));

                    case 2:
                      context$5$0.t0 = pbContent;
                      context$5$0.sent.should.eql(context$5$0.t0);

                    case 4:
                    case 'end':
                      return context$5$0.stop();
                  }
                }, null, _this2);
              }));

            case 6:
            case 'end':
              return context$4$0.stop();
          }
        }, null, this);
      });
    });

    describe('add media', function () {
      var BASE64_PNG = 'iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==';
      var picturePath = undefined;
      before(function callee$3$0() {
        return _regeneratorRuntime.async(function callee$3$0$(context$4$0) {
          while (1) switch (context$4$0.prev = context$4$0.next) {
            case 0:
              if (!(major < 8 || major === 8 && minor < 1)) {
                context$4$0.next = 2;
                break;
              }

              return context$4$0.abrupt('return', this.skip());

            case 2:
              context$4$0.next = 4;
              return _regeneratorRuntime.awrap(_appiumSupport.tempDir.path({ prefix: 'pixel', suffix: '.png' }));

            case 4:
              picturePath = context$4$0.sent;
              context$4$0.next = 7;
              return _regeneratorRuntime.awrap(_appiumSupport.fs.writeFile(picturePath, new Buffer(BASE64_PNG, 'base64').toString('binary'), 'binary'));

            case 7:
            case 'end':
              return context$4$0.stop();
          }
        }, null, this);
      });
      after(function callee$3$0() {
        return _regeneratorRuntime.async(function callee$3$0$(context$4$0) {
          while (1) switch (context$4$0.prev = context$4$0.next) {
            case 0:
              context$4$0.next = 2;
              return _regeneratorRuntime.awrap(_appiumSupport.fs.exists(picturePath));

            case 2:
              if (!context$4$0.sent) {
                context$4$0.next = 5;
                break;
              }

              context$4$0.next = 5;
              return _regeneratorRuntime.awrap(_appiumSupport.fs.unlink(picturePath));

            case 5:
            case 'end':
              return context$4$0.stop();
          }
        }, null, this);
      });
      it('should add media files', function callee$3$0() {
        return _regeneratorRuntime.async(function callee$3$0$(context$4$0) {
          while (1) switch (context$4$0.prev = context$4$0.next) {
            case 0:
              context$4$0.next = 2;
              return _regeneratorRuntime.awrap((0, _libSimctlJs.addMedia)(udid, picturePath));

            case 2:
              context$4$0.sent.code.should.eql(0);

            case 3:
            case 'end':
              return context$4$0.stop();
          }
        }, null, this);
      });
    });

    it('should extract applications information', function callee$2$0() {
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            context$3$0.next = 2;
            return _regeneratorRuntime.awrap((0, _libSimctlJs.appInfo)(udid, 'com.apple.springboard'));

          case 2:
            context$3$0.sent.should.include('ApplicationType');

          case 3:
          case 'end':
            return context$3$0.stop();
        }
      }, null, this);
    });
  });
});

// Wait for boot to complete

// pause a moment or everything is messed up
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInRlc3Qvc2ltY3RsLWUyZS1zcGVjcy5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7O29CQUdpQixNQUFNOzs7O3NCQUNULFFBQVE7Ozs7MkJBRTBDLGtCQUFrQjs7MkJBQ2hFLGNBQWM7Ozs7d0JBQ2xCLFVBQVU7Ozs7NkJBQ0ksZ0JBQWdCOzt3QkFDZCxVQUFVOztBQUd4QyxJQUFNLE1BQU0sR0FBRyxrQkFBSyxNQUFNLEVBQUUsQ0FBQzs7QUFFN0IsUUFBUSxDQUFDLFFBQVEsRUFBRSxZQUFZOzs7QUFDN0IsTUFBTSxXQUFXLEdBQUcsVUFBVSxDQUFDO0FBQy9CLE1BQU0sYUFBYSxHQUFHLE1BQU0sQ0FBQztBQUM3QixNQUFJLENBQUMsT0FBTyxDQUFDLGFBQWEsQ0FBQyxDQUFDOztBQUU1QixNQUFJLFFBQVEsWUFBQSxDQUFDO0FBQ2IsTUFBSSxjQUFjLEdBQUcsSUFBSSxDQUFDO0FBQzFCLE1BQUksU0FBUyxHQUFHLEVBQUUsQ0FBQzs7QUFFbkIsUUFBTSxDQUFDO1FBQ0QsT0FBTyxFQVNGLENBQUMsRUFDSixPQUFPLEVBR1AsU0FBUyxrRkFDSixJQUFJOzs7Ozs7MkNBZEssOEJBQVk7OztBQUE1QixpQkFBTzs7QUFDWCxtQkFBUyxHQUFHLG9CQUFFLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQyxJQUFJLENBQUMsVUFBQyxDQUFDLEVBQUUsQ0FBQzttQkFBSyxDQUFDLEdBQUcsQ0FBQztXQUFBLENBQUMsQ0FBQzs7Y0FDN0MsU0FBUyxDQUFDLE1BQU07Ozs7O2dCQUNiLElBQUksS0FBSyxDQUFDLGVBQWUsQ0FBQzs7O0FBRWxDLGlCQUFPLENBQUMsR0FBRyx3QkFBc0IsU0FBUyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBRyxDQUFDOzs7O0FBSWhELFdBQUMsR0FBRyxDQUFDOzs7Z0JBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQTs7Ozs7QUFDZixpQkFBTyxHQUFHLFFBQVEsQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFLEdB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QUM7Q0FDSixDQUFDLENBQUMiLCJmaWxlIjoidGVzdC9zaW1jdGwtZTJlLXNwZWNzLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLyogZ2xvYmFsIGl0OnRydWUsIGRlc2NyaWJlOnRydWUqL1xuLy8gdHJhbnNwaWxlOm1vY2hhXG5cbmltcG9ydCBjaGFpIGZyb20gJ2NoYWknO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7IGNyZWF0ZURldmljZSwgZGVsZXRlRGV2aWNlLCBlcmFzZURldmljZSwgZ2V0RGV2aWNlcywgc2V0UGFzdGVib2FyZCwgZ2V0UGFzdGVib2FyZCxcbiAgICAgICAgIGJvb3REZXZpY2UsIGxhdW5jaCwgc2h1dGRvd24sIGFkZE1lZGlhLCBhcHBJbmZvIH0gZnJvbSAnLi4vbGliL3NpbWN0bC5qcyc7XG5pbXBvcnQgeGNvZGUgZnJvbSAnYXBwaXVtLXhjb2RlJztcbmltcG9ydCBCIGZyb20gJ2JsdWViaXJkJztcbmltcG9ydCB7IGZzLCB0ZW1wRGlyIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuaW1wb3J0IHsgcmV0cnlJbnRlcnZhbCB9IGZyb20gJ2FzeW5jYm94JztcblxuXG5jb25zdCBzaG91bGQgPSBjaGFpLnNob3VsZCgpO1xuXG5kZXNjcmliZSgnc2ltY3RsJywgZnVuY3Rpb24gKCkge1xuICBjb25zdCBERVZJQ0VfTkFNRSA9ICdpUGhvbmUgNic7XG4gIGNvbnN0IE1PQ0hBX1RJTUVPVVQgPSAyMDAwMDA7XG4gIHRoaXMudGltZW91dChNT0NIQV9USU1FT1VUKTtcblxuICBsZXQgcmFuZE5hbWU7XG4gIGxldCByYW5kRGV2aWNlVWRpZCA9IG51bGw7XG4gIGxldCB2YWxpZFNka3MgPSBbXTtcblxuICBiZWZvcmUoYXN5bmMgKCkgPT4ge1xuICAgIGxldCBkZXZpY2VzID0gYXdhaXQgZ2V0RGV2aWNlcygpO1xuICAgIHZhbGlkU2RrcyA9IF8ua2V5cyhkZXZpY2VzKS5zb3J0KChhLCBiKSA9PiBhIC0gYik7XG4gICAgaWYgKCF2YWxpZFNka3MubGVuZ3RoKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ05vIHZhbGlkIFNES3MnKTtcbiAgICB9XG4gICAgY29uc29sZS5sb2coYEZvdW5kIHZhbGlkIFNES3M6ICR7dmFsaWRTZGtzLmpvaW4oJywgJyl9YCk7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgbm8tY29uc29sZVxuXG4gICAgLy8gbmVlZCB0byBmaW5kIGEgcmFuZG9tIG5hbWUgdGhhdCBkb2VzIG5vdCBhbHJlYWR5IGV4aXN0XG4gICAgLy8gZ2l2ZSBpdCA1IHRyaWVzXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCA1OyBpKyspIHtcbiAgICAgIGxldCByYW5kTnVtID0gcGFyc2VJbnQoTWF0aC5yYW5kb20oKSAqIDEwMCwgMTApO1xuICAgICAgcmFuZE5hbWUgPSBgZGV2aWNlJHtyYW5kTnVtfWA7XG5cbiAgICAgIGxldCBuYW1lRm91bmQgPSBmYWxzZTtcbiAgICAgIGZvciAobGV0IGxpc3Qgb2YgXy52YWx1ZXMoZGV2aWNlcykpIHtcbiAgICAgICAgaWYgKF8uaW5jbHVkZXMoXy5tYXAobGlzdCwgJ25hbWUnKSwgcmFuZE5hbWUpKSB7XG4gICAgICAgICAgLy8gbmVlZCB0byBmaW5kIGFub3RoZXIgcmFuZG9tIG5hbWVcbiAgICAgICAgICBuYW1lRm91bmQgPSB0cnVlO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICBpZiAoIW5hbWVGb3VuZCkgYnJlYWs7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgY3VybHlcbiAgICB9XG4gIH0pO1xuXG4gIGl0KCdzaG91bGQgY3JlYXRlIGEgZGV2aWNlJywgYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgIGxldCB1ZGlkID0gYXdhaXQgY3JlYXRlRGV2aWNlKHJhbmROYW1lLCBERVZJQ0VfTkFNRSwgXy5sYXN0KHZhbGlkU2RrcykpO1xuICAgICh0eXBlb2YgdWRpZCkuc2hvdWxkLmVxdWFsKCdzdHJpbmcnKTtcbiAgICB1ZGlkLmxlbmd0aC5zaG91bGQuZXF1YWwoMzYpO1xuICB9KTtcblxuICBpdCgnc2hvdWxkIGdldCBkZXZpY2VzJywgYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgIGxldCBzZGtEZXZpY2VzID0gYXdhaXQgZ2V0RGV2aWNlcyhfLmxhc3QodmFsaWRTZGtzKSk7XG4gICAgXy5tYXAoc2RrRGV2aWNlcywgJ25hbWUnKS5zaG91bGQuaW5jbHVkZShyYW5kTmFtZSk7XG4gICAgcmFuZERldmljZVVkaWQgPSBzZGtEZXZpY2VzLmZpbHRlcigoZCkgPT4gZC5uYW1lID09PSByYW5kTmFtZSlbMF0udWRpZDtcbiAgfSk7XG5cbiAgaXQoJ3Nob3VsZCBlcmFzZSBkZXZpY2VzJywgYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgIGF3YWl0IGVyYXNlRGV2aWNlKHJhbmREZXZpY2VVZGlkLCAxNjAwMCk7XG4gIH0pO1xuXG4gIGl0KCdzaG91bGQgZGVsZXRlIGRldmljZXMnLCBhc3luYyBmdW5jdGlvbiAoKSB7XG4gICAgYXdhaXQgZGVsZXRlRGV2aWNlKHJhbmREZXZpY2VVZGlkKTtcbiAgICBsZXQgc2RrRGV2aWNlcyA9IGF3YWl0IGdldERldmljZXMoXy5sYXN0KHZhbGlkU2RrcykpO1xuICAgIF8ubWFwKHNka0RldmljZXMsICduYW1lJykuc2hvdWxkLm5vdC5pbmNsdWRlKHJhbmROYW1lKTtcbiAgfSk7XG5cbiAgaXQoJ3Nob3VsZCByZXR1cm4gYSBuaWNlIGVycm9yIGZvciBpbnZhbGlkIHVzYWdlJywgYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgIGxldCBlcnIgPSBudWxsO1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCBjcmVhdGVEZXZpY2UoJ2ZvbycsICdiYXInLCAnYmF6Jyk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgZXJyID0gZTtcbiAgICB9XG4gICAgc2hvdWxkLmV4aXN0KGVycik7XG4gICAgZXJyLm1lc3NhZ2Uuc2hvdWxkLmluY2x1ZGUoJ0ludmFsaWQgZGV2aWNlIHR5cGU6IGJhcicpO1xuICB9KTtcblxuICBpdCgnc2hvdWxkIGNyZWF0ZSBhIGRldmljZSBhbmQgYmUgYWJsZSB0byBzZWUgaXQgaW4gZGV2aWNlcyBsaXN0IHJpZ2h0IGF3YXknLCBhc3luYyBmdW5jdGlvbiAoKSB7XG4gICAgbGV0IHNkayA9IF8ubGFzdCh2YWxpZFNka3MpO1xuICAgIGxldCBudW1TaW1zQmVmb3JlID0gKGF3YWl0IGdldERldmljZXMoKSlbc2RrXS5sZW5ndGg7XG4gICAgbGV0IHVkaWQgPSBhd2FpdCBjcmVhdGVEZXZpY2UoJ25vZGUtc2ltY3RsIHRlc3QnLCBERVZJQ0VfTkFNRSwgc2RrKTtcbiAgICBsZXQgbnVtU2ltc0FmdGVyID0gKGF3YWl0IGdldERldmljZXMoKSlbc2RrXS5sZW5ndGg7XG4gICAgbnVtU2ltc0FmdGVyLnNob3VsZC5lcXVhbChudW1TaW1zQmVmb3JlICsgMSk7XG4gICAgZGVsZXRlRGV2aWNlKHVkaWQpO1xuICB9KTtcblxuICBpdCgnc2hvdWxkIGNyZWF0ZSBhIGRldmljZSB3aXRoIGNvbXBhdGlibGUgcHJvcGVydGllcycsIGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICBsZXQgc2RrID0gXy5sYXN0KHZhbGlkU2Rrcyk7XG4gICAgbGV0IGRldmljZXMgPSAoYXdhaXQgZ2V0RGV2aWNlcygpKVtzZGtdO1xuICAgIGxldCBmaXJzdERldmljZSA9IGRldmljZXNbMF07XG4gICAgbGV0IGV4cGVjdGVkTGlzdCA9IFsnbmFtZScsICdzZGsnLCAnc3RhdGUnLCAndWRpZCddO1xuICAgIE9iamVjdC5rZXlzKGZpcnN0RGV2aWNlKS5zb3J0KCkuc2hvdWxkLmVxbChleHBlY3RlZExpc3QpO1xuICB9KTtcblxuICBkZXNjcmliZSgnb24gcnVubmluZyBTaW11bGF0b3InLCBmdW5jdGlvbiAoKSB7XG4gICAgaWYgKHByb2Nlc3MuZW52LlRSQVZJUykge1xuICAgICAgdGhpcy5yZXRyaWVzKDMpO1xuICAgIH1cblxuICAgIGxldCB1ZGlkO1xuICAgIGxldCBtYWpvciwgbWlub3I7XG5cbiAgICBiZWZvcmUoYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgICAgKHttYWpvciwgbWlub3J9ID0gYXdhaXQgeGNvZGUuZ2V0VmVyc2lvbih0cnVlKSk7XG4gICAgICBpZiAobWFqb3IgPCA4IHx8IChtYWpvciA9PT0gOCAmJiBtaW5vciA8IDEpKSB7XG4gICAgICAgIHJldHVybiB0aGlzLnNraXAoKTtcbiAgICAgIH1cblxuICAgICAgY29uc3Qgc2RrID0gXy5sYXN0KHZhbGlkU2Rrcyk7XG4gICAgICB1ZGlkID0gYXdhaXQgY3JlYXRlRGV2aWNlKCdydW5uaW5nU2ltVGVzdCcsIERFVklDRV9OQU1FLCBzZGspO1xuXG4gICAgICBhd2FpdCBib290RGV2aWNlKHVkaWQpO1xuICAgICAgLy8gV2FpdCBmb3IgYm9vdCB0byBjb21wbGV0ZVxuICAgICAgYXdhaXQgbGF1bmNoKHVkaWQsICdjb20uYXBwbGUuc3ByaW5nYm9hcmQnLCBNT0NIQV9USU1FT1VUKTtcblxuICAgICAgLy8gcGF1c2UgYSBtb21lbnQgb3IgZXZlcnl0aGluZyBpcyBtZXNzZWQgdXBcbiAgICAgIGF3YWl0IEIuZGVsYXkoNTAwMCk7XG4gICAgfSk7XG4gICAgYWZ0ZXIoYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgICAgaWYgKHVkaWQpIHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICBhd2FpdCBzaHV0ZG93bih1ZGlkKTtcbiAgICAgICAgfSBjYXRjaCAoaWduKSB7fVxuICAgICAgICBhd2FpdCBkZWxldGVEZXZpY2UodWRpZCk7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICBkZXNjcmliZSgncGFzdGVib2FyZCcsIGZ1bmN0aW9uICgpIHtcbiAgICAgIGxldCBwYlJldHJpZXMgPSAwO1xuICAgICAgYmVmb3JlKGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgaWYgKG1ham9yIDwgOCB8fCAobWFqb3IgPT09IDggJiYgbWlub3IgPCAxKSkge1xuICAgICAgICAgIHJldHVybiB0aGlzLnNraXAoKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAobWFqb3IgPT09IDkpIHtcbiAgICAgICAgICBpZiAocHJvY2Vzcy5lbnYuVFJBVklTKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5za2lwKCk7XG4gICAgICAgICAgfVxuICAgICAgICAgIC8vIFRPRE86IHJlY2hlY2sgd2hlbiBmdWxsIFhjb2RlIDkgY29tZXMgb3V0IHRvIHNlZSBpZiBwYXN0ZWJvYXJkIHdvcmtzIGJldHRlclxuICAgICAgICAgIHBiUmV0cmllcyA9IDIwMDtcbiAgICAgICAgICB0aGlzLnRpbWVvdXQoMjAwICogMTAwMCAqIDIpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICAgIGl0KCdzaG91bGQgc2V0IGFuZCBnZXQgdGhlIGNvbnRlbnQgb2YgdGhlIHBhc3RlYm9hcmQnLCBhc3luYyBmdW5jdGlvbiAoKSB7XG4gICAgICAgIGNvbnN0IHBiQ29udGVudCA9ICdibGFibGFibGEnO1xuICAgICAgICBjb25zdCBlbmNvZGluZyA9ICdhc2NpaSc7XG5cbiAgICAgICAgYXdhaXQgc2V0UGFzdGVib2FyZCh1ZGlkLCBwYkNvbnRlbnQsIGVuY29kaW5nKTtcbiAgICAgICAgYXdhaXQgcmV0cnlJbnRlcnZhbChwYlJldHJpZXMsIDEwMDAsIGFzeW5jICgpID0+IHtcbiAgICAgICAgICAoYXdhaXQgZ2V0UGFzdGVib2FyZCh1ZGlkLCBlbmNvZGluZykpLnNob3VsZC5lcWwocGJDb250ZW50KTtcbiAgICAgICAgfSk7XG4gICAgICB9KTtcbiAgICB9KTtcblxuICAgIGRlc2NyaWJlKCdhZGQgbWVkaWEnLCBmdW5jdGlvbiAoKSB7XG4gICAgICBjb25zdCBCQVNFNjRfUE5HID0gJ2lWQk9SdzBLR2dvQUFBQU5TVWhFVWdBQUFBRUFBQUFCQ0FZQUFBQWZGY1NKQUFBQURVbEVRVlI0Mm1OaytNOVFEd0FEaGdHQVdqUjlhd0FBQUFCSlJVNUVya0pnZ2c9PSc7XG4gICAgICBsZXQgcGljdHVyZVBhdGg7XG4gICAgICBiZWZvcmUoYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgICAgICBpZiAobWFqb3IgPCA4IHx8IChtYWpvciA9PT0gOCAmJiBtaW5vciA8IDEpKSB7XG4gICAgICAgICAgcmV0dXJuIHRoaXMuc2tpcCgpO1xuICAgICAgICB9XG4gICAgICAgIHBpY3R1cmVQYXRoID0gYXdhaXQgdGVtcERpci5wYXRoKHtwcmVmaXg6ICdwaXhlbCcsIHN1ZmZpeDogJy5wbmcnfSk7XG4gICAgICAgIGF3YWl0IGZzLndyaXRlRmlsZShwaWN0dXJlUGF0aCwgbmV3IEJ1ZmZlcihCQVNFNjRfUE5HLCAnYmFzZTY0JykudG9TdHJpbmcoJ2JpbmFyeScpLCAnYmluYXJ5Jyk7XG4gICAgICB9KTtcbiAgICAgIGFmdGVyKGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgaWYgKGF3YWl0IGZzLmV4aXN0cyhwaWN0dXJlUGF0aCkpIHtcbiAgICAgICAgICBhd2FpdCBmcy51bmxpbmsocGljdHVyZVBhdGgpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICAgIGl0KCdzaG91bGQgYWRkIG1lZGlhIGZpbGVzJywgYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgICAgICAoYXdhaXQgYWRkTWVkaWEodWRpZCwgcGljdHVyZVBhdGgpKS5jb2RlLnNob3VsZC5lcWwoMCk7XG4gICAgICB9KTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgZXh0cmFjdCBhcHBsaWNhdGlvbnMgaW5mb3JtYXRpb24nLCBhc3luYyBmdW5jdGlvbiAoKSB7XG4gICAgICAoYXdhaXQgYXBwSW5mbyh1ZGlkLCAnY29tLmFwcGxlLnNwcmluZ2JvYXJkJykpLnNob3VsZC5pbmNsdWRlKCdBcHBsaWNhdGlvblR5cGUnKTtcbiAgICB9KTtcbiAgfSk7XG59KTtcbiJdLCJzb3VyY2VSb290IjoiLi4vLi4ifQ==
