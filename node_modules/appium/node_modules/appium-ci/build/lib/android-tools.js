'use strict';

var _createClass = require('babel-runtime/helpers/create-class')['default'];

var _classCallCheck = require('babel-runtime/helpers/class-call-check')['default'];

var _slicedToArray = require('babel-runtime/helpers/sliced-to-array')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _getIterator = require('babel-runtime/core-js/get-iterator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _this = this;

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

var _stream = require('stream');

var _stream2 = _interopRequireDefault(_stream);

var _fs = require('fs');

var _fs2 = _interopRequireDefault(_fs);

var _split = require('split');

var _split2 = _interopRequireDefault(_split);

var _os = require('os');

var _os2 = _interopRequireDefault(_os);

var _utils = require('./utils');

var _utils2 = _interopRequireDefault(_utils);

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _appiumSupport = require('appium-support');

var log = {
  emu: _appiumSupport.logger.getLogger('android-emu')
};

var DEFAULT_OPTS = {
  initWait: 15000,
  maxWait: 300000,
  pool: 5000
};

var androidTools = {
  killAll: function killAll(processes) {
    var _iteratorNormalCompletion, _didIteratorError, _iteratorError, _iterator, _step, p, cmd;

    return _regeneratorRuntime.async(function killAll$(context$1$0) {
      while (1) switch (context$1$0.prev = context$1$0.next) {
        case 0:
          processes = processes || ['emulator'];
          processes = _lodash2['default'].flatten([processes]);
          _iteratorNormalCompletion = true;
          _didIteratorError = false;
          _iteratorError = undefined;
          context$1$0.prev = 5;
          _iterator = _getIterator(processes);

        case 7:
          if (_iteratorNormalCompletion = (_step = _iterator.next()).done) {
            context$1$0.next = 16;
            break;
          }

          p = _step.value;
          cmd = process.platform.match(/^win/) ? 'powershell -Command "Stop-Process -Name *' + p + '*"' : 'sudo pkill -f ' + p;

          console.log('killing process with command:' + cmd);
          context$1$0.next = 13;
          return _regeneratorRuntime.awrap(_utils2['default'].exec(cmd)['catch'](function () {}));

        case 13:
          _iteratorNormalCompletion = true;
          context$1$0.next = 7;
          break;

        case 16:
          context$1$0.next = 22;
          break;

        case 18:
          context$1$0.prev = 18;
          context$1$0.t0 = context$1$0['catch'](5);
          _didIteratorError = true;
          _iteratorError = context$1$0.t0;

        case 22:
          context$1$0.prev = 22;
          context$1$0.prev = 23;

          if (!_iteratorNormalCompletion && _iterator['return']) {
            _iterator['return']();
          }

        case 25:
          context$1$0.prev = 25;

          if (!_didIteratorError) {
            context$1$0.next = 28;
            break;
          }

          throw _iteratorError;

        case 28:
          return context$1$0.finish(25);

        case 29:
          return context$1$0.finish(22);

        case 30:
        case 'end':
          return context$1$0.stop();
      }
    }, null, _this, [[5, 18, 22, 30], [23,, 25, 29]]);
  }
};

exports.androidTools = androidTools;

var Emulator = (function () {
  function Emulator(avd) {
    var opts = arguments.length <= 1 || arguments[1] === undefined ? {} : arguments[1];

    _classCallCheck(this, Emulator);

    this.opts = _lodash2['default'].clone(opts);
    _lodash2['default'].defaults(this.opts, DEFAULT_OPTS);
    this.avd = avd;
  }

  _createClass(Emulator, [{
    key: 'start',
    value: function start() {
      var out = new _stream2['default'].PassThrough();
      out.pipe((0, _split2['default'])()).on('data', function (line) {
        log.emu.info(line);
      });
      out.pipe(_fs2['default'].createWriteStream('emulator.log'));
      var emuBin = _os2['default'].platform() === 'linux' ? 'emulator64-x86' : 'emulator';
      var emuArgs = ['-avd', this.avd, '-no-snapshot-load', '-no-snapshot-save', '-no-audio', '-netfast'];
      if (_os2['default'].platform() === 'linux') {
        emuArgs = emuArgs.concat(['-qemu', '-m', '512', '-enable-kvm']);
      }
      log.emu.info('executing', emuBin, emuArgs.join(' '));
      this.child = _utils2['default'].spawn(emuBin, emuArgs);
      this.child.stdout.pipe(out);
      this.child.stderr.pipe(out);
    }
  }, {
    key: 'waitTillReady',
    value: function waitTillReady() {
      var startMs, timeoutPromise, emuStarted, emuErrored, procPromise, _waitForEmu;

      return _regeneratorRuntime.async(function waitTillReady$(context$2$0) {
        var _this2 = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            startMs = Date.now();
            timeoutPromise = undefined, emuStarted = undefined, emuErrored = undefined;
            procPromise = new _bluebird2['default'].Promise(function (resolve, reject) {
              _this2.child.on('error', function (err) {
                emuErrored = true;
                reject('Emulator didn\'t start properly, error:', err);
              });
              _this2.child.on('close', function () {
                if (!emuStarted) {
                  emuErrored = true;
                  reject('Emulator closed too early, see emu logs for errors.');
                }
              });
            }).cancellable()['catch'](_bluebird2['default'].Promise.CancellationError, function () {});

            _waitForEmu = function _waitForEmu(waitMs) {
              var stdout, _ref, _ref2;

              return _regeneratorRuntime.async(function _waitForEmu$(context$3$0) {
                while (1) switch (context$3$0.prev = context$3$0.next) {
                  case 0:
                    waitMs = waitMs || this.opts.pool;

                    // wait

                    if (!(waitMs > 0)) {
                      context$3$0.next = 6;
                      break;
                    }

                    log.emu.info('Waiting ' + waitMs + ' ms for emu...');
                    timeoutPromise = new _bluebird2['default'].Promise(function () {}).timeout(waitMs); // cancellable
                    context$3$0.next = 6;
                    return _regeneratorRuntime.awrap(timeoutPromise.then(_waitForEmu)['catch'](_bluebird2['default'].Promise.TimeoutError, function () {})['catch'](_bluebird2['default'].Promise.CancellationError, function () {}));

                  case 6:
                    if (!emuErrored) {
                      context$3$0.next = 8;
                      break;
                    }

                    throw new Error('emulator errored');

                  case 8:
                    if (!(Date.now() - startMs > this.opts.maxWait)) {
                      context$3$0.next = 10;
                      break;
                    }

                    throw new Error('Emulator did not show up');

                  case 10:
                    stdout = undefined;
                    context$3$0.prev = 11;
                    context$3$0.next = 14;
                    return _regeneratorRuntime.awrap(_utils2['default'].exec('adb shell getprop sys.boot_completed'));

                  case 14:
                    _ref = context$3$0.sent;
                    _ref2 = _slicedToArray(_ref, 1);
                    stdout = _ref2[0];
                    context$3$0.next = 31;
                    break;

                  case 19:
                    context$3$0.prev = 19;
                    context$3$0.t0 = context$3$0['catch'](11);

                    if (!context$3$0.t0.toString().match(/device not found/)) {
                      context$3$0.next = 26;
                      break;
                    }

                    // there might be something wrong with the adb server
                    log.emu.warn('Device not found, it should be there, killing adb server.');
                    return context$3$0.abrupt('return', _utils2['default'].exec('adb kill-server').then(function () {
                      return _waitForEmu();
                    }));

                  case 26:
                    if (!context$3$0.t0.toString().match(/device offline/)) {
                      context$3$0.next = 30;
                      break;
                    }

                    return context$3$0.abrupt('return', _waitForEmu());

                  case 30:
                    throw context$3$0.t0;

                  case 31:
                    if (!(stdout && stdout.trim() === '1')) {
                      context$3$0.next = 36;
                      break;
                    }

                    log.emu.info('emulator started');
                    emuStarted = true;
                    context$3$0.next = 38;
                    break;

                  case 36:
                    context$3$0.next = 38;
                    return _regeneratorRuntime.awrap(_waitForEmu());

                  case 38:
                  case 'end':
                    return context$3$0.stop();
                }
              }, null, _this2, [[11, 19]]);
            };

            context$2$0.next = 6;
            return _regeneratorRuntime.awrap(_bluebird2['default'].race([_waitForEmu(this.opts.initWait), procPromise])['finally'](function () {
              // cancel outstanding promises so that they do not hang the node process
              timeoutPromise.cancel();
              procPromise.cancel();
            }));

          case 6:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'stop',
    value: function stop() {
      if (this.child) {
        this.child.kill();
      }
    }
  }]);

  return Emulator;
})();

exports.Emulator = Emulator;

// one cancellable promise monitor the proc events for abnormal termination

// recursion end conditions

// retrieve emulator status

// that's ok,just wait

// check emulator status

// wait for first promise
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9hbmRyb2lkLXRvb2xzLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O3dCQUFjLFVBQVU7Ozs7c0JBQ0wsUUFBUTs7OztrQkFDWixJQUFJOzs7O3FCQUNELE9BQU87Ozs7a0JBQ1YsSUFBSTs7OztxQkFDRCxTQUFTOzs7O3NCQUNiLFFBQVE7Ozs7NkJBQ0MsZ0JBQWdCOztBQUV2QyxJQUFJLEdBQUcsR0FBRztBQUNSLEtBQUcsRUFBRSxzQkFBTyxTQUFTLENBQUMsYUFBYSxDQUFDO0NBQ3JDLENBQUM7O0FBRUYsSUFBTSxZQUFZLEdBQUc7QUFDbkIsVUFBUSxFQUFFLEtBQUs7QUFDZixTQUFPLEVBQUUsTUFBTTtBQUNmLE1BQUksRUFBRSxJQUFJO0NBQ1gsQ0FBQzs7QUFFRixJQUFLLFlBQVksR0FBRztBQUNsQixTQUFPLEVBQUUsaUJBQU8sU0FBUzt3RkFHZixDQUFDLEVBQ0gsR0FBRzs7Ozs7QUFIVCxtQkFBUyxHQUFHLFNBQVMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDO0FBQ3RDLG1CQUFTLEdBQUcsb0JBQUUsT0FBTyxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQzs7Ozs7bUNBQ3RCLFNBQVM7Ozs7Ozs7O0FBQWQsV0FBQztBQUNILGFBQUcsR0FBRyxPQUFPLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsR0FBRywyQ0FBMkMsR0FBRyxDQUFDLEdBQUcsSUFBSSxHQUMvRixnQkFBZ0IsR0FBRyxDQUFDOztBQUN0QixpQkFBTyxDQUFDLEdBQUcsQ0FBQywrQkFBK0IsR0FBRyxHQUFHLENBQUMsQ0FBQzs7MkNBQzdDLG1CQUFNLElBQUksQ0FBQyxHQUFHLENBQUMsU0FBTSxDQUFDLFlBQU0sRUFBRSxDQUFDOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0dBRXhDO0NBQ0YsQ0FBQzs7UUFFTyxZQUFZLEdBQVosWUFBWTs7SUFFUixRQUFRO0FBQ1Is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O0FBQ2pDLHVCQUFHLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO0FBQ2pDLDhCQUFVLEdBQUcsSUFBSSxDQUFDOzs7Ozs7cURBRVosV0FBVyxFQUFFOzs7Ozs7O2FBRXZCOzs7NkNBR0ssc0JBQUUsSUFBSSxDQUFDLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLEVBQUUsV0FBVyxDQUFDLENBQUMsV0FDbEQsQ0FBQyxZQUFNOztBQUViLDRCQUFjLENBQUMsTUFBTSxFQUFFLENBQUM7QUFDeEIseUJBQVcsQ0FBQyxNQUFNLEVBQUUsQ0FBQzthQUN4QixDQUFDOzs7Ozs7O0tBRUg7OztXQUVHLGdCQUFHO0FBQ0wsVUFBSSxJQUFJLENBQUMsS0FBSyxFQUFFO0FBQ2QsWUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsQ0FBQztPQUNuQjtLQUNGOzs7U0E5R1UsUUFBUSIsImZpbGUiOiJsaWIvYW5kcm9pZC10b29scy5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBCIGZyb20gJ2JsdWViaXJkJztcbmltcG9ydCBzdHJlYW0gZnJvbSAnc3RyZWFtJztcbmltcG9ydCBmcyBmcm9tICdmcyc7XG5pbXBvcnQgc3BsaXQgZnJvbSAnc3BsaXQnO1xuaW1wb3J0IG9zIGZyb20gJ29zJztcbmltcG9ydCB1dGlscyBmcm9tICcuL3V0aWxzJztcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgeyBsb2dnZXIgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5cbmxldCBsb2cgPSB7XG4gIGVtdTogbG9nZ2VyLmdldExvZ2dlcignYW5kcm9pZC1lbXUnKVxufTtcblxuY29uc3QgREVGQVVMVF9PUFRTID0ge1xuICBpbml0V2FpdDogMTUwMDAsXG4gIG1heFdhaXQ6IDMwMDAwMCxcbiAgcG9vbDogNTAwMCxcbn07XG5cbmxldCAgYW5kcm9pZFRvb2xzID0ge1xuICBraWxsQWxsOiBhc3luYyAocHJvY2Vzc2VzKSA9PiB7XG4gICAgcHJvY2Vzc2VzID0gcHJvY2Vzc2VzIHx8IFsnZW11bGF0b3InXTtcbiAgICBwcm9jZXNzZXMgPSBfLmZsYXR0ZW4oW3Byb2Nlc3Nlc10pO1xuICAgIGZvcihsZXQgcCBvZiBwcm9jZXNzZXMpIHtcbiAgICAgIGxldCBjbWQgPSBwcm9jZXNzLnBsYXRmb3JtLm1hdGNoKC9ed2luLykgPyAncG93ZXJzaGVsbCAtQ29tbWFuZCBcIlN0b3AtUHJvY2VzcyAtTmFtZSAqJyArIHAgKyAnKlwiJyA6XG4gICAgICAgICdzdWRvIHBraWxsIC1mICcgKyBwO1xuICAgICAgY29uc29sZS5sb2coJ2tpbGxpbmcgcHJvY2VzcyB3aXRoIGNvbW1hbmQ6JyArIGNtZCk7XG4gICAgICBhd2FpdCB1dGlscy5leGVjKGNtZCkuY2F0Y2goKCkgPT4ge30pO1xuICAgIH1cbiAgfVxufTtcblxuZXhwb3J0IHsgYW5kcm9pZFRvb2xzIH07XG5cbmV4cG9ydCBjbGFzcyBFbXVsYXRvciB7XG4gIGNvbnN0cnVjdG9yKGF2ZCwgb3B0cz17fSkge1xuICAgIHRoaXMub3B0cyA9IF8uY2xvbmUob3B0cyk7XG4gICAgXy5kZWZhdWx0cyh0aGlzLm9wdHMsIERFRkFVTFRfT1BUUyk7XG4gICAgdGhpcy5hdmQgPSBhdmQ7XG4gIH1cblxuICBzdGFydCAoKSB7XG4gICAgbGV0IG91dCA9IG5ldyBzdHJlYW0uUGFzc1Rocm91Z2goKTtcbiAgICBvdXQucGlwZShzcGxpdCgpKVxuICAgICAgLm9uKCdkYXRhJywgKGxpbmUpID0+IHtcbiAgICAgICAgbG9nLmVtdS5pbmZvKGxpbmUpO1xuICAgICAgfSk7XG4gICAgb3V0LnBpcGUoZnMuY3JlYXRlV3JpdGVTdHJlYW0oJ2VtdWxhdG9yLmxvZycpKTtcbiAgICBsZXQgZW11QmluID0gb3MucGxhdGZvcm0oKSA9PT0gJ2xpbnV4JyA/ICdlbXVsYXRvcjY0LXg4NicgOiAnZW11bGF0b3InO1xuICAgIGxldCBlbXVBcmdzID0gW1xuICAgICAgJy1hdmQnLCB0aGlzLmF2ZCxcbiAgICAgICctbm8tc25hcHNob3QtbG9hZCcsICctbm8tc25hcHNob3Qtc2F2ZScsXG4gICAgICAnLW5vLWF1ZGlvJywgJy1uZXRmYXN0J1xuICAgIF07XG4gICAgaWYgKG9zLnBsYXRmb3JtKCkgPT09ICdsaW51eCcpIHtcbiAgICAgIGVtdUFyZ3MgPSBlbXVBcmdzLmNvbmNhdChbXG4gICAgICAgICctcWVtdScsICctbScsICc1MTInLCAnLWVuYWJsZS1rdm0nXG4gICAgICBdKTtcbiAgICB9XG4gICAgbG9nLmVtdS5pbmZvKCdleGVjdXRpbmcnLCBlbXVCaW4sIGVtdUFyZ3Muam9pbignICcpKTtcbiAgICB0aGlzLmNoaWxkID0gdXRpbHMuc3Bhd24oZW11QmluLCBlbXVBcmdzKTtcbiAgICB0aGlzLmNoaWxkLnN0ZG91dC5waXBlKG91dCk7XG4gICAgdGhpcy5jaGlsZC5zdGRlcnIucGlwZShvdXQpO1xuICB9XG5cbiAgYXN5bmMgd2FpdFRpbGxSZWFkeSgpIHtcbiAgICBsZXQgc3RhcnRNcyA9IERhdGUubm93KCk7XG4gICAgbGV0IHRpbWVvdXRQcm9taXNlLCBlbXVTdGFydGVkLCBlbXVFcnJvcmVkO1xuXG4gICAgLy8gb25lIGNhbmNlbGxhYmxlIHByb21pc2UgbW9uaXRvciB0aGUgcHJvYyBldmVudHMgZm9yIGFibm9ybWFsIHRlcm1pbmF0aW9uXG4gICAgbGV0IHByb2NQcm9taXNlID0gbmV3IEIuUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICB0aGlzLmNoaWxkLm9uKCdlcnJvcicsIChlcnIpID0+IHtcbiAgICAgICAgZW11RXJyb3JlZCA9IHRydWU7XG4gICAgICAgIHJlamVjdCgnRW11bGF0b3IgZGlkblxcJ3Qgc3RhcnQgcHJvcGVybHksIGVycm9yOicsIGVycik7XG4gICAgICB9KTtcbiAgICAgIHRoaXMuY2hpbGQub24oJ2Nsb3NlJywgKCkgPT4ge1xuICAgICAgICBpZiAoIWVtdVN0YXJ0ZWQpIHtcbiAgICAgICAgICAgIGVtdUVycm9yZWQgPSB0cnVlO1xuICAgICAgICAgICAgcmVqZWN0KCdFbXVsYXRvciBjbG9zZWQgdG9vIGVhcmx5LCBzZWUgZW11IGxvZ3MgZm9yIGVycm9ycy4nKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfSkuY2FuY2VsbGFibGUoKS5jYXRjaChCLlByb21pc2UuQ2FuY2VsbGF0aW9uRXJyb3IsICgpID0+IHt9KTtcblxuICAgIGxldCBfd2FpdEZvckVtdSA9IGFzeW5jICh3YWl0TXMpID0+IHtcbiAgICAgIHdhaXRNcyA9IHdhaXRNcyB8fCB0aGlzLm9wdHMucG9vbDtcblxuICAgICAgLy8gd2FpdFxuICAgICAgaWYgKHdhaXRNcyA+IDApIHtcbiAgICAgICAgbG9nLmVtdS5pbmZvKCdXYWl0aW5nICcgKyB3YWl0TXMgKyAgJyBtcyBmb3IgZW11Li4uJyk7XG4gICAgICAgIHRpbWVvdXRQcm9taXNlID0gbmV3IEIuUHJvbWlzZSgoKSA9PiB7fSkudGltZW91dCh3YWl0TXMpOyAvLyBjYW5jZWxsYWJsZVxuICAgICAgICBhd2FpdCB0aW1lb3V0UHJvbWlzZS50aGVuKF93YWl0Rm9yRW11KVxuICAgICAgICAgICAgLmNhdGNoKEIuUHJvbWlzZS5UaW1lb3V0RXJyb3IsICgpID0+IHt9KVxuICAgICAgICAgICAgLmNhdGNoKEIuUHJvbWlzZS5DYW5jZWxsYXRpb25FcnJvciwgKCkgPT4ge30pO1xuICAgICAgfVxuXG4gICAgICAvLyByZWN1cnNpb24gZW5kIGNvbmRpdGlvbnNcbiAgICAgIGlmIChlbXVFcnJvcmVkKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignZW11bGF0b3IgZXJyb3JlZCcpO1xuICAgICAgfVxuICAgICAgaWYgKERhdGUubm93KCkgLSBzdGFydE1zID4gdGhpcy5vcHRzLm1heFdhaXQpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdFbXVsYXRvciBkaWQgbm90IHNob3cgdXAnKTtcbiAgICAgIH1cblxuICAgICAgLy8gcmV0cmlldmUgZW11bGF0b3Igc3RhdHVzXG4gICAgICBsZXQgc3Rkb3V0O1xuICAgICAgdHJ5IHtcbiAgICAgICAgW3N0ZG91dF0gPSBhd2FpdCB1dGlscy5leGVjKCdhZGIgc2hlbGwgZ2V0cHJvcCBzeXMuYm9vdF9jb21wbGV0ZWQnKTtcbiAgICAgICB9IGNhdGNoKGVycikge1xuICAgICAgICAgIGlmIChlcnIudG9TdHJpbmcoKS5tYXRjaCgvZGV2aWNlIG5vdCBmb3VuZC8pKSB7XG4gICAgICAgICAgICAvLyB0aGVyZSBtaWdodCBiZSBzb21ldGhpbmcgd3Jvbmcgd2l0aCB0aGUgYWRiIHNlcnZlclxuICAgICAgICAgICAgbG9nLmVtdS53YXJuKCdEZXZpY2Ugbm90IGZvdW5kLCBpdCBzaG91bGQgYmUgdGhlcmUsIGtpbGxpbmcgYWRiIHNlcnZlci4nKTtcbiAgICAgICAgICAgIHJldHVybiB1dGlscy5leGVjKCdhZGIga2lsbC1zZXJ2ZXInKVxuICAgICAgICAgICAgICAudGhlbigoKSA9PiB7IHJldHVybiBfd2FpdEZvckVtdSgpOyB9KTtcbiAgICAgICAgICB9ZWxzZSBpZiAoZXJyLnRvU3RyaW5nKCkubWF0Y2goL2RldmljZSBvZmZsaW5lLykpIHtcbiAgICAgICAgICAgIC8vIHRoYXQncyBvayxqdXN0IHdhaXRcbiAgICAgICAgICAgIHJldHVybiBfd2FpdEZvckVtdSgpO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aHJvdyhlcnIpO1xuICAgICAgICAgIH1cbiAgICAgICB9XG5cbiAgICAgICAvLyBjaGVjayBlbXVsYXRvciBzdGF0dXNcbiAgICAgICBpZiAoc3Rkb3V0ICYmIHN0ZG91dC50cmltKCkgPT09ICcxJykge1xuICAgICAgICAgbG9nLmVtdS5pbmZvKCdlbXVsYXRvciBzdGFydGVkJyk7XG4gICAgICAgICBlbXVTdGFydGVkID0gdHJ1ZTtcbiAgICAgICB9IGVsc2Uge1xuICAgICAgICAgYXdhaXQgX3dhaXRGb3JFbXUoKTtcbiAgICAgICB9XG4gICAgfTtcblxuICAgIC8vIHdhaXQgZm9yIGZpcnN0IHByb21pc2VcbiAgICBhd2FpdCBCLnJhY2UoW193YWl0Rm9yRW11KHRoaXMub3B0cy5pbml0V2FpdCksIHByb2NQcm9taXNlXSlcbiAgICAgIC5maW5hbGx5KCgpID0+IHtcbiAgICAgICAgLy8gY2FuY2VsIG91dHN0YW5kaW5nIHByb21pc2VzIHNvIHRoYXQgdGhleSBkbyBub3QgaGFuZyB0aGUgbm9kZSBwcm9jZXNzXG4gICAgICAgIHRpbWVvdXRQcm9taXNlLmNhbmNlbCgpO1xuICAgICAgICBwcm9jUHJvbWlzZS5jYW5jZWwoKTtcbiAgICB9KTtcblxuICB9XG5cbiAgc3RvcCgpIHtcbiAgICBpZiAodGhpcy5jaGlsZCkge1xuICAgICAgdGhpcy5jaGlsZC5raWxsKCk7XG4gICAgfVxuICB9XG59XG4iXSwic291cmNlUm9vdCI6Ii4uLy4uIn0=
