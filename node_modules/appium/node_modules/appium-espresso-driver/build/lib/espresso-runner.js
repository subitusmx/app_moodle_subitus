'use strict';

var _createClass = require('babel-runtime/helpers/create-class')['default'];

var _classCallCheck = require('babel-runtime/helpers/class-call-check')['default'];

var _getIterator = require('babel-runtime/core-js/get-iterator')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _appiumBaseDriver = require('appium-base-driver');

var _asyncbox = require('asyncbox');

var _logger = require('./logger');

var _logger2 = _interopRequireDefault(_logger);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _appiumSupport = require('appium-support');

var _packageJson = require('../../package.json');

// eslint-disable-line import/no-unresolved

var TEST_APK_PATH = _path2['default'].resolve(__dirname, '..', '..', 'espresso-server', 'app', 'build', 'outputs', 'apk', 'androidTest', 'debug', 'app-debug-androidTest.apk');
var TEST_MANIFEST_PATH = _path2['default'].resolve(__dirname, '..', '..', 'espresso-server', 'AndroidManifest-test.xml');
var TEST_APK_PKG = "io.appium.espressoserver.test";
var REQUIRED_PARAMS = ['adb', 'tmpDir', 'host', 'systemPort', 'devicePort', 'appPackage', 'forceEspressoRebuild'];

var EspressoRunner = (function () {
  function EspressoRunner() {
    var opts = arguments.length <= 0 || arguments[0] === undefined ? {} : arguments[0];

    _classCallCheck(this, EspressoRunner);

    var _iteratorNormalCompletion = true;
    var _didIteratorError = false;
    var _iteratorError = undefined;

    try {
      for (var _iterator = _getIterator(REQUIRED_PARAMS), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
        var req = _step.value;

        if (!opts || !_appiumSupport.util.hasValue(opts[req])) {
          throw new Error('Option \'' + req + '\' is required!');
        }
        this[req] = opts[req];
      }
    } catch (err) {
      _didIteratorError = true;
      _iteratorError = err;
    } finally {
      try {
        if (!_iteratorNormalCompletion && _iterator['return']) {
          _iterator['return']();
        }
      } finally {
        if (_didIteratorError) {
          throw _iteratorError;
        }
      }
    }

    this.jwproxy = new _appiumBaseDriver.JWProxy({ host: this.host, port: this.systemPort, base: '' });
    this.proxyReqRes = this.jwproxy.proxyReqRes.bind(this.jwproxy);

    this.modServerPath = _path2['default'].resolve(this.tmpDir, TEST_APK_PKG + '_' + _packageJson.version + '_' + this.appPackage + '.apk');
  }

  _createClass(EspressoRunner, [{
    key: 'installTestApk',
    value: function installTestApk() {
      return _regeneratorRuntime.async(function installTestApk$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.t0 = this.forceEspressoRebuild;

            if (!context$2$0.t0) {
              context$2$0.next = 5;
              break;
            }

            context$2$0.next = 4;
            return _regeneratorRuntime.awrap(_appiumSupport.fs.exists(this.modServerPath));

          case 4:
            context$2$0.t0 = context$2$0.sent;

          case 5:
            if (!context$2$0.t0) {
              context$2$0.next = 9;
              break;
            }

            _logger2['default'].debug('Capability \'forceEspressoRebuild\' on. Deleting file \'' + this.modServerPath + '\'');
            context$2$0.next = 9;
            return _regeneratorRuntime.awrap(_appiumSupport.fs.unlink(this.modServerPath));

          case 9:
            context$2$0.next = 11;
            return _regeneratorRuntime.awrap(_appiumSupport.fs.exists(this.modServerPath));

          case 11:
            if (context$2$0.sent) {
              context$2$0.next = 14;
              break;
            }

            context$2$0.next = 14;
            return _regeneratorRuntime.awrap(this.buildNewModServer());

          case 14:
            context$2$0.next = 16;
            return _regeneratorRuntime.awrap(this.checkAndSignCert(this.modServerPath));

          case 16:
            if (!context$2$0.sent) {
              context$2$0.next = 20;
              break;
            }

            _logger2['default'].info("New server was built, uninstalling any instances of it");
            context$2$0.next = 20;
            return _regeneratorRuntime.awrap(this.adb.uninstallApk(TEST_APK_PKG));

          case 20:
            context$2$0.next = 22;
            return _regeneratorRuntime.awrap(this.adb.install(this.modServerPath));

          case 22:
            _logger2['default'].info('Installed Espresso Test Server apk \'' + this.modServerPath + '\' (pkg: \'' + TEST_APK_PKG + '\')');

          case 23:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'buildNewModServer',
    value: function buildNewModServer() {
      var packageTmpDir, newManifestPath;
      return _regeneratorRuntime.async(function buildNewModServer$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            _logger2['default'].info('Repackaging espresso server for: \'' + this.appPackage + '\'');
            packageTmpDir = _path2['default'].resolve(this.tmpDir, this.appPackage);
            newManifestPath = _path2['default'].resolve(this.tmpDir, 'AndroidManifest.xml');

            _logger2['default'].info('Creating new manifest: \'' + newManifestPath + '\'');
            context$2$0.next = 6;
            return _regeneratorRuntime.awrap(_appiumSupport.fs.mkdir(packageTmpDir));

          case 6:
            context$2$0.next = 8;
            return _regeneratorRuntime.awrap(_appiumSupport.fs.copyFile(TEST_MANIFEST_PATH, newManifestPath));

          case 8:
            context$2$0.next = 10;
            return _regeneratorRuntime.awrap(this.adb.initAapt());

          case 10:
            context$2$0.next = 12;
            return _regeneratorRuntime.awrap(this.adb.compileManifest(newManifestPath, TEST_APK_PKG, this.appPackage));

          case 12:
            context$2$0.next = 14;
            return _regeneratorRuntime.awrap(this.adb.insertManifest(newManifestPath, TEST_APK_PATH, this.modServerPath));

          case 14:
            // copies from second to third and add manifest
            _logger2['default'].info('Repackaged espresso server ready: \'' + this.modServerPath + '\'');

          case 15:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }

    // TODO duplicated from uiautomator2, should be a lib method
  }, {
    key: 'checkAndSignCert',
    value: function checkAndSignCert(apk, apkPackage) {
      var signed;
      return _regeneratorRuntime.async(function checkAndSignCert$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(this.adb.checkApkCert(apk, apkPackage));

          case 2:
            signed = context$2$0.sent;

            if (signed) {
              context$2$0.next = 6;
              break;
            }

            context$2$0.next = 6;
            return _regeneratorRuntime.awrap(this.adb.sign(apk));

          case 6:
            return context$2$0.abrupt('return', !signed);

          case 7:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'startSession',
    value: function startSession(caps) {
      var cmd, err;
      return _regeneratorRuntime.async(function startSession$(context$2$0) {
        var _this = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            cmd = ['am', 'instrument', '-w', '-e', 'debug', process.env.ESPRESSO_JAVA_DEBUG === 'true' ? 'true' : 'false', TEST_APK_PKG + '/android.support.test.runner.AndroidJUnitRunner'];

            _logger2['default'].info('Starting Espresso Server v' + _packageJson.version + ' with cmd: ' + cmd.join(' '));

            // start the instrumentation process, but do not wait for it
            // otherwise it will block for longer than needed for the device to be ready
            err = undefined;

            this.adb.shell(cmd)['catch'](function (e) {
              // eslint-disable-line
              // handle asynchronous errors that no longer get thrown
              err = e;
            });

            _logger2['default'].info('Waiting for Espresso to be online...');

            // wait 20s for espresso to be online
            context$2$0.next = 7;
            return _regeneratorRuntime.awrap((0, _asyncbox.retryInterval)(20, 1000, function callee$2$0() {
              return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
                while (1) switch (context$3$0.prev = context$3$0.next) {
                  case 0:
                    if (!err) {
                      context$3$0.next = 2;
                      break;
                    }

                    return context$3$0.abrupt('return');

                  case 2:
                    context$3$0.next = 4;
                    return _regeneratorRuntime.awrap(this.jwproxy.command('/status', 'GET'));

                  case 4:
                  case 'end':
                    return context$3$0.stop();
                }
              }, null, _this);
            }));

          case 7:
            if (!err) {
              context$2$0.next = 9;
              break;
            }

            throw err;

          case 9:
            context$2$0.next = 11;
            return _regeneratorRuntime.awrap(this.jwproxy.command('/session', 'POST', { desiredCapabilities: caps }));

          case 11:
            if (!err) {
              context$2$0.next = 13;
              break;
            }

            throw err;

          case 13:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'deleteSession',
    // eslint-disable-line curly
    value: function deleteSession() {
      return _regeneratorRuntime.async(function deleteSession$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            _logger2['default'].debug('Deleting Espresso server session');
            // rely on jwproxy's intelligence to know what we're talking about and
            // delete the current session
            context$2$0.prev = 1;
            context$2$0.next = 4;
            return _regeneratorRuntime.awrap(this.jwproxy.command('/', 'DELETE'));

          case 4:
            context$2$0.next = 9;
            break;

          case 6:
            context$2$0.prev = 6;
            context$2$0.t0 = context$2$0['catch'](1);

            _logger2['default'].warn('Did not get confirmation Espresso deleteSession worked; ' + ('Error was: ' + context$2$0.t0));

          case 9:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[1, 6]]);
    }
  }]);

  return EspressoRunner;
})();

exports.EspressoRunner = EspressoRunner;
exports.REQUIRED_PARAMS = REQUIRED_PARAMS;
exports['default'] = EspressoRunner;
// TODO this should be internal to adb
// creates a file `${newManifestPath}.apk`
// eslint-disable-line curly
// eslint-disable-line curly
//# sourceMappingURL=data:application/json;charset=utf8;base64,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Q0FBQyxtQkFBbUIsS0FBSyxNQUFNLEdBQUcsTUFBTSxHQUFHLE9BQU8sRUFDNUcsWUFBWSxxREFBa0Q7O0FBRW5FLGdDQUFPLElBQUksdUVBQW1ELEdBQUcsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUcsQ0FBQzs7OztBQUkzRSxlQUFHOztBQUNQLGdCQUFJLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsU0FBTSxDQUFDLFVBQUMsQ0FBQyxFQUFLOzs7QUFFL0IsaUJBQUcsR0FBRyxDQUFDLENBQUM7YUFDVCxDQUFDLENBQUM7O0FBRUgsZ0NBQU8sSUFBSSxDQUFDLHNDQUFzQyxDQUFDLENBQUM7Ozs7NkNBRzlDLDZCQUFjLEVBQUUsRUFBRSxJQUFJLEVBQUU7Ozs7eUJBQ3hCLEdBQUc7Ozs7Ozs7OztxREFDRCxJQUFJLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxTQUFTLEVBQUUsS0FBSyxDQUFDOzs7Ozs7O2FBQzdDLENBQUM7OztpQkFDRSxHQUFHOzs7OztrQkFBUSxHQUFHOzs7OzZDQUNaLElBQUksQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLFVBQVUsRUFBRSxNQUFNLEVBQUUsRUFBQyxtQkFBbUIsRUFBRSxJQUFJLEVBQUMsQ0FBQzs7O2lCQUN2RSxHQUFHOzs7OztrQkFBUSxHQUFHOzs7Ozs7O0tBQ25COzs7O1dBRW1COzs7O0FBQ2xCLGdDQUFPLEtBQUssQ0FBQyxrQ0FBa0MsQ0FBQyxDQUFDOzs7Ozs2Q0FJekMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsR0FBRyxFQUFFLFFBQVEsQ0FBQzs7Ozs7Ozs7OztBQUV6QyxnQ0FBTyxJQUFJLENBQUMsNkZBQ1csQ0FBQyxDQUFDOzs7Ozs7O0tBRTVCOzs7U0F6RkcsY0FBYzs7O1FBNEZYLGNBQWMsR0FBZCxjQUFjO1FBQUUsZUFBZSxHQUFmLGVBQWU7cUJBQ3pCLGNBQWMiLCJmaWxlIjoibGliL2VzcHJlc3NvLXJ1bm5lci5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEpXUHJveHkgfSBmcm9tICdhcHBpdW0tYmFzZS1kcml2ZXInO1xuaW1wb3J0IHsgcmV0cnlJbnRlcnZhbCB9IGZyb20gJ2FzeW5jYm94JztcbmltcG9ydCBsb2dnZXIgZnJvbSAnLi9sb2dnZXInO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgeyBmcywgdXRpbCB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcbmltcG9ydCB7IHZlcnNpb24gfSBmcm9tICcuLi8uLi9wYWNrYWdlLmpzb24nOyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIGltcG9ydC9uby11bnJlc29sdmVkXG5cblxuY29uc3QgVEVTVF9BUEtfUEFUSCA9IHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsICcuLicsICcuLicsICdlc3ByZXNzby1zZXJ2ZXInLCAnYXBwJywgJ2J1aWxkJywgJ291dHB1dHMnLCAnYXBrJywgJ2FuZHJvaWRUZXN0JywgJ2RlYnVnJywgJ2FwcC1kZWJ1Zy1hbmRyb2lkVGVzdC5hcGsnKTtcbmNvbnN0IFRFU1RfTUFOSUZFU1RfUEFUSCA9IHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsICcuLicsICcuLicsICdlc3ByZXNzby1zZXJ2ZXInLCAnQW5kcm9pZE1hbmlmZXN0LXRlc3QueG1sJyk7XG5jb25zdCBURVNUX0FQS19QS0cgPSBcImlvLmFwcGl1bS5lc3ByZXNzb3NlcnZlci50ZXN0XCI7XG5jb25zdCBSRVFVSVJFRF9QQVJBTVMgPSBbJ2FkYicsICd0bXBEaXInLCAnaG9zdCcsICdzeXN0ZW1Qb3J0JywgJ2RldmljZVBvcnQnLCAnYXBwUGFja2FnZScsICdmb3JjZUVzcHJlc3NvUmVidWlsZCddO1xuXG5jbGFzcyBFc3ByZXNzb1J1bm5lciB7XG4gIGNvbnN0cnVjdG9yIChvcHRzID0ge30pIHtcbiAgICBmb3IgKGxldCByZXEgb2YgUkVRVUlSRURfUEFSQU1TKSB7XG4gICAgICBpZiAoIW9wdHMgfHwgIXV0aWwuaGFzVmFsdWUob3B0c1tyZXFdKSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYE9wdGlvbiAnJHtyZXF9JyBpcyByZXF1aXJlZCFgKTtcbiAgICAgIH1cbiAgICAgIHRoaXNbcmVxXSA9IG9wdHNbcmVxXTtcbiAgICB9XG4gICAgdGhpcy5qd3Byb3h5ID0gbmV3IEpXUHJveHkoe2hvc3Q6IHRoaXMuaG9zdCwgcG9ydDogdGhpcy5zeXN0ZW1Qb3J0LCBiYXNlOiAnJ30pO1xuICAgIHRoaXMucHJveHlSZXFSZXMgPSB0aGlzLmp3cHJveHkucHJveHlSZXFSZXMuYmluZCh0aGlzLmp3cHJveHkpO1xuXG4gICAgdGhpcy5tb2RTZXJ2ZXJQYXRoID0gcGF0aC5yZXNvbHZlKHRoaXMudG1wRGlyLCBgJHtURVNUX0FQS19QS0d9XyR7dmVyc2lvbn1fJHt0aGlzLmFwcFBhY2thZ2V9LmFwa2ApO1xuICB9XG5cbiAgYXN5bmMgaW5zdGFsbFRlc3RBcGsgKCkge1xuICAgIGlmICh0aGlzLmZvcmNlRXNwcmVzc29SZWJ1aWxkICYmIGF3YWl0IGZzLmV4aXN0cyh0aGlzLm1vZFNlcnZlclBhdGgpKSB7XG4gICAgICBsb2dnZXIuZGVidWcoYENhcGFiaWxpdHkgJ2ZvcmNlRXNwcmVzc29SZWJ1aWxkJyBvbi4gRGVsZXRpbmcgZmlsZSAnJHt0aGlzLm1vZFNlcnZlclBhdGh9J2ApO1xuICAgICAgYXdhaXQgZnMudW5saW5rKHRoaXMubW9kU2VydmVyUGF0aCk7XG4gICAgfVxuXG4gICAgaWYgKCEoYXdhaXQgZnMuZXhpc3RzKHRoaXMubW9kU2VydmVyUGF0aCkpKSB7XG4gICAgICBhd2FpdCB0aGlzLmJ1aWxkTmV3TW9kU2VydmVyKCk7XG4gICAgfVxuICAgIGlmIChhd2FpdCB0aGlzLmNoZWNrQW5kU2lnbkNlcnQodGhpcy5tb2RTZXJ2ZXJQYXRoKSkge1xuICAgICAgbG9nZ2VyLmluZm8oXCJOZXcgc2VydmVyIHdhcyBidWlsdCwgdW5pbnN0YWxsaW5nIGFueSBpbnN0YW5jZXMgb2YgaXRcIik7XG4gICAgICBhd2FpdCB0aGlzLmFkYi51bmluc3RhbGxBcGsoVEVTVF9BUEtfUEtHKTtcbiAgICB9XG4gICAgYXdhaXQgdGhpcy5hZGIuaW5zdGFsbCh0aGlzLm1vZFNlcnZlclBhdGgpO1xuICAgIGxvZ2dlci5pbmZvKGBJbnN0YWxsZWQgRXNwcmVzc28gVGVzdCBTZXJ2ZXIgYXBrICcke3RoaXMubW9kU2VydmVyUGF0aH0nIChwa2c6ICcke1RFU1RfQVBLX1BLR30nKWApO1xuICB9XG5cbiAgYXN5bmMgYnVpbGROZXdNb2RTZXJ2ZXIgKCkge1xuICAgIGxvZ2dlci5pbmZvKGBSZXBhY2thZ2luZyBlc3ByZXNzbyBzZXJ2ZXIgZm9yOiAnJHt0aGlzLmFwcFBhY2thZ2V9J2ApO1xuICAgIGxldCBwYWNrYWdlVG1wRGlyID0gcGF0aC5yZXNvbHZlKHRoaXMudG1wRGlyLCB0aGlzLmFwcFBhY2thZ2UpO1xuICAgIGxldCBuZXdNYW5pZmVzdFBhdGggPSBwYXRoLnJlc29sdmUodGhpcy50bXBEaXIsICdBbmRyb2lkTWFuaWZlc3QueG1sJyk7XG4gICAgbG9nZ2VyLmluZm8oYENyZWF0aW5nIG5ldyBtYW5pZmVzdDogJyR7bmV3TWFuaWZlc3RQYXRofSdgKTtcbiAgICBhd2FpdCBmcy5ta2RpcihwYWNrYWdlVG1wRGlyKTtcbiAgICBhd2FpdCBmcy5jb3B5RmlsZShURVNUX01BTklGRVNUX1BBVEgsIG5ld01hbmlmZXN0UGF0aCk7XG4gICAgYXdhaXQgdGhpcy5hZGIuaW5pdEFhcHQoKTsgLy8gVE9ETyB0aGlzIHNob3VsZCBiZSBpbnRlcm5hbCB0byBhZGJcbiAgICBhd2FpdCB0aGlzLmFkYi5jb21waWxlTWFuaWZlc3QobmV3TWFuaWZlc3RQYXRoLCBURVNUX0FQS19QS0csIHRoaXMuYXBwUGFja2FnZSk7IC8vIGNyZWF0ZXMgYSBmaWxlIGAke25ld01hbmlmZXN0UGF0aH0uYXBrYFxuICAgIGF3YWl0IHRoaXMuYWRiLmluc2VydE1hbmlmZXN0KG5ld01hbmlmZXN0UGF0aCwgVEVTVF9BUEtfUEFUSCwgdGhpcy5tb2RTZXJ2ZXJQYXRoKTsgLy8gY29waWVzIGZyb20gc2Vjb25kIHRvIHRoaXJkIGFuZCBhZGQgbWFuaWZlc3RcbiAgICBsb2dnZXIuaW5mbyhgUmVwYWNrYWdlZCBlc3ByZXNzbyBzZXJ2ZXIgcmVhZHk6ICcke3RoaXMubW9kU2VydmVyUGF0aH0nYCk7XG4gIH1cblxuICAvLyBUT0RPIGR1cGxpY2F0ZWQgZnJvbSB1aWF1dG9tYXRvcjIsIHNob3VsZCBiZSBhIGxpYiBtZXRob2RcbiAgYXN5bmMgY2hlY2tBbmRTaWduQ2VydCAoYXBrLCBhcGtQYWNrYWdlKSB7XG4gICAgbGV0IHNpZ25lZCA9IGF3YWl0IHRoaXMuYWRiLmNoZWNrQXBrQ2VydChhcGssIGFwa1BhY2thZ2UpO1xuICAgIGlmICghc2lnbmVkKSB7XG4gICAgICBhd2FpdCB0aGlzLmFkYi5zaWduKGFwayk7XG4gICAgfVxuICAgIHJldHVybiAhc2lnbmVkO1xuICB9XG5cbiAgYXN5bmMgc3RhcnRTZXNzaW9uIChjYXBzKSB7XG4gICAgbGV0IGNtZCA9IFsnYW0nLCAnaW5zdHJ1bWVudCcsICctdycsICctZScsICdkZWJ1ZycsIHByb2Nlc3MuZW52LkVTUFJFU1NPX0pBVkFfREVCVUcgPT09ICd0cnVlJyA/ICd0cnVlJyA6ICdmYWxzZScsXG4gICAgICBgJHtURVNUX0FQS19QS0d9L2FuZHJvaWQuc3VwcG9ydC50ZXN0LnJ1bm5lci5BbmRyb2lkSlVuaXRSdW5uZXJgXTtcblxuICAgIGxvZ2dlci5pbmZvKGBTdGFydGluZyBFc3ByZXNzbyBTZXJ2ZXIgdiR7dmVyc2lvbn0gd2l0aCBjbWQ6ICR7Y21kLmpvaW4oJyAnKX1gKTtcblxuICAgIC8vIHN0YXJ0IHRoZSBpbnN0cnVtZW50YXRpb24gcHJvY2VzcywgYnV0IGRvIG5vdCB3YWl0IGZvciBpdFxuICAgIC8vIG90aGVyd2lzZSBpdCB3aWxsIGJsb2NrIGZvciBsb25nZXIgdGhhbiBuZWVkZWQgZm9yIHRoZSBkZXZpY2UgdG8gYmUgcmVhZHlcbiAgICBsZXQgZXJyO1xuICAgIHRoaXMuYWRiLnNoZWxsKGNtZCkuY2F0Y2goKGUpID0+IHsgLy8gZXNsaW50LWRpc2FibGUtbGluZVxuICAgICAgLy8gaGFuZGxlIGFzeW5jaHJvbm91cyBlcnJvcnMgdGhhdCBubyBsb25nZXIgZ2V0IHRocm93blxuICAgICAgZXJyID0gZTtcbiAgICB9KTtcblxuICAgIGxvZ2dlci5pbmZvKCdXYWl0aW5nIGZvciBFc3ByZXNzbyB0byBiZSBvbmxpbmUuLi4nKTtcblxuICAgIC8vIHdhaXQgMjBzIGZvciBlc3ByZXNzbyB0byBiZSBvbmxpbmVcbiAgICBhd2FpdCByZXRyeUludGVydmFsKDIwLCAxMDAwLCBhc3luYyAoKSA9PiB7XG4gICAgICBpZiAoZXJyKSByZXR1cm47IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgY3VybHlcbiAgICAgIGF3YWl0IHRoaXMuandwcm94eS5jb21tYW5kKCcvc3RhdHVzJywgJ0dFVCcpO1xuICAgIH0pO1xuICAgIGlmIChlcnIpIHRocm93IGVycjsgLy8gZXNsaW50LWRpc2FibGUtbGluZSBjdXJseVxuICAgIGF3YWl0IHRoaXMuandwcm94eS5jb21tYW5kKCcvc2Vzc2lvbicsICdQT1NUJywge2Rlc2lyZWRDYXBhYmlsaXRpZXM6IGNhcHN9KTtcbiAgICBpZiAoZXJyKSB0aHJvdyBlcnI7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgY3VybHlcbiAgfVxuXG4gIGFzeW5jIGRlbGV0ZVNlc3Npb24gKCkge1xuICAgIGxvZ2dlci5kZWJ1ZygnRGVsZXRpbmcgRXNwcmVzc28gc2VydmVyIHNlc3Npb24nKTtcbiAgICAvLyByZWx5IG9uIGp3cHJveHkncyBpbnRlbGxpZ2VuY2UgdG8ga25vdyB3aGF0IHdlJ3JlIHRhbGtpbmcgYWJvdXQgYW5kXG4gICAgLy8gZGVsZXRlIHRoZSBjdXJyZW50IHNlc3Npb25cbiAgICB0cnkge1xuICAgICAgYXdhaXQgdGhpcy5qd3Byb3h5LmNvbW1hbmQoJy8nLCAnREVMRVRFJyk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBsb2dnZXIud2FybihgRGlkIG5vdCBnZXQgY29uZmlybWF0aW9uIEVzcHJlc3NvIGRlbGV0ZVNlc3Npb24gd29ya2VkOyBgICtcbiAgICAgICAgICBgRXJyb3Igd2FzOiAke2Vycn1gKTtcbiAgICB9XG4gIH1cbn1cblxuZXhwb3J0IHsgRXNwcmVzc29SdW5uZXIsIFJFUVVJUkVEX1BBUkFNUyB9O1xuZXhwb3J0IGRlZmF1bHQgRXNwcmVzc29SdW5uZXI7XG4iXSwic291cmNlUm9vdCI6Ii4uLy4uIn0=
