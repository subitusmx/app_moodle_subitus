'use strict';

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _getIterator = require('babel-runtime/core-js/get-iterator')['default'];

var _Object$assign = require('babel-runtime/core-js/object/assign')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _logger = require('../logger');

var _logger2 = _interopRequireDefault(_logger);

var _appiumSupport = require('appium-support');

var _appiumBaseDriver = require('appium-base-driver');

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _js2xmlparser2 = require('js2xmlparser2');

var _js2xmlparser22 = _interopRequireDefault(_js2xmlparser2);

var _xmldom = require('xmldom');

var _xmldom2 = _interopRequireDefault(_xmldom);

var _xpath = require('xpath');

var _xpath2 = _interopRequireDefault(_xpath);

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

var _utils = require('../utils');

var commands = {},
    helpers = {},
    extensions = {};

helpers.findElOrEls = function callee$0$0(strategy, selector, mult, context) {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context = (0, _utils.unwrapEl)(context);

        if (!this.isWebContext()) {
          context$1$0.next = 7;
          break;
        }

        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(this.findWebElementOrElements(strategy, selector, mult, context));

      case 4:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 7:
        context$1$0.next = 9;
        return _regeneratorRuntime.awrap(this.findUIElementOrElements(strategy, selector, mult, context));

      case 9:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 10:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

helpers.findUIElementOrElements = function callee$0$0(strategy, selector, mult, context) {
  var createGetElementCommand, getLocalizedStringForSelector, res, doFind;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    var _this = this;

    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (strategy !== "xpath") {
          selector = _appiumSupport.util.escapeSpecialChars(selector, "'");
        }
        if (typeof context === "undefined" || !context) {
          context = '';
        } else if (typeof context === "string") {
          context = _appiumSupport.util.escapeSpecialChars(context, "'");
        }

        // previously getSelectorForStrategy

        if (!(strategy === 'class name' && selector.indexOf('UIA') !== 0)) {
          context$1$0.next = 4;
          break;
        }

        throw new _appiumBaseDriver.errors.InvalidSelectorError('The class name selector must use full UIA class names. Try \'UIA' + selector + '\' instead.');

      case 4:

        if (!selector) new _appiumBaseDriver.errors.InvalidSelectorError('Missing selector'); // eslint-disable-line curly

        createGetElementCommand = function createGetElementCommand(strategy, selector, mult, context) {
          var ext = mult ? 's' : '';
          var command = "";
          context = !context ? context : ', \'' + context + '\'';
          switch (strategy) {
            case "name":
              command = 'au.getElement' + ext + 'ByName(\'' + selector + '\'' + context + ')';
              break;
            case "accessibility id":
              command = 'au.getElement' + ext + 'ByAccessibilityId(\'' + selector + '\'' + context + ')';
              break;
            case "id":
              command = 'au.getElement' + ext + 'ById(\'' + selector + '\')';
              break;
            case "-ios uiautomation":
              command = 'au.getElement' + ext + 'ByUIAutomation(\'' + selector + '\'' + context + ')';
              break;
            default:
              command = 'au.getElement' + ext + 'ByType(\'' + selector + '\'' + context + ')';
          }

          return command;
        };

        getLocalizedStringForSelector = function getLocalizedStringForSelector(selector, strings) {
          var newSelector = selector;
          if (strings) {
            var localizedSelector = strings[selector];
            if (localizedSelector) {
              newSelector = localizedSelector;
            } else {
              _logger2['default'].debug('Id selector, \'' + selector + '\', not found in Localizable.strings.');
            }
          }

          return newSelector;
        };

        res = undefined;

        doFind = function doFind() {
          var findByAxIdCmd, findByIdCmd, command;
          return _regeneratorRuntime.async(function doFind$(context$2$0) {
            while (1) switch (context$2$0.prev = context$2$0.next) {
              case 0:
                if (!(strategy === "xpath")) {
                  context$2$0.next = 6;
                  break;
                }

                context$2$0.next = 3;
                return _regeneratorRuntime.awrap(this.findUIElementsByXpath(selector, mult, context));

              case 3:
                res = context$2$0.sent;
                context$2$0.next = 22;
                break;

              case 6:
                if (!(strategy === "id")) {
                  context$2$0.next = 18;
                  break;
                }

                findByAxIdCmd = createGetElementCommand("accessibility id", selector, mult, context);
                context$2$0.next = 10;
                return _regeneratorRuntime.awrap(this.uiAutoClient.sendCommand(findByAxIdCmd));

              case 10:
                res = context$2$0.sent;

                if (res && _lodash2['default'].size(res) > 0) {
                  context$2$0.next = 16;
                  break;
                }

                findByIdCmd = createGetElementCommand("id", getLocalizedStringForSelector(selector, this.opts.localizableStrings), mult, context);
                context$2$0.next = 15;
                return _regeneratorRuntime.awrap(this.uiAutoClient.sendCommand(findByIdCmd));

              case 15:
                res = context$2$0.sent;

              case 16:
                context$2$0.next = 22;
                break;

              case 18:
                command = createGetElementCommand(strategy, selector, mult, context);
                context$2$0.next = 21;
                return _regeneratorRuntime.awrap(this.uiAutoClient.sendCommand(command));

              case 21:
                res = context$2$0.sent;

              case 22:
                return context$2$0.abrupt('return', _lodash2['default'].size(res) > 0);

              case 23:
              case 'end':
                return context$2$0.stop();
            }
          }, null, _this);
        };

        context$1$0.prev = 9;
        context$1$0.next = 12;
        return _regeneratorRuntime.awrap(this.implicitWaitForCondition(doFind));

      case 12:
        context$1$0.next = 21;
        break;

      case 14:
        context$1$0.prev = 14;
        context$1$0.t0 = context$1$0['catch'](9);

        if (!(context$1$0.t0.message && context$1$0.t0.message.match(/Condition unmet/))) {
          context$1$0.next = 20;
          break;
        }

        // condition was not met setting res to empty array
        res = [];
        context$1$0.next = 21;
        break;

      case 20:
        throw context$1$0.t0;

      case 21:
        if (!mult) {
          context$1$0.next = 25;
          break;
        }

        return context$1$0.abrupt('return', res);

      case 25:
        if (!(!res || _lodash2['default'].size(res) === 0)) {
          context$1$0.next = 27;
          break;
        }

        throw new _appiumBaseDriver.errors.NoSuchElementError();

      case 27:
        return context$1$0.abrupt('return', res);

      case 28:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[9, 14]]);
};

var _pathFromDomNode = function _pathFromDomNode(node) {
  var path = null;
  var _iteratorNormalCompletion = true;
  var _didIteratorError = false;
  var _iteratorError = undefined;

  try {
    for (var _iterator = _getIterator(_lodash2['default'].values(node.attributes)), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
      var attrObj = _step.value;

      if (attrObj.name === "path") {
        path = attrObj.value;
      }
    }
  } catch (err) {
    _didIteratorError = true;
    _iteratorError = err;
  } finally {
    try {
      if (!_iteratorNormalCompletion && _iterator['return']) {
        _iterator['return']();
      }
    } finally {
      if (_didIteratorError) {
        throw _iteratorError;
      }
    }
  }

  return path;
};

var _xmlSourceFromJson = function _xmlSourceFromJson(jsonSource) {
  if (typeof jsonSource === "string") {
    jsonSource = JSON.parse(jsonSource);
  }
  return (0, _js2xmlparser22['default'])("AppiumAUT", jsonSource, {
    wrapArray: { enabled: false, elementName: "element" },
    declaration: { include: true },
    prettyPrinting: { indentString: "    " }
  });
};

var _performXpathQueryOnJson = function _performXpathQueryOnJson(selector, jsonSource) {
  var xmlSource = _xmlSourceFromJson(jsonSource);
  var dom = new _xmldom2['default'].DOMParser().parseFromString(xmlSource);
  return _xpath2['default'].select(selector, dom);
};

commands.findUIElementsByXpath = function callee$0$0(selector, mult) {
  var context = arguments.length <= 2 || arguments[2] === undefined ? null : arguments[2];
  var curRetry = arguments.length <= 3 || arguments[3] === undefined ? 1 : arguments[3];

  var sourceXml, selectedNodes, indexPaths, _iteratorNormalCompletion2, _didIteratorError2, _iteratorError2, _iterator2, _step2, node, ip, methodName, methodArgs, proxyCmd, res;

  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        sourceXml = undefined;
        context$1$0.prev = 1;
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(this.getSourceForElementForXML(context));

      case 4:
        sourceXml = context$1$0.sent;
        context$1$0.next = 11;
        break;

      case 7:
        context$1$0.prev = 7;
        context$1$0.t0 = context$1$0['catch'](1);

        _logger2['default'].warn("Error getting source, can't continue finding element by XPath");
        throw context$1$0.t0;

      case 11:
        selectedNodes = _performXpathQueryOnJson(selector, sourceXml);

        if (!mult) {
          selectedNodes = selectedNodes.slice(0, 1);
        }
        indexPaths = [];
        _iteratorNormalCompletion2 = true;
        _didIteratorError2 = false;
        _iteratorError2 = undefined;
        context$1$0.prev = 17;

        // filter out elements without 'path' attribute
        for (_iterator2 = _getIterator(selectedNodes); !(_iteratorNormalCompletion2 = (_step2 = _iterator2.next()).done); _iteratorNormalCompletion2 = true) {
          node = _step2.value;
          ip = _pathFromDomNode(node);

          if (ip !== null) {
            indexPaths.push(ip);
          }
        }

        context$1$0.next = 25;
        break;

      case 21:
        context$1$0.prev = 21;
        context$1$0.t1 = context$1$0['catch'](17);
        _didIteratorError2 = true;
        _iteratorError2 = context$1$0.t1;

      case 25:
        context$1$0.prev = 25;
        context$1$0.prev = 26;

        if (!_iteratorNormalCompletion2 && _iterator2['return']) {
          _iterator2['return']();
        }

      case 28:
        context$1$0.prev = 28;

        if (!_didIteratorError2) {
          context$1$0.next = 31;
          break;
        }

        throw _iteratorError2;

      case 31:
        return context$1$0.finish(28);

      case 32:
        return context$1$0.finish(25);

      case 33:
        if (!(indexPaths.length < 1)) {
          context$1$0.next = 35;
          break;
        }

        return context$1$0.abrupt('return', []);

      case 35:
        methodName = undefined;
        methodArgs = [];

        if (!mult) {
          methodName = "getElementByIndexPath";
          methodArgs[0] = '\'' + indexPaths[0] + '\'';
        } else {
          methodName = "getElementsByIndexPaths";
          methodArgs[0] = JSON.stringify(indexPaths);
        }

        if (context) {
          methodArgs[1] = 'au.getElement(\'' + context + '\')';
        }

        proxyCmd = 'au.' + methodName + '(' + methodArgs.join(", ") + ')';
        res = undefined;
        context$1$0.prev = 41;
        context$1$0.next = 44;
        return _regeneratorRuntime.awrap(this.uiAutoClient.sendCommand(proxyCmd));

      case 44:
        res = context$1$0.sent;
        context$1$0.next = 57;
        break;

      case 47:
        context$1$0.prev = 47;
        context$1$0.t2 = context$1$0['catch'](41);

        if (!(curRetry < 3)) {
          context$1$0.next = 56;
          break;
        }

        _logger2['default'].debug("Got a warning from uiauto that some index paths " + "could not be resolved, trying again");
        context$1$0.next = 53;
        return _regeneratorRuntime.awrap(_bluebird2['default'].delay(300));

      case 53:
        context$1$0.next = 55;
        return _regeneratorRuntime.awrap(this.findUIElementsByXpath(selector, mult, context, curRetry + 1));

      case 55:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 56:
        throw context$1$0.t2;

      case 57:
        return context$1$0.abrupt('return', res);

      case 58:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[1, 7], [17, 21, 25, 33], [26,, 28, 32], [41, 47]]);
};

_Object$assign(extensions, commands, helpers);
exports.commands = commands;
exports.helpers = helpers;
exports['default'] = extensions;

// For the ID strategy, we first want to handle the selector as an
// accessibility id. If no element is found by that strategy, we fall
// back to searching for the string.

// Since no element was found using the accessibility id, we fall
// back to search by string.

// and if we don't have any matching nodes, return the empty array

// otherwise look up the actual element by its index path

// having index paths means we think elements should be there. Sometimes
// uiauto lags in enabling us to get elements, so we retry a few times if
// it can't find elements we know should be there. see uiauto code
// for more logic

// we get a StaleElementReference if uiauto can't find an element
// by the path we mentioned
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9maW5kLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7O3NCQUFtQixXQUFXOzs7OzZCQUNULGdCQUFnQjs7Z0NBQ2Qsb0JBQW9COztzQkFDN0IsUUFBUTs7Ozs2QkFDSCxlQUFlOzs7O3NCQUNmLFFBQVE7Ozs7cUJBQ1QsT0FBTzs7Ozt3QkFDWCxVQUFVOzs7O3FCQUNDLFVBQVU7O0FBRW5DLElBQUksUUFBUSxHQUFHLEVBQUU7SUFBRSxPQUFPLEdBQUcsRUFBRTtJQUFFLFVBQVUsR0FBRyxFQUFFLENBQUM7O0FBRWpELE9BQU8sQ0FBQyxXQUFXLEdBQUcsb0JBQWdCLFFBQVEsRUFBRSxRQUFRLEVBQUUsSUFBSSxFQUFFLE9BQU87Ozs7QUFDckUsZUFBTyxHQUFHLHFCQUFTLE9BQU8sQ0FBQyxDQUFDOzthQUN4QixJQUFJLENBQUMsWUFBWSxFQUFFOzs7Ozs7eUNBQ1IsSUFBSSxDQUFDLHdCQUF3QixDQUFDLFFBQVEsRUFBRSxRQUFRLEVBQUUsSUFBSSxFQUFFLE9BQU8sQ0FBQzs7Ozs7Ozt5Q0FFaEUsSUFBSSxDQUFDLHVCQUF1QixDQUFDLFFBQVEsRUFBRSxRQUFRLEVBQUUsSUFBSSxFQUFFLE9BQU8sQ0FBQzs7Ozs7Ozs7OztDQUUvRSxDQUFDOztBQUVGLE9BQU8sQ0FBQyx1QkFBdUIsR0FBRyxvQkFBaUIsUUFBUSxFQUFFLFFBQVEsRUFBRSxJQUFJLEVBQUUsT0FBTztNQWtCOUUsdUJBQXVCLEVBd0J2Qiw2QkFBNkIsRUFlN0IsR0FBRyxFQUNILE1BQU07Ozs7OztBQXpEVixZQUFJLFFBQVEsS0FBSyxPQUFPLEVBQUU7QUFDeEIsa0JBQVEsR0FBRyxvQkFBSyxrQkFBa0IsQ0FBQyxRQUFRLEVBQUUsR0FBRyxDQUFDLENBQUM7U0FDbkQ7QUFDRCxZQUFJLE9BQU8sT0FBTyxLQUFLLFdBQVcsSUFBSSxDQUFDLE9BQU8sRUFBRTtBQUM5QyxpQkFBTyxHQUFHLEVBQUUsQ0FBQztTQUNkLE1BQU0sSUFBSSxPQUFPLE9BQU8sS0FBSyxRQUFRLEVBQUU7QUFDdEMsaUJBQU8sR0FBRyxvQkFBSyxrQkFBa0IsQ0FBQyxPQUFPLEVBQUUsR0FBRyxDQUFDLENBQUM7U0FDakQ7Ozs7Y0FHRyxRQUFRLEtBQUssWUFBWSxJQUFJLFFBQVEsQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFBOzs7OztjQUN0RCxJQUFJLHlCQUFPLG9CQUFvQixzRUFDK0IsUUFBUSxpQkFBYTs7OztBQUczRixZQUFJLENBQUMsUUFBUSxFQUFFLElBQUkseUJBQU8sb0JBQW9CLENBQUMsa0JBQWtCLENBQUMsQ0FBQzs7QUFFL0QsK0JBQXVCLEdBQUcsU0FBMUIsdUJBQXVCLENBQWEsUUFBUSxFQUFFLFFBQVEsRUFBRSxJQUFJLEVBQUUsT0FBTyxFQUFFO0FBQ3pFLGNBQUksR0FBRyxHQUFHLElBQUksR0FBRyxHQUFHLEdBQUcsRUFBRSxDQUFDO0FBQzFCLGNBQUksT0FBTyxHQUFHLEVBQUUsQ0FBQztBQUNqQixpQkFBTyxHQUFHLENBQUMsT0FBTyxHQUFHLE9BQU8sWUFBUyxPQUFPLE9BQUcsQ0FBRTtBQUNqRCxrQkFBUSxRQUFRO0FBQ2QsaUJBQUssTUFBTTtBQUNULHFCQUFPLHFCQUFtQixHQUFHLGlCQUFXLFFBQVEsVUFBSSxPQUFPLE1BQUcsQ0FBQztBQUMvRCxvQkFBTTtBQUFBLEFBQ1IsaUJBQUssa0JBQWtCO0FBQ3JCLHFCQUFPLHFCQUFtQixHQUFHLDRCQUFzQixRQUFRLFVBQUksT0FBTyxNQUFHLENBQUM7QUFDMUUsb0JBQU07QUFBQSxBQUNSLGlCQUFLLElBQUk7QUFDUCxxQkFBTyxxQkFBbUIsR0FBRyxlQUFTLFFBQVEsUUFBSSxDQUFDO0FBQ25ELG9CQUFNO0FBQUEsQUFDUixpQkFBSyxtQkFBbUI7QUFDdEIscUJBQU8scUJBQW1CLEdBQUcseUJBQW1CLFFBQVEsVUFBSSxPQUFPLE1BQUcsQ0FBQztBQUN2RSxvQkFBTTtBQUFBLEFBQ1I7QUFDRSxxQkFBTyxxQkFBbUIsR0FBRyxpQkFBVyxRQUFRLFVBQUksT0FBTyxNQUFHLENBQUM7QUFBQSxXQUNsRTs7QUFFRCxpQkFBTyxPQUFPLENBQUM7U0FDaEI7O0FBRUcscUNBQTZCLEdBQUcsU0FBaEMsNkJBQTZCLENBQWEsUUFBUSxFQUFFLE9BQU8sRUFBRTtBQUMvRCxjQUFJLFdBQVcsR0FBRyxRQUFRLENBQUM7QUFDM0IsY0FBSSxPQUFPLEVBQUU7QUFDWCxnQkFBSSxpQkFBaUIsR0FBRyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUM7QUFDMUMsZ0JBQUksaUJBQWlCLEVBQUU7QUFDckIseUJBQVcsR0FBRyxpQkFBaUIsQ0FBQzthQUNqQyxNQUFNO0FBQ0wsa0NBQU8sS0FBSyxxQkFDTyxRQUFRLDJDQUF1QyxDQUFDO2FBQ3BFO1dBQ0Y7O0FBRUQsaUJBQU8sV0FBVyxDQUFDO1NBQ3BCOztBQUVHLFdBQUc7O0FBQ0gsY0FBTSxHQUFHLFNBQVQsTUFBTTtjQU9GLGFBQWEsRUFLWCxXQUFXLEVBS2IsT0FBTzs7OztzQkFoQlQsUUFBUSxLQUFLLE9BQU8sQ0FBQTs7Ozs7O2lEQUNWLElBQUksQ0FBQyxxQkFBcUIsQ0FBQyxRQUFRLEVBQUUsSUFBSSxFQUFFLE9BQU8sQ0FBQzs7O0FBQS9ELG1CQUFHOzs7OztzQkFDTSxRQUFRLEtBQUssSUFBSSxDQUFBOzs7OztBQUl0Qiw2QkFBYSxHQUFHLHVCQUF1QixDQUFDLGtCQUFrQixFQUFFLFFBQVEsRUFBRSxJQUFJLEVBQUUsT0FBTyxDQUFDOztpREFDNUUsSUFBSSxDQUFDLFlBQVksQ0FBQyxXQUFXLENBQUMsYUFBYSxDQUFDOzs7QUFBeEQsbUJBQUc7O29CQUNHLEdBQUcsSUFBSSxvQkFBRSxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQzs7Ozs7QUFHdEIsMkJBQVcsR0FBRyx1QkFBdUIsQ0FBQyxJQUFJLEVBQUUsNkJBQTZCLENBQUMsUUFBUSxFQUNwRixJQUFJLENBQUMsSUFBSSxDQUFDLGtCQUFrQixDQUFDLEVBQUUsSUFBSSxFQUFFLE9BQU8sQ0FBQzs7aURBQ25DLElBQUksQ0FBQyxZQUFZLENBQUMsV0FBVyxDQUFDLFdBQVcsQ0FBQzs7O0FBQXRELG1CQUFHOzs7Ozs7O0FBR0QsdUJBQU8sR0FBRyx1QkFBdUIsQ0FBQyxRQUFRLEVBQUUsUUFBUSxFQUFFLElBQUksRUFBRSxPQUFPLENBQUM7O2lEQUM1RCxJQUFJLENBQUMsWUFBWSxDQUFDLFdBQVcsQ0FBQyxPQUFPLENBQUM7OztBQUFsRCxtQkFBRzs7O29EQUVFLG9CQUFFLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDOzs7Ozs7O1NBQ3ZCOzs7O3lDQUdPLElBQUksQ0FBQyx3QkFBd0IsQ0FBQyxNQUFNLENBQUM7Ozs7Ozs7Ozs7Y0FFdkMsZUFBSSxPQUFPLElBQUksZUFBSSxPQUFPLENBQUMsS0FBSyxDQUFDLGlCQUFpQixDQUFDLENBQUE7Ozs7OztBQUVyRCxXQUFHLEdBQUcsRUFBRSxDQUFDOzs7Ozs7OzthQUtULElBQUk7Ozs7OzRDQUNDLEdBQUc7OztjQUVOLENBQUMsR0FBRyxJQUFJLG9CQUFFLElBQUksQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLENBQUE7Ozs7O2NBQ3JCLElBQUkseUJBQU8sa0JBQWtCLEVBQUU7Ozs0Q0FFaEMsR0FBRzs7Ozs7OztDQUViLENBQUM7O0FBRUYsSUFBSSxnQkFBZ0IsR0FBRyxTQUFuQixnQkFBZ0IsQ0FBYSxJQUFJLEVBQUU7QUFDckMsTUFBSSxJQUFJLEdBQUcsSUFBSSxDQUFDOzs7Ozs7QUFDaEIsc0NBQW9CLG9CQUFFLE1BQU0sQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLDRHQUFFO1VBQXRDLE9BQU87O0FBQ2QsVUFBSSxPQUFPLENBQUMsSUFBSSxLQUFLLE1BQU0sRUFBRTtBQUMzQixZQUFJLEdBQUcsT0FBTyxDQUFDLEtBQUssQ0FBQztPQUN0QjtLQUNGOzs7Ozs7Ozs7Ozs7Ozs7O0FBQ0QsU0FBTyxJQUFJLENBQUM7Q0FDYixDQUFDOztBQUVGLElBQUksa0JBQWtCLEdBQUcsU0FBckIsa0JBQWtCLENBQWEsVUFBVSxFQUFFO0FBQzdDLE1BQUksT0FBTyxVQUFVLEtBQUssUUFBUSxFQUFFO0FBQ2xDLGNBQVUsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLFVBQVUsQ0FBQyxDQUFDO0dBQ3JDO0FBQ0QsU0FBTyxnQ0FBTyxXQUFXLEVBQUUsVUFBVSxFQUFFO0FBQ3JDLGFBQVMsRUFBRSxFQUFDLE9BQU8sRUFBRSxLQUFLLEVBQUUsV0FBVyxFQUFFLFNBQVMsRUFBQztBQUNuRCxlQUFXLEVBQUUsRUFBQyxPQUFPLEVBQUUsSUFBSSxFQUFDO0FBQzVCLGtCQUFjLEVBQUUsRUFBQyxZQUFZLEVBQUUsTUFBTSxFQUFDO0dBQ3ZDLENBQUMsQ0FBQztDQUNKLENBQUM7O0FBRUYsSUFBSSx3QkFBd0IsR0FBRyxTQUEzQix3QkFBd0IsQ0FBYSxRQUFRLEVBQUUsVUFBVSxFQUFFO0FBQzdELE1BQUksU0FBUyxHQUFHLGtCQUFrQixDQUFDLFVBQVUsQ0FBQyxDQUFDO0FBQy9DLE1BQUksR0FBRyxHQUFHLElBQUksb0JBQU8sU0FBUyxFQUFFLENBQUMsZUFBZSxDQUFDLFNBQVMsQ0FBQyxDQUFDO0FBQzVELFNBQU8sbUJBQU0sTUFBTSxDQUFDLFFBQVEsRUFBRSxHQUFHLENBQUMsQ0FBQztDQUNwQyxDQUFDOztBQUVGLFFBQVEsQ0FBQyxxQkFBcUIsR0FBRyxvQkFBZ0IsUUFBUSxFQUFFLElBQUk7TUFBRSxPQUFPLHlEQUFDLElBQUk7TUFBRSxRQUFRLHlEQUFDLENBQUM7O01BQ25GLFNBQVMsRUFPVCxhQUFhLEVBS2IsVUFBVSx1RkFFTCxJQUFJLEVBQ1AsRUFBRSxFQVlKLFVBQVUsRUFDVixVQUFVLEVBY1YsUUFBUSxFQU1SLEdBQUc7Ozs7O0FBaERILGlCQUFTOzs7eUNBRU8sSUFBSSxDQUFDLHlCQUF5QixDQUFDLE9BQU8sQ0FBQzs7O0FBQXpELGlCQUFTOzs7Ozs7OztBQUVULDRCQUFPLElBQUksQ0FBQywrREFBK0QsQ0FBQyxDQUFDOzs7O0FBRzNFLHFCQUFhLEdBQUcsd0JBQXdCLENBQUMsUUFBUSxFQUFFLFNBQVMsQ0FBQzs7QUFFakUsWUFBSSxDQUFDLElBQUksRUFBRTtBQUNULHVCQUFhLEdBQUcsYUFBYSxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7U0FDM0M7QUFDRyxrQkFBVSxHQUFHLEVBQUU7Ozs7Ozs7QUFFbkIsdUNBQWlCLGFBQWEseUdBQUU7QUFBdkIsY0FBSTtBQUNQLFlBQUUsR0FBRyxnQkFBZ0IsQ0FBQyxJQUFJLENBQUM7O0FBQy9CLGNBQUksRUFBRSxLQUFLLElBQUksRUFBRTtBQUNmLHNCQUFVLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1dBQ3JCO1NBQ0Y7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztjQUVHLFVBQVUsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFBOzs7Ozs0Q0FFaEIsRUFBRTs7O0FBSVAsa0JBQVU7QUFDVixrQkFBVSxHQUFHLEVBQUU7O0FBRW5CLFlBQUksQ0FBQyxJQUFJLEVBQUU7QUFDVCxvQkFBVSxHQUFHLHVCQUF1QixDQUFDO0FBQ3JDLG9CQUFVLENBQUMsQ0FBQyxDQUFDLFVBQU8sVUFBVSxDQUFDLENBQUMsQ0FBQyxPQUFHLENBQUM7U0FDdEMsTUFBTTtBQUNMLG9CQUFVLEdBQUcseUJBQXlCLENBQUM7QUFDdkMsb0JBQVUsQ0FBQyxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLFVBQVUsQ0FBQyxDQUFDO1NBQzVDOztBQUVELFlBQUksT0FBTyxFQUFFO0FBQ1gsb0JBQVUsQ0FBQyxDQUFDLENBQUMsd0JBQXFCLE9BQU8sUUFBSSxDQUFDO1NBQy9DOztBQUVHLGdCQUFRLFdBQVMsVUFBVSxTQUFJLFVBQVUsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDO0FBTXBELFdBQUc7Ozt5Q0FFTyxJQUFJLENBQUMsWUFBWSxDQUFDLFdBQVcsQ0FBQyxRQUFRLENBQUM7OztBQUFuRCxXQUFHOzs7Ozs7OztjQUlDLFFBQVEsR0FBRyxDQUFDLENBQUE7Ozs7O0FBQ2QsNEJBQU8sS0FBSyxDQUFDLGtEQUFrRCxHQUNsRCxxQ0FBcUMsQ0FBQyxDQUFDOzt5Q0FDOUMsc0JBQUUsS0FBSyxDQUFDLEdBQUcsQ0FBQzs7Ozt5Q0FDTCxJQUFJLENBQUMscUJBQXFCLENBQUMsUUFBUSxFQUFFLElBQUksRUFBRSxPQUFPLEVBQUUsUUFBUSxHQUFHLENBQUMsQ0FBQzs7Ozs7Ozs7OzRDQUkzRSxHQUFHOzs7Ozs7O0NBQ1gsQ0FBQzs7QUFFRixlQUFjLFVBQVUsRUFBRSxRQUFRLEVBQUUsT0FBTyxDQUFDLENBQUM7UUFDcEMsUUFBUSxHQUFSLFFBQVE7UUFBRSxPQUFPLEdBQVAsT0FBTztxQkFDWCxVQUFVIiwiZmlsZSI6ImxpYi9jb21tYW5kcy9maW5kLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGxvZ2dlciBmcm9tICcuLi9sb2dnZXInO1xuaW1wb3J0IHsgdXRpbCB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcbmltcG9ydCB7IGVycm9ycyB9IGZyb20gJ2FwcGl1bS1iYXNlLWRyaXZlcic7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IGpzMnhtbCBmcm9tICdqczJ4bWxwYXJzZXIyJztcbmltcG9ydCBYTUxEb20gZnJvbSAneG1sZG9tJztcbmltcG9ydCB4cGF0aCBmcm9tICd4cGF0aCc7XG5pbXBvcnQgQiBmcm9tICdibHVlYmlyZCc7XG5pbXBvcnQgeyB1bndyYXBFbCB9IGZyb20gJy4uL3V0aWxzJztcblxubGV0IGNvbW1hbmRzID0ge30sIGhlbHBlcnMgPSB7fSwgZXh0ZW5zaW9ucyA9IHt9O1xuXG5oZWxwZXJzLmZpbmRFbE9yRWxzID0gYXN5bmMgZnVuY3Rpb24gKHN0cmF0ZWd5LCBzZWxlY3RvciwgbXVsdCwgY29udGV4dCkge1xuICBjb250ZXh0ID0gdW53cmFwRWwoY29udGV4dCk7XG4gIGlmICh0aGlzLmlzV2ViQ29udGV4dCgpKSB7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMuZmluZFdlYkVsZW1lbnRPckVsZW1lbnRzKHN0cmF0ZWd5LCBzZWxlY3RvciwgbXVsdCwgY29udGV4dCk7XG4gIH0gZWxzZSB7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMuZmluZFVJRWxlbWVudE9yRWxlbWVudHMoc3RyYXRlZ3ksIHNlbGVjdG9yLCBtdWx0LCBjb250ZXh0KTtcbiAgfVxufTtcblxuaGVscGVycy5maW5kVUlFbGVtZW50T3JFbGVtZW50cyA9IGFzeW5jIGZ1bmN0aW9uICAoc3RyYXRlZ3ksIHNlbGVjdG9yLCBtdWx0LCBjb250ZXh0KSB7XG4gIGlmIChzdHJhdGVneSAhPT0gXCJ4cGF0aFwiKSB7XG4gICAgc2VsZWN0b3IgPSB1dGlsLmVzY2FwZVNwZWNpYWxDaGFycyhzZWxlY3RvciwgXCInXCIpO1xuICB9XG4gIGlmICh0eXBlb2YgY29udGV4dCA9PT0gXCJ1bmRlZmluZWRcIiB8fCAhY29udGV4dCkge1xuICAgIGNvbnRleHQgPSAnJztcbiAgfSBlbHNlIGlmICh0eXBlb2YgY29udGV4dCA9PT0gXCJzdHJpbmdcIikge1xuICAgIGNvbnRleHQgPSB1dGlsLmVzY2FwZVNwZWNpYWxDaGFycyhjb250ZXh0LCBcIidcIik7XG4gIH1cblxuICAvLyBwcmV2aW91c2x5IGdldFNlbGVjdG9yRm9yU3RyYXRlZ3lcbiAgaWYgKHN0cmF0ZWd5ID09PSAnY2xhc3MgbmFtZScgJiYgc2VsZWN0b3IuaW5kZXhPZignVUlBJykgIT09IDApIHtcbiAgICB0aHJvdyBuZXcgZXJyb3JzLkludmFsaWRTZWxlY3RvckVycm9yKFxuICAgICAgYFRoZSBjbGFzcyBuYW1lIHNlbGVjdG9yIG11c3QgdXNlIGZ1bGwgVUlBIGNsYXNzIG5hbWVzLiBUcnkgJ1VJQSR7c2VsZWN0b3J9JyBpbnN0ZWFkLmApO1xuICB9XG5cbiAgaWYgKCFzZWxlY3RvcikgbmV3IGVycm9ycy5JbnZhbGlkU2VsZWN0b3JFcnJvcignTWlzc2luZyBzZWxlY3RvcicpOyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIGN1cmx5XG5cbiAgbGV0IGNyZWF0ZUdldEVsZW1lbnRDb21tYW5kID0gZnVuY3Rpb24gKHN0cmF0ZWd5LCBzZWxlY3RvciwgbXVsdCwgY29udGV4dCkge1xuICAgIGxldCBleHQgPSBtdWx0ID8gJ3MnIDogJyc7XG4gICAgbGV0IGNvbW1hbmQgPSBcIlwiO1xuICAgIGNvbnRleHQgPSAhY29udGV4dCA/IGNvbnRleHQgOiBgLCAnJHtjb250ZXh0fSdgIDtcbiAgICBzd2l0Y2ggKHN0cmF0ZWd5KSB7XG4gICAgICBjYXNlIFwibmFtZVwiOlxuICAgICAgICBjb21tYW5kID0gYGF1LmdldEVsZW1lbnQke2V4dH1CeU5hbWUoJyR7c2VsZWN0b3J9JyR7Y29udGV4dH0pYDtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIFwiYWNjZXNzaWJpbGl0eSBpZFwiOlxuICAgICAgICBjb21tYW5kID0gYGF1LmdldEVsZW1lbnQke2V4dH1CeUFjY2Vzc2liaWxpdHlJZCgnJHtzZWxlY3Rvcn0nJHtjb250ZXh0fSlgO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgXCJpZFwiOlxuICAgICAgICBjb21tYW5kID0gYGF1LmdldEVsZW1lbnQke2V4dH1CeUlkKCcke3NlbGVjdG9yfScpYDtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIFwiLWlvcyB1aWF1dG9tYXRpb25cIjpcbiAgICAgICAgY29tbWFuZCA9IGBhdS5nZXRFbGVtZW50JHtleHR9QnlVSUF1dG9tYXRpb24oJyR7c2VsZWN0b3J9JyR7Y29udGV4dH0pYDtcbiAgICAgICAgYnJlYWs7XG4gICAgICBkZWZhdWx0OlxuICAgICAgICBjb21tYW5kID0gYGF1LmdldEVsZW1lbnQke2V4dH1CeVR5cGUoJyR7c2VsZWN0b3J9JyR7Y29udGV4dH0pYDtcbiAgICB9XG5cbiAgICByZXR1cm4gY29tbWFuZDtcbiAgfTtcblxuICBsZXQgZ2V0TG9jYWxpemVkU3RyaW5nRm9yU2VsZWN0b3IgPSBmdW5jdGlvbiAoc2VsZWN0b3IsIHN0cmluZ3MpIHtcbiAgICBsZXQgbmV3U2VsZWN0b3IgPSBzZWxlY3RvcjtcbiAgICBpZiAoc3RyaW5ncykge1xuICAgICAgbGV0IGxvY2FsaXplZFNlbGVjdG9yID0gc3RyaW5nc1tzZWxlY3Rvcl07XG4gICAgICBpZiAobG9jYWxpemVkU2VsZWN0b3IpIHtcbiAgICAgICAgbmV3U2VsZWN0b3IgPSBsb2NhbGl6ZWRTZWxlY3RvcjtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGxvZ2dlci5kZWJ1ZyhcbiAgICAgICAgICBgSWQgc2VsZWN0b3IsICcke3NlbGVjdG9yfScsIG5vdCBmb3VuZCBpbiBMb2NhbGl6YWJsZS5zdHJpbmdzLmApO1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBuZXdTZWxlY3RvcjtcbiAgfTtcblxuICBsZXQgcmVzO1xuICBsZXQgZG9GaW5kID0gYXN5bmMgKCkgPT4ge1xuICAgIGlmIChzdHJhdGVneSA9PT0gXCJ4cGF0aFwiKSB7XG4gICAgICByZXMgPSBhd2FpdCB0aGlzLmZpbmRVSUVsZW1lbnRzQnlYcGF0aChzZWxlY3RvciwgbXVsdCwgY29udGV4dCk7XG4gICAgfSBlbHNlIGlmIChzdHJhdGVneSA9PT0gXCJpZFwiKSB7XG4gICAgICAvLyBGb3IgdGhlIElEIHN0cmF0ZWd5LCB3ZSBmaXJzdCB3YW50IHRvIGhhbmRsZSB0aGUgc2VsZWN0b3IgYXMgYW5cbiAgICAgIC8vIGFjY2Vzc2liaWxpdHkgaWQuIElmIG5vIGVsZW1lbnQgaXMgZm91bmQgYnkgdGhhdCBzdHJhdGVneSwgd2UgZmFsbFxuICAgICAgLy8gYmFjayB0byBzZWFyY2hpbmcgZm9yIHRoZSBzdHJpbmcuXG4gICAgICBsZXQgZmluZEJ5QXhJZENtZCA9IGNyZWF0ZUdldEVsZW1lbnRDb21tYW5kKFwiYWNjZXNzaWJpbGl0eSBpZFwiLCBzZWxlY3RvciwgbXVsdCwgY29udGV4dCk7XG4gICAgICByZXMgPSBhd2FpdCB0aGlzLnVpQXV0b0NsaWVudC5zZW5kQ29tbWFuZChmaW5kQnlBeElkQ21kKTtcbiAgICAgIGlmICghKHJlcyAmJiBfLnNpemUocmVzKSA+IDApKSB7XG4gICAgICAgIC8vIFNpbmNlIG5vIGVsZW1lbnQgd2FzIGZvdW5kIHVzaW5nIHRoZSBhY2Nlc3NpYmlsaXR5IGlkLCB3ZSBmYWxsXG4gICAgICAgIC8vIGJhY2sgdG8gc2VhcmNoIGJ5IHN0cmluZy5cbiAgICAgICAgbGV0IGZpbmRCeUlkQ21kID0gY3JlYXRlR2V0RWxlbWVudENvbW1hbmQoXCJpZFwiLCBnZXRMb2NhbGl6ZWRTdHJpbmdGb3JTZWxlY3RvcihzZWxlY3RvcixcbiAgICAgICAgICB0aGlzLm9wdHMubG9jYWxpemFibGVTdHJpbmdzKSwgbXVsdCwgY29udGV4dCk7XG4gICAgICAgIHJlcyA9IGF3YWl0IHRoaXMudWlBdXRvQ2xpZW50LnNlbmRDb21tYW5kKGZpbmRCeUlkQ21kKTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgbGV0IGNvbW1hbmQgPSBjcmVhdGVHZXRFbGVtZW50Q29tbWFuZChzdHJhdGVneSwgc2VsZWN0b3IsIG11bHQsIGNvbnRleHQpO1xuICAgICAgcmVzID0gYXdhaXQgdGhpcy51aUF1dG9DbGllbnQuc2VuZENvbW1hbmQoY29tbWFuZCk7XG4gICAgfVxuICAgIHJldHVybiBfLnNpemUocmVzKSA+IDA7XG4gIH07XG5cbiAgdHJ5IHtcbiAgICBhd2FpdCB0aGlzLmltcGxpY2l0V2FpdEZvckNvbmRpdGlvbihkb0ZpbmQpO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBpZiAoZXJyLm1lc3NhZ2UgJiYgZXJyLm1lc3NhZ2UubWF0Y2goL0NvbmRpdGlvbiB1bm1ldC8pKSB7XG4gICAgICAvLyBjb25kaXRpb24gd2FzIG5vdCBtZXQgc2V0dGluZyByZXMgdG8gZW1wdHkgYXJyYXlcbiAgICAgIHJlcyA9IFtdO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aHJvdyBlcnI7XG4gICAgfVxuICB9XG4gIGlmIChtdWx0KSB7XG4gICAgcmV0dXJuIHJlcztcbiAgfSBlbHNlIHtcbiAgICBpZiAoIXJlcyB8fCBfLnNpemUocmVzKSA9PT0gMCkge1xuICAgICAgdGhyb3cgbmV3IGVycm9ycy5Ob1N1Y2hFbGVtZW50RXJyb3IoKTtcbiAgICB9XG4gICAgcmV0dXJuIHJlcztcbiAgfVxufTtcblxubGV0IF9wYXRoRnJvbURvbU5vZGUgPSBmdW5jdGlvbiAobm9kZSkge1xuICBsZXQgcGF0aCA9IG51bGw7XG4gIGZvciAobGV0IGF0dHJPYmogb2YgXy52YWx1ZXMobm9kZS5hdHRyaWJ1dGVzKSkge1xuICAgIGlmIChhdHRyT2JqLm5hbWUgPT09IFwicGF0aFwiKSB7XG4gICAgICBwYXRoID0gYXR0ck9iai52YWx1ZTtcbiAgICB9XG4gIH1cbiAgcmV0dXJuIHBhdGg7XG59O1xuXG5sZXQgX3htbFNvdXJjZUZyb21Kc29uID0gZnVuY3Rpb24gKGpzb25Tb3VyY2UpIHtcbiAgaWYgKHR5cGVvZiBqc29uU291cmNlID09PSBcInN0cmluZ1wiKSB7XG4gICAganNvblNvdXJjZSA9IEpTT04ucGFyc2UoanNvblNvdXJjZSk7XG4gIH1cbiAgcmV0dXJuIGpzMnhtbChcIkFwcGl1bUFVVFwiLCBqc29uU291cmNlLCB7XG4gICAgd3JhcEFycmF5OiB7ZW5hYmxlZDogZmFsc2UsIGVsZW1lbnROYW1lOiBcImVsZW1lbnRcIn0sXG4gICAgZGVjbGFyYXRpb246IHtpbmNsdWRlOiB0cnVlfSxcbiAgICBwcmV0dHlQcmludGluZzoge2luZGVudFN0cmluZzogXCIgICAgXCJ9XG4gIH0pO1xufTtcblxubGV0IF9wZXJmb3JtWHBhdGhRdWVyeU9uSnNvbiA9IGZ1bmN0aW9uIChzZWxlY3RvciwganNvblNvdXJjZSkge1xuICBsZXQgeG1sU291cmNlID0gX3htbFNvdXJjZUZyb21Kc29uKGpzb25Tb3VyY2UpO1xuICBsZXQgZG9tID0gbmV3IFhNTERvbS5ET01QYXJzZXIoKS5wYXJzZUZyb21TdHJpbmcoeG1sU291cmNlKTtcbiAgcmV0dXJuIHhwYXRoLnNlbGVjdChzZWxlY3RvciwgZG9tKTtcbn07XG5cbmNvbW1hbmRzLmZpbmRVSUVsZW1lbnRzQnlYcGF0aCA9IGFzeW5jIGZ1bmN0aW9uIChzZWxlY3RvciwgbXVsdCwgY29udGV4dD1udWxsLCBjdXJSZXRyeT0xKSB7XG4gIGxldCBzb3VyY2VYbWw7XG4gIHRyeSB7XG4gICAgc291cmNlWG1sID0gYXdhaXQgdGhpcy5nZXRTb3VyY2VGb3JFbGVtZW50Rm9yWE1MKGNvbnRleHQpO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBsb2dnZXIud2FybihcIkVycm9yIGdldHRpbmcgc291cmNlLCBjYW4ndCBjb250aW51ZSBmaW5kaW5nIGVsZW1lbnQgYnkgWFBhdGhcIik7XG4gICAgdGhyb3cgZXJyO1xuICB9XG4gIGxldCBzZWxlY3RlZE5vZGVzID0gX3BlcmZvcm1YcGF0aFF1ZXJ5T25Kc29uKHNlbGVjdG9yLCBzb3VyY2VYbWwpO1xuXG4gIGlmICghbXVsdCkge1xuICAgIHNlbGVjdGVkTm9kZXMgPSBzZWxlY3RlZE5vZGVzLnNsaWNlKDAsIDEpO1xuICB9XG4gIGxldCBpbmRleFBhdGhzID0gW107XG4gIC8vIGZpbHRlciBvdXQgZWxlbWVudHMgd2l0aG91dCAncGF0aCcgYXR0cmlidXRlXG4gIGZvciAobGV0IG5vZGUgb2Ygc2VsZWN0ZWROb2Rlcykge1xuICAgIGxldCBpcCA9IF9wYXRoRnJvbURvbU5vZGUobm9kZSk7XG4gICAgaWYgKGlwICE9PSBudWxsKSB7XG4gICAgICBpbmRleFBhdGhzLnB1c2goaXApO1xuICAgIH1cbiAgfVxuXG4gIGlmIChpbmRleFBhdGhzLmxlbmd0aCA8IDEpIHtcbiAgICAvLyBhbmQgaWYgd2UgZG9uJ3QgaGF2ZSBhbnkgbWF0Y2hpbmcgbm9kZXMsIHJldHVybiB0aGUgZW1wdHkgYXJyYXlcbiAgICByZXR1cm4gW107XG4gIH1cblxuICAvLyBvdGhlcndpc2UgbG9vayB1cCB0aGUgYWN0dWFsIGVsZW1lbnQgYnkgaXRzIGluZGV4IHBhdGhcbiAgbGV0IG1ldGhvZE5hbWU7XG4gIGxldCBtZXRob2RBcmdzID0gW107XG5cbiAgaWYgKCFtdWx0KSB7XG4gICAgbWV0aG9kTmFtZSA9IFwiZ2V0RWxlbWVudEJ5SW5kZXhQYXRoXCI7XG4gICAgbWV0aG9kQXJnc1swXSA9IGAnJHtpbmRleFBhdGhzWzBdfSdgO1xuICB9IGVsc2Uge1xuICAgIG1ldGhvZE5hbWUgPSBcImdldEVsZW1lbnRzQnlJbmRleFBhdGhzXCI7XG4gICAgbWV0aG9kQXJnc1swXSA9IEpTT04uc3RyaW5naWZ5KGluZGV4UGF0aHMpO1xuICB9XG5cbiAgaWYgKGNvbnRleHQpIHtcbiAgICBtZXRob2RBcmdzWzFdID0gYGF1LmdldEVsZW1lbnQoJyR7Y29udGV4dH0nKWA7XG4gIH1cblxuICBsZXQgcHJveHlDbWQgPSBgYXUuJHttZXRob2ROYW1lfSgke21ldGhvZEFyZ3Muam9pbihcIiwgXCIpfSlgO1xuXG4gIC8vIGhhdmluZyBpbmRleCBwYXRocyBtZWFucyB3ZSB0aGluayBlbGVtZW50cyBzaG91bGQgYmUgdGhlcmUuIFNvbWV0aW1lc1xuICAvLyB1aWF1dG8gbGFncyBpbiBlbmFibGluZyB1cyB0byBnZXQgZWxlbWVudHMsIHNvIHdlIHJldHJ5IGEgZmV3IHRpbWVzIGlmXG4gIC8vIGl0IGNhbid0IGZpbmQgZWxlbWVudHMgd2Uga25vdyBzaG91bGQgYmUgdGhlcmUuIHNlZSB1aWF1dG8gY29kZVxuICAvLyBmb3IgbW9yZSBsb2dpY1xuICBsZXQgcmVzO1xuICB0cnkge1xuICAgIHJlcyA9IGF3YWl0IHRoaXMudWlBdXRvQ2xpZW50LnNlbmRDb21tYW5kKHByb3h5Q21kKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgLy8gd2UgZ2V0IGEgU3RhbGVFbGVtZW50UmVmZXJlbmNlIGlmIHVpYXV0byBjYW4ndCBmaW5kIGFuIGVsZW1lbnRcbiAgICAvLyBieSB0aGUgcGF0aCB3ZSBtZW50aW9uZWRcbiAgICBpZiAoY3VyUmV0cnkgPCAzKSB7XG4gICAgICBsb2dnZXIuZGVidWcoXCJHb3QgYSB3YXJuaW5nIGZyb20gdWlhdXRvIHRoYXQgc29tZSBpbmRleCBwYXRocyBcIiArXG4gICAgICAgICAgICAgICAgICAgXCJjb3VsZCBub3QgYmUgcmVzb2x2ZWQsIHRyeWluZyBhZ2FpblwiKTtcbiAgICAgIGF3YWl0IEIuZGVsYXkoMzAwKTtcbiAgICAgIHJldHVybiBhd2FpdCB0aGlzLmZpbmRVSUVsZW1lbnRzQnlYcGF0aChzZWxlY3RvciwgbXVsdCwgY29udGV4dCwgY3VyUmV0cnkgKyAxKTtcbiAgICB9XG4gICAgdGhyb3cgZXJyO1xuICB9XG4gIHJldHVybiByZXM7XG59O1xuXG5PYmplY3QuYXNzaWduKGV4dGVuc2lvbnMsIGNvbW1hbmRzLCBoZWxwZXJzKTtcbmV4cG9ydCB7IGNvbW1hbmRzLCBoZWxwZXJzfTtcbmV4cG9ydCBkZWZhdWx0IGV4dGVuc2lvbnM7XG4iXSwic291cmNlUm9vdCI6Ii4uLy4uLy4uIn0=
