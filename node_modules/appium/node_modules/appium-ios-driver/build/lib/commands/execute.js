'use strict';

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _Object$assign = require('babel-runtime/core-js/object/assign')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _appiumBaseDriver = require('appium-base-driver');

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _url = require('url');

var _url2 = _interopRequireDefault(_url);

var _appiumSupport = require('appium-support');

var _logger = require('../logger');

var _logger2 = _interopRequireDefault(_logger);

var _appiumIosSimulator = require('appium-ios-simulator');

var _server = require('../server');

var commands = {},
    helpers = {},
    extensions = {};

commands.execute = function callee$0$0(script, args) {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!script.match(/^mobile\:/)) {
          context$1$0.next = 7;
          break;
        }

        script = script.replace(/^mobile\:/, '').trim();
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(this.executeMobile(script, _lodash2['default'].isArray(args) ? args[0] : args));

      case 4:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 7:
        if (!this.isWebContext()) {
          context$1$0.next = 14;
          break;
        }

        args = this.convertElementsForAtoms(args);
        context$1$0.next = 11;
        return _regeneratorRuntime.awrap(this.executeAtom('execute_script', [script, args]));

      case 11:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 14:
        context$1$0.next = 16;
        return _regeneratorRuntime.awrap(this.uiAutoClient.sendCommand(script));

      case 16:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 17:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.executeAsync = function callee$0$0(script, args, sessionId) {
  var address, port, protocol, currentUrl, responseUrl, defaultHost, urlObject;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (this.isWebContext()) {
          context$1$0.next = 4;
          break;
        }

        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(this.uiAutoClient.sendCommand(script));

      case 3:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 4:
        address = this.opts.callbackAddress || this.opts.address;
        port = this.opts.callbackPort || this.opts.port;

        sessionId = sessionId || this.sessionId;

        // https sites need to reply to an https endpoint, in Safari
        protocol = 'http:';
        context$1$0.prev = 8;
        context$1$0.t0 = _url2['default'];
        context$1$0.next = 12;
        return _regeneratorRuntime.awrap(this.getUrl());

      case 12:
        context$1$0.t1 = context$1$0.sent;
        currentUrl = context$1$0.t0.parse.call(context$1$0.t0, context$1$0.t1);

        if (currentUrl.protocol === 'https:' && this.opts.httpsCallbackPort && this.opts.httpsCallbackAddress) {
          protocol = currentUrl.protocol;
          port = this.opts.httpsCallbackPort;
          address = this.opts.httpsCallbackAddress;
        }
        context$1$0.next = 19;
        break;

      case 17:
        context$1$0.prev = 17;
        context$1$0.t2 = context$1$0['catch'](8);

      case 19:
        responseUrl = protocol + '//' + address + ':' + port + '/wd/hub/session/' + sessionId + '/receive_async_response';

        if (this.isRealDevice()) {
          defaultHost = this.opts.address;
          urlObject = _url2['default'].parse(responseUrl);

          if (urlObject.hostname === defaultHost) {
            _logger2['default'].debug('Real device safari test and no custom callback address ' + 'set, changing callback address to local ip.');
            urlObject.hostname = _appiumSupport.util.localIp();
            urlObject.host = null; // set to null, otherwise hostname is ignored
            responseUrl = _url2['default'].format(urlObject);
          } else {
            _logger2['default'].debug('Custom callback address set, leaving as is.');
          }
        }

        _logger2['default'].debug('Response url for executeAsync: ' + responseUrl);
        args = this.convertElementsForAtoms(args);
        this.asyncWaitMs = this.asyncWaitMs || 0;
        context$1$0.next = 26;
        return _regeneratorRuntime.awrap(this.executeAtomAsync('execute_async_script', [script, args, this.asyncWaitMs], responseUrl));

      case 26:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 27:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[8, 17]]);
};

commands.receiveAsyncResponse = function callee$0$0(status, value) {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].debug('Received async response: ' + JSON.stringify(value));
        if (!_lodash2['default'].isNull(this.asyncPromise) && !_lodash2['default'].isUndefined(this.asyncPromise)) {
          if (status !== 0) {
            this.asyncPromise.reject((0, _appiumBaseDriver.errorFromCode)(status, value.message));
          } else {
            this.asyncPromise.resolve(value);
          }
        } else {
          _logger2['default'].warn('Received async response when we were not expecting one! ' + ('Response was: ' + JSON.stringify(value)));
        }

      case 2:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

helpers.startHttpsAsyncServer = function callee$0$0() {
  var address, port, _ref, sslServer, pemCertificate, httpsPort, udid;

  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].debug('Starting https server for async responses');
        address = this.opts.callbackAddress || this.opts.address;
        port = this.opts.callbackPort || this.opts.port;
        context$1$0.next = 5;
        return _regeneratorRuntime.awrap((0, _server.startHttpsServer)(port, address));

      case 5:
        _ref = context$1$0.sent;
        sslServer = _ref.sslServer;
        pemCertificate = _ref.pemCertificate;
        httpsPort = _ref.httpsPort;

        this.opts.sslServer = sslServer;
        this.opts.httpsServerCertificate = pemCertificate;
        this.opts.httpsCallbackPort = httpsPort;
        this.opts.httpsCallbackAddress = 'localhost';
        udid = undefined;

        if (this.sim) {
          // ios driver
          udid = this.sim.udid;
        } else {
          // xcuitest driver
          udid = this.opts.udid;
        }
        context$1$0.next = 17;
        return _regeneratorRuntime.awrap((0, _appiumIosSimulator.installSSLCert)(this.opts.httpsServerCertificate, udid));

      case 17:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

helpers.stopHttpsAsyncServer = function callee$0$0() {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].debug('Stopping https server for async responses');

        if (!this.opts.sslServer) {
          context$1$0.next = 4;
          break;
        }

        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(this.opts.sslServer.close());

      case 4:
        context$1$0.next = 6;
        return _regeneratorRuntime.awrap((0, _appiumIosSimulator.uninstallSSLCert)(this.opts.httpsServerCertificate, this.opts.udid));

      case 6:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.executeMobile = function callee$0$0(mobileCommand) {
  var opts = arguments.length <= 1 || arguments[1] === undefined ? {} : arguments[1];
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!(mobileCommand === 'scroll')) {
          context$1$0.next = 5;
          break;
        }

        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(this.mobileScroll(opts));

      case 3:
        context$1$0.next = 6;
        break;

      case 5:
        throw new _appiumBaseDriver.errors.UnknownCommandError('Unknown command, all the mobile commands except scroll have been removed.');

      case 6:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

_Object$assign(extensions, commands, helpers);
exports.commands = commands;
exports.helpers = helpers;
exports['default'] = extensions;

// we only support mobile: scroll
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9leGVjdXRlLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7OztnQ0FBc0Msb0JBQW9COztzQkFDNUMsUUFBUTs7OzttQkFDTixLQUFLOzs7OzZCQUNBLGdCQUFnQjs7c0JBQ2xCLFdBQVc7Ozs7a0NBQ21CLHNCQUFzQjs7c0JBQ3RDLFdBQVc7O0FBRzVDLElBQUksUUFBUSxHQUFHLEVBQUU7SUFBRSxPQUFPLEdBQUcsRUFBRTtJQUFFLFVBQVUsR0FBRyxFQUFFLENBQUM7O0FBRWpELFFBQVEsQ0FBQyxPQUFPLEdBQUcsb0JBQWdCLE1BQU0sRUFBRSxJQUFJOzs7O2FBQ3pDLE1BQU0sQ0FBQyxLQUFLLENBQUMsV0FBVyxDQUFDOzs7OztBQUMzQixjQUFNLEdBQUcsTUFBTSxDQUFDLE9BQU8sQ0FBQyxXQUFXLEVBQUUsRUFBRSxDQUFDLENBQUMsSUFBSSxFQUFFLENBQUM7O3lDQUNuQyxJQUFJLENBQUMsYUFBYSxDQUFDLE1BQU0sRUFBRSxvQkFBRSxPQUFPLENBQUMsSUFBSSxDQUFDLEdBQUcsSUFBSSxDQUFDLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQzs7Ozs7O2FBRXJFLElBQUksQ0FBQyxZQUFZLEVBQUU7Ozs7O0FBQ3JCLFlBQUksR0FBRyxJQUFJLENBQUMsdUJBQXVCLENBQUMsSUFBSSxDQUFDLENBQUM7O3lDQUM3QixJQUFJLENBQUMsV0FBVyxDQUFDLGdCQUFnQixFQUFFLENBQUMsTUFBTSxFQUFFLElBQUksQ0FBQyxDQUFDOzs7Ozs7O3lDQUVsRCxJQUFJLENBQUMsWUFBWSxDQUFDLFdBQVcsQ0FBQyxNQUFNLENBQUM7Ozs7Ozs7Ozs7Q0FHdkQsQ0FBQzs7QUFFRixRQUFRLENBQUMsWUFBWSxHQUFHLG9CQUFnQixNQUFNLEVBQUUsSUFBSSxFQUFFLFNBQVM7TUFLekQsT0FBTyxFQUNQLElBQUksRUFJSixRQUFRLEVBRU4sVUFBVSxFQU9aLFdBQVcsRUFHVCxXQUFXLEVBQ1gsU0FBUzs7OztZQXRCVixJ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dEQsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTOzs7Ozs7eUNBQ2YsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxFQUFFOzs7O3lDQUU3QiwwQ0FBaUIsSUFBSSxDQUFDLElBQUksQ0FBQyxzQkFBc0IsRUFBRSxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQzs7Ozs7OztDQUN6RSxDQUFDOztBQUVGLFFBQVEsQ0FBQyxhQUFhLEdBQUcsb0JBQWdCLGFBQWE7TUFBRSxJQUFJLHlEQUFDLEVBQUU7Ozs7Y0FFekQsYUFBYSxLQUFLLFFBQVEsQ0FBQTs7Ozs7O3lDQUN0QixJQUFJLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQzs7Ozs7OztjQUV2QixJQUFJLHlCQUFPLG1CQUFtQixDQUFDLDJFQUEyRSxDQUFDOzs7Ozs7O0NBRXBILENBQUM7O0FBRUYsZUFBYyxVQUFVLEVBQUUsUUFBUSxFQUFFLE9BQU8sQ0FBQyxDQUFDO1FBQ3BDLFFBQVEsR0FBUixRQUFRO1FBQUUsT0FBTyxHQUFQLE9BQU87cUJBQ1gsVUFBVSIsImZpbGUiOiJsaWIvY29tbWFuZHMvZXhlY3V0ZS5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGVycm9ycywgZXJyb3JGcm9tQ29kZSB9IGZyb20gJ2FwcGl1bS1iYXNlLWRyaXZlcic7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHVybCBmcm9tICd1cmwnO1xuaW1wb3J0IHsgdXRpbCB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcbmltcG9ydCBsb2dnZXIgZnJvbSAnLi4vbG9nZ2VyJztcbmltcG9ydCB7IGluc3RhbGxTU0xDZXJ0LCB1bmluc3RhbGxTU0xDZXJ0IH0gZnJvbSAnYXBwaXVtLWlvcy1zaW11bGF0b3InO1xuaW1wb3J0IHsgc3RhcnRIdHRwc1NlcnZlciB9IGZyb20gJy4uL3NlcnZlcic7XG5cblxubGV0IGNvbW1hbmRzID0ge30sIGhlbHBlcnMgPSB7fSwgZXh0ZW5zaW9ucyA9IHt9O1xuXG5jb21tYW5kcy5leGVjdXRlID0gYXN5bmMgZnVuY3Rpb24gKHNjcmlwdCwgYXJncykge1xuICBpZiAoc2NyaXB0Lm1hdGNoKC9ebW9iaWxlXFw6LykpIHtcbiAgICBzY3JpcHQgPSBzY3JpcHQucmVwbGFjZSgvXm1vYmlsZVxcOi8sICcnKS50cmltKCk7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMuZXhlY3V0ZU1vYmlsZShzY3JpcHQsIF8uaXNBcnJheShhcmdzKSA/IGFyZ3NbMF0gOiBhcmdzKTtcbiAgfSBlbHNlIHtcbiAgICBpZiAodGhpcy5pc1dlYkNvbnRleHQoKSkge1xuICAgICAgYXJncyA9IHRoaXMuY29udmVydEVsZW1lbnRzRm9yQXRvbXMoYXJncyk7XG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy5leGVjdXRlQXRvbSgnZXhlY3V0ZV9zY3JpcHQnLCBbc2NyaXB0LCBhcmdzXSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBhd2FpdCB0aGlzLnVpQXV0b0NsaWVudC5zZW5kQ29tbWFuZChzY3JpcHQpO1xuICAgIH1cbiAgfVxufTtcblxuY29tbWFuZHMuZXhlY3V0ZUFzeW5jID0gYXN5bmMgZnVuY3Rpb24gKHNjcmlwdCwgYXJncywgc2Vzc2lvbklkKSB7XG4gIGlmICghdGhpcy5pc1dlYkNvbnRleHQoKSkge1xuICAgIHJldHVybiBhd2FpdCB0aGlzLnVpQXV0b0NsaWVudC5zZW5kQ29tbWFuZChzY3JpcHQpO1xuICB9XG5cbiAgbGV0IGFkZHJlc3MgPSB0aGlzLm9wdHMuY2FsbGJhY2tBZGRyZXNzIHx8IHRoaXMub3B0cy5hZGRyZXNzO1xuICBsZXQgcG9ydCA9IHRoaXMub3B0cy5jYWxsYmFja1BvcnQgfHwgdGhpcy5vcHRzLnBvcnQ7XG4gIHNlc3Npb25JZCA9IHNlc3Npb25JZCB8fCB0aGlzLnNlc3Npb25JZDtcblxuICAvLyBodHRwcyBzaXRlcyBuZWVkIHRvIHJlcGx5IHRvIGFuIGh0dHBzIGVuZHBvaW50LCBpbiBTYWZhcmlcbiAgbGV0IHByb3RvY29sID0gJ2h0dHA6JztcbiAgdHJ5IHtcbiAgICBsZXQgY3VycmVudFVybCA9IHVybC5wYXJzZShhd2FpdCB0aGlzLmdldFVybCgpKTtcbiAgICBpZiAoY3VycmVudFVybC5wcm90b2NvbCA9PT0gJ2h0dHBzOicgJiYgdGhpcy5vcHRzLmh0dHBzQ2FsbGJhY2tQb3J0ICYmIHRoaXMub3B0cy5odHRwc0NhbGxiYWNrQWRkcmVzcykge1xuICAgICAgcHJvdG9jb2wgPSBjdXJyZW50VXJsLnByb3RvY29sO1xuICAgICAgcG9ydCA9IHRoaXMub3B0cy5odHRwc0NhbGxiYWNrUG9ydDtcbiAgICAgIGFkZHJlc3MgPSB0aGlzLm9wdHMuaHR0cHNDYWxsYmFja0FkZHJlc3M7XG4gICAgfVxuICB9IGNhdGNoIChpZ24pIHt9XG4gIGxldCByZXNwb25zZVVybCA9IGAke3Byb3RvY29sfS8vJHthZGRyZXNzfToke3BvcnR9L3dkL2h1Yi9zZXNzaW9uLyR7c2Vzc2lvbklkfS9yZWNlaXZlX2FzeW5jX3Jlc3BvbnNlYDtcblxuICBpZiAodGhpcy5pc1JlYWxEZXZpY2UoKSkge1xuICAgIGxldCBkZWZhdWx0SG9zdCA9IHRoaXMub3B0cy5hZGRyZXNzO1xuICAgIGxldCB1cmxPYmplY3QgPSB1cmwucGFyc2UocmVzcG9uc2VVcmwpO1xuICAgIGlmICh1cmxPYmplY3QuaG9zdG5hbWUgPT09IGRlZmF1bHRIb3N0KSB7XG4gICAgICBsb2dnZXIuZGVidWcoJ1JlYWwgZGV2aWNlIHNhZmFyaSB0ZXN0IGFuZCBubyBjdXN0b20gY2FsbGJhY2sgYWRkcmVzcyAnICtcbiAgICAgICAgICAgICAgICAgICAnc2V0LCBjaGFuZ2luZyBjYWxsYmFjayBhZGRyZXNzIHRvIGxvY2FsIGlwLicpO1xuICAgICAgdXJsT2JqZWN0Lmhvc3RuYW1lID0gdXRpbC5sb2NhbElwKCk7XG4gICAgICB1cmxPYmplY3QuaG9zdCA9IG51bGw7IC8vIHNldCB0byBudWxsLCBvdGhlcndpc2UgaG9zdG5hbWUgaXMgaWdub3JlZFxuICAgICAgcmVzcG9uc2VVcmwgPSB1cmwuZm9ybWF0KHVybE9iamVjdCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGxvZ2dlci5kZWJ1ZygnQ3VzdG9tIGNhbGxiYWNrIGFkZHJlc3Mgc2V0LCBsZWF2aW5nIGFzIGlzLicpO1xuICAgIH1cbiAgfVxuXG4gIGxvZ2dlci5kZWJ1ZyhgUmVzcG9uc2UgdXJsIGZvciBleGVjdXRlQXN5bmM6ICR7cmVzcG9uc2VVcmx9YCk7XG4gIGFyZ3MgPSB0aGlzLmNvbnZlcnRFbGVtZW50c0ZvckF0b21zKGFyZ3MpO1xuICB0aGlzLmFzeW5jV2FpdE1zID0gdGhpcy5hc3luY1dhaXRNcyB8fCAwO1xuICByZXR1cm4gYXdhaXQgdGhpcy5leGVjdXRlQXRvbUFzeW5jKCdleGVjdXRlX2FzeW5jX3NjcmlwdCcsIFtzY3JpcHQsIGFyZ3MsIHRoaXMuYXN5bmNXYWl0TXNdLCByZXNwb25zZVVybCk7XG59O1xuXG5jb21tYW5kcy5yZWNlaXZlQXN5bmNSZXNwb25zZSA9IGFzeW5jIGZ1bmN0aW9uIChzdGF0dXMsIHZhbHVlKSB7XG4gIGxvZ2dlci5kZWJ1ZyhgUmVjZWl2ZWQgYXN5bmMgcmVzcG9uc2U6ICR7SlNPTi5zdHJpbmdpZnkodmFsdWUpfWApO1xuICBpZiAoIV8uaXNOdWxsKHRoaXMuYXN5bmNQcm9taXNlKSAmJiAhXy5pc1VuZGVmaW5lZCh0aGlzLmFzeW5jUHJvbWlzZSkpIHtcbiAgICBpZiAoc3RhdHVzICE9PSAwKSB7XG4gICAgICB0aGlzLmFzeW5jUHJvbWlzZS5yZWplY3QoZXJyb3JGcm9tQ29kZShzdGF0dXMsIHZhbHVlLm1lc3NhZ2UpKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5hc3luY1Byb21pc2UucmVzb2x2ZSh2YWx1ZSk7XG4gICAgfVxuICB9IGVsc2Uge1xuICAgIGxvZ2dlci53YXJuKGBSZWNlaXZlZCBhc3luYyByZXNwb25zZSB3aGVuIHdlIHdlcmUgbm90IGV4cGVjdGluZyBvbmUhIGAgK1xuICAgICAgICAgICAgICAgIGBSZXNwb25zZSB3YXM6ICR7SlNPTi5zdHJpbmdpZnkodmFsdWUpfWApO1xuICB9XG59O1xuXG5oZWxwZXJzLnN0YXJ0SHR0cHNBc3luY1NlcnZlciA9IGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgbG9nZ2VyLmRlYnVnKCdTdGFydGluZyBodHRwcyBzZXJ2ZXIgZm9yIGFzeW5jIHJlc3BvbnNlcycpO1xuICBsZXQgYWRkcmVzcyA9IHRoaXMub3B0cy5jYWxsYmFja0FkZHJlc3MgfHwgdGhpcy5vcHRzLmFkZHJlc3M7XG4gIGxldCBwb3J0ID0gdGhpcy5vcHRzLmNhbGxiYWNrUG9ydCB8fCB0aGlzLm9wdHMucG9ydDtcbiAgbGV0IHtzc2xTZXJ2ZXIsIHBlbUNlcnRpZmljYXRlLCBodHRwc1BvcnR9ID0gYXdhaXQgc3RhcnRIdHRwc1NlcnZlcihwb3J0LCBhZGRyZXNzKTtcbiAgdGhpcy5vcHRzLnNzbFNlcnZlciA9IHNzbFNlcnZlcjtcbiAgdGhpcy5vcHRzLmh0dHBzU2VydmVyQ2VydGlmaWNhdGUgPSBwZW1DZXJ0aWZpY2F0ZTtcbiAgdGhpcy5vcHRzLmh0dHBzQ2FsbGJhY2tQb3J0ID0gaHR0cHNQb3J0O1xuICB0aGlzLm9wdHMuaHR0cHNDYWxsYmFja0FkZHJlc3MgPSAnbG9jYWxob3N0JztcbiAgbGV0IHVkaWQ7XG4gIGlmICh0aGlzLnNpbSkge1xuICAgIC8vIGlvcyBkcml2ZXJcbiAgICB1ZGlkID0gdGhpcy5zaW0udWRpZDtcbiAgfSBlbHNlIHtcbiAgICAvLyB4Y3VpdGVzdCBkcml2ZXJcbiAgICB1ZGlkID0gdGhpcy5vcHRzLnVkaWQ7XG4gIH1cbiAgYXdhaXQgaW5zdGFsbFNTTENlcnQodGhpcy5vcHRzLmh0dHBzU2VydmVyQ2VydGlmaWNhdGUsIHVkaWQpO1xufTtcblxuaGVscGVycy5zdG9wSHR0cHNBc3luY1NlcnZlciA9IGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgbG9nZ2VyLmRlYnVnKCdTdG9wcGluZyBodHRwcyBzZXJ2ZXIgZm9yIGFzeW5jIHJlc3BvbnNlcycpO1xuICBpZiAodGhpcy5vcHRzLnNzbFNlcnZlcikge1xuICAgIGF3YWl0IHRoaXMub3B0cy5zc2xTZXJ2ZXIuY2xvc2UoKTtcbiAgfVxuICBhd2FpdCB1bmluc3RhbGxTU0xDZXJ0KHRoaXMub3B0cy5odHRwc1NlcnZlckNlcnRpZmljYXRlLCB0aGlzLm9wdHMudWRpZCk7XG59O1xuXG5jb21tYW5kcy5leGVjdXRlTW9iaWxlID0gYXN5bmMgZnVuY3Rpb24gKG1vYmlsZUNvbW1hbmQsIG9wdHM9e30pIHtcbiAgLy8gd2Ugb25seSBzdXBwb3J0IG1vYmlsZTogc2Nyb2xsXG4gIGlmIChtb2JpbGVDb21tYW5kID09PSAnc2Nyb2xsJykge1xuICAgIGF3YWl0IHRoaXMubW9iaWxlU2Nyb2xsKG9wdHMpO1xuICB9IGVsc2Uge1xuICAgIHRocm93IG5ldyBlcnJvcnMuVW5rbm93bkNvbW1hbmRFcnJvcignVW5rbm93biBjb21tYW5kLCBhbGwgdGhlIG1vYmlsZSBjb21tYW5kcyBleGNlcHQgc2Nyb2xsIGhhdmUgYmVlbiByZW1vdmVkLicpO1xuICB9XG59O1xuXG5PYmplY3QuYXNzaWduKGV4dGVuc2lvbnMsIGNvbW1hbmRzLCBoZWxwZXJzKTtcbmV4cG9ydCB7IGNvbW1hbmRzLCBoZWxwZXJzIH07XG5leHBvcnQgZGVmYXVsdCBleHRlbnNpb25zO1xuIl0sInNvdXJjZVJvb3QiOiIuLi8uLi8uLiJ9
