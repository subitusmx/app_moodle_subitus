'use strict';

var _get = require('babel-runtime/helpers/get')['default'];

var _inherits = require('babel-runtime/helpers/inherits')['default'];

var _createClass = require('babel-runtime/helpers/create-class')['default'];

var _classCallCheck = require('babel-runtime/helpers/class-call-check')['default'];

var _slicedToArray = require('babel-runtime/helpers/sliced-to-array')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _Object$assign = require('babel-runtime/core-js/object/assign')['default'];

var _getIterator = require('babel-runtime/core-js/get-iterator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _appiumBaseDriver = require('appium-base-driver');

var _utils = require('./utils');

var _utils2 = _interopRequireDefault(_utils);

var _logger = require('./logger');

var _logger2 = _interopRequireDefault(_logger);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

var _appiumSupport = require('appium-support');

var _appiumIosSimulator = require('appium-ios-simulator');

var _uiautoUiauto = require('./uiauto/uiauto');

var _instruments = require('./instruments');

var _asyncbox = require('asyncbox');

var _commandsIndex = require('./commands/index');

var _commandsIndex2 = _interopRequireDefault(_commandsIndex);

var _desiredCaps = require('./desired-caps');

var _nodeIdevice = require('node-idevice');

var _nodeIdevice2 = _interopRequireDefault(_nodeIdevice);

var _commandsSafari = require('./commands/safari');

var _safariLauncher = require('./safari-launcher');

var _settings = require('./settings');

var _device = require('./device');

var _iwdp = require('./iwdp');

// promisify _iDevice
var iDevice = function iDevice() {
  var device = _nodeIdevice2['default'].apply(undefined, arguments);
  var promisified = {};
  var _arr = ['install', 'installAndWait', 'remove', 'isInstalled'];
  for (var _i = 0; _i < _arr.length; _i++) {
    var m = _arr[_i];
    promisified[m] = _bluebird2['default'].promisify(device[m].bind(device));
  }
  return promisified;
};

var defaultServerCaps = {
  webStorageEnabled: false,
  locationContextEnabled: false,
  browserName: '',
  platform: 'MAC',
  javascriptEnabled: true,
  databaseEnabled: false,
  takesScreenshot: true,
  networkConnectionEnabled: false
};

var LOG_LOCATIONS = [_path2['default'].resolve('/', 'Library', 'Caches', 'com.apple.dt.instruments')];
if (process.env.HOME) {
  LOG_LOCATIONS.push(_path2['default'].resolve(process.env.HOME, 'Library', 'Logs', 'CoreSimulator'));
}

var IosDriver = (function (_BaseDriver) {
  _inherits(IosDriver, _BaseDriver);

  _createClass(IosDriver, [{
    key: 'resetIos',
    value: function resetIos() {
      this.appExt = ".app";
      this.xcodeVersion = null;
      this.iosSdkVersion = null;
      this.logs = {};
      this.instruments = null;
      this.uiAutoClient = null;
      this.onInstrumentsDie = function () {};
      this.stopping = false;
      this.cbForCurrentCmd = null;
      this.remote = null;
      this.curContext = null;
      this.curWebFrames = [];
      this.selectingNewPage = false;
      this.windowHandleCache = [];
      this.webElementIds = [];
      this.implicitWaitMs = 0;
      this.asynclibWaitMs = 0;
      this.pageLoadMs = 6000;
      this.asynclibResponseCb = null;
      this.returnedFromExecuteAtom = {};
      this.executedAtomsCounter = 0;
      this.curCoords = null;
      this.curWebCoords = null;
      this.landscapeWebCoordsOffset = 0;
      this.keepAppToRetainPrefs = false;
      this.ready = false;
      this.asyncWaitMs = 0;

      this.settings = new _appiumBaseDriver.DeviceSettings({}, _lodash2['default'].noop);

      this.locatorStrategies = ['xpath', 'id', 'class name', '-ios uiautomation', 'accessibility id'];
      this.webLocatorStrategies = ['link text', 'css selector', 'tag name', 'partial link text'];
    }
  }]);

  function IosDriver(opts, shouldValidateCaps) {
    _classCallCheck(this, IosDriver);

    _get(Object.getPrototypeOf(IosDriver.prototype), 'constructor', this).call(this, opts, shouldValidateCaps);

    this.desiredCapConstraints = _desiredCaps.desiredCapConstraints;
    this.resetIos();
  }

  _createClass(IosDriver, [{
    key: 'validateLocatorStrategy',
    value: function validateLocatorStrategy(strategy) {
      _get(Object.getPrototypeOf(IosDriver.prototype), 'validateLocatorStrategy', this).call(this, strategy, this.isWebContext());
    }
  }, {
    key: 'start',
    value: function start() {
      return _regeneratorRuntime.async(function start$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            if (!this.isRealDevice()) {
              context$2$0.next = 5;
              break;
            }

            context$2$0.next = 3;
            return _regeneratorRuntime.awrap(this.startRealDevice());

          case 3:
            context$2$0.next = 7;
            break;

          case 5:
            context$2$0.next = 7;
            return _regeneratorRuntime.awrap(this.startSimulator());

          case 7:
            this.ready = true;

          case 8:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'createSession',
    value: function createSession() {
      for (var _len = arguments.length, args = Array(_len), _key = 0; _key < _len; _key++) {
        args[_key] = arguments[_key];
      }

      var _ref, _ref2, sessionId, caps, msg;

      return _regeneratorRuntime.async(function createSession$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(_get(Object.getPrototypeOf(IosDriver.prototype), 'createSession', this).apply(this, args));

          case 2:
            _ref = context$2$0.sent;
            _ref2 = _slicedToArray(_ref, 2);
            sessionId = _ref2[0];
            caps = _ref2[1];
            context$2$0.next = 8;
            return _regeneratorRuntime.awrap(_utils2['default'].getAndCheckXcodeVersion(this.opts));

          case 8:
            this.xcodeVersion = context$2$0.sent;

            _logger2['default'].debug('Xcode version set to ' + this.xcodeVersion.versionString);
            if (this.xcodeVersion.major >= 8) {
              msg = 'Appium\'s IosDriver does not support xcode version ' + this.xcodeVersion.versionString + '. ' + 'Apple has deprecated UIAutomation. Use the "XCUITest" automationName capability instead.';

              _logger2['default'].errorAndThrow(new _appiumBaseDriver.errors.SessionNotCreatedError(msg));
            }

            // merge server capabilities + desired capabilities
            this.caps = _Object$assign({}, defaultServerCaps, this.caps);
            this.caps.desired = caps;

            context$2$0.next = 15;
            return _regeneratorRuntime.awrap(_utils2['default'].detectUdid(this.opts));

          case 15:
            context$2$0.next = 17;
            return _regeneratorRuntime.awrap(_utils2['default'].prepareIosOpts(this.opts));

          case 17:
            this.realDevice = null;
            this.useRobot = this.opts.useRobot;
            this.safari = this.opts.safari;
            this.opts.curOrientation = this.opts.initialOrientation;

            this.sock = _path2['default'].resolve(this.opts.tmpDir || '/tmp', 'instruments_sock');

            context$2$0.prev = 22;
            context$2$0.next = 25;
            return _regeneratorRuntime.awrap(this.configureApp());

          case 25:
            context$2$0.next = 31;
            break;

          case 27:
            context$2$0.prev = 27;
            context$2$0.t0 = context$2$0['catch'](22);

            _logger2['default'].error('Bad app: \'' + this.opts.app + '\'. App paths need to ' + 'be absolute, or relative to the appium server ' + 'install dir, or a URL to compressed file, or a ' + 'special app name.');
            throw context$2$0.t0;

          case 31:
            context$2$0.next = 33;
            return _regeneratorRuntime.awrap(this.start());

          case 33:

            // TODO: this should be in BaseDriver.postCreateSession
            this.startNewCommandTimeout('createSession');
            return context$2$0.abrupt('return', [sessionId, this.caps]);

          case 35:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[22, 27]]);
    }
  }, {
    key: 'stop',
    value: function stop() {
      return _regeneratorRuntime.async(function stop$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            this.ready = false;

            if (!this.uiAutoClient) {
              context$2$0.next = 4;
              break;
            }

            context$2$0.next = 4;
            return _regeneratorRuntime.awrap(this.uiAutoClient.shutdown());

          case 4:
            if (!this.instruments) {
              context$2$0.next = 13;
              break;
            }

            context$2$0.prev = 5;
            context$2$0.next = 8;
            return _regeneratorRuntime.awrap(this.instruments.shutdown());

          case 8:
            context$2$0.next = 13;
            break;

          case 10:
            context$2$0.prev = 10;
            context$2$0.t0 = context$2$0['catch'](5);

            _logger2['default'].error('Instruments didn\'t shut down. ' + context$2$0.t0);

          case 13:
            if (!(this.caps && this.caps.customSSLCert && !this.isRealDevice())) {
              context$2$0.next = 17;
              break;
            }

            _logger2['default'].debug('Uninstalling ssl certificate for udid \'' + this.sim.udid + '\'');
            context$2$0.next = 17;
            return _regeneratorRuntime.awrap((0, _appiumIosSimulator.uninstallSSLCert)(this.caps.customSSLCert, this.sim.udid));

          case 17:
            if (!(this.opts.enableAsyncExecuteFromHttps && !this.isRealDevice())) {
              context$2$0.next = 20;
              break;
            }

            context$2$0.next = 20;
            return _regeneratorRuntime.awrap(this.stopHttpsAsyncServer());

          case 20:

            this.uiAutoClient = null;
            this.instruments = null;
            this.realDevice = null;

            // postcleanup
            this.curCoords = null;
            this.opts.curOrientation = null;

            if (_lodash2['default'].isEmpty(this.logs)) {
              context$2$0.next = 29;
              break;
            }

            context$2$0.next = 28;
            return _regeneratorRuntime.awrap(this.logs.syslog.stopCapture());

          case 28:
            this.logs = {};

          case 29:
            if (!this.remote) {
              context$2$0.next = 32;
              break;
            }

            context$2$0.next = 32;
            return _regeneratorRuntime.awrap(this.stopRemote());

          case 32:
            context$2$0.next = 34;
            return _regeneratorRuntime.awrap(this.stopIWDP());

          case 34:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[5, 10]]);
    }
  }, {
    key: 'deleteSession',
    value: function deleteSession() {
      return _regeneratorRuntime.async(function deleteSession$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            _logger2['default'].debug("Deleting ios session");

            context$2$0.next = 3;
            return _regeneratorRuntime.awrap(this.stop());

          case 3:
            if (!this.opts.clearSystemFiles) {
              context$2$0.next = 8;
              break;
            }

            context$2$0.next = 6;
            return _regeneratorRuntime.awrap(_utils2['default'].clearLogs(LOG_LOCATIONS));

          case 6:
            context$2$0.next = 9;
            break;

          case 8:
            _logger2['default'].debug('Not clearing log files. Use `clearSystemFiles` capability to turn on.');

          case 9:
            if (!this.isRealDevice()) {
              context$2$0.next = 14;
              break;
            }

            context$2$0.next = 12;
            return _regeneratorRuntime.awrap((0, _device.runRealDeviceReset)(this.realDevice, this.opts));

          case 12:
            context$2$0.next = 16;
            break;

          case 14:
            context$2$0.next = 16;
            return _regeneratorRuntime.awrap((0, _device.runSimulatorReset)(this.sim, this.opts, this.keepAppToRetainPrefs));

          case 16:
            context$2$0.next = 18;
            return _regeneratorRuntime.awrap(_get(Object.getPrototypeOf(IosDriver.prototype), 'deleteSession', this).call(this));

          case 18:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'executeCommand',
    value: function executeCommand(cmd) {
      for (var _len2 = arguments.length, args = Array(_len2 > 1 ? _len2 - 1 : 0), _key2 = 1; _key2 < _len2; _key2++) {
        args[_key2 - 1] = arguments[_key2];
      }

      var _get2;

      return _regeneratorRuntime.async(function executeCommand$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            _logger2['default'].debug('Executing iOS command \'' + cmd + '\'');

            if (!(cmd === 'receiveAsyncResponse')) {
              context$2$0.next = 7;
              break;
            }

            context$2$0.next = 4;
            return _regeneratorRuntime.awrap(this.receiveAsyncResponse.apply(this, args));

          case 4:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 7:
            if (!(this.ready || _lodash2['default'].includes(['launchApp'], cmd))) {
              context$2$0.next = 11;
              break;
            }

            context$2$0.next = 10;
            return _regeneratorRuntime.awrap((_get2 = _get(Object.getPrototypeOf(IosDriver.prototype), 'executeCommand', this)).call.apply(_get2, [this, cmd].concat(args)));

          case 10:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 11:
            throw new _appiumBaseDriver.errors.NoSuchDriverError('Driver is not ready, cannot execute ' + cmd + '.');

          case 12:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }

    // TODO: reformat this.helpers + configureApp
  }, {
    key: 'configureApp',
    value: function configureApp() {
      return _regeneratorRuntime.async(function configureApp$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.prev = 0;

            // if the app name is a bundleId assign it to the bundleId property
            if (!this.opts.bundleId && _utils2['default'].appIsPackageOrBundle(this.opts.app)) {
              this.opts.bundleId = this.opts.app;
            }

            if (!(this.opts.app && this.opts.app.toLowerCase() === "settings")) {
              context$2$0.next = 6;
              break;
            }

            if (parseFloat(this.opts.platformVersion) >= 8) {
              _logger2['default'].debug("We are on iOS8+ so not copying preferences app");
              this.opts.bundleId = "com.apple.Preferences";
              this.opts.app = null;
            }
            context$2$0.next = 34;
            break;

          case 6:
            if (!(this.opts.app && this.opts.app.toLowerCase() === "calendar")) {
              context$2$0.next = 10;
              break;
            }

            if (parseFloat(this.opts.platformVersion) >= 8) {
              _logger2['default'].debug("We are on iOS8+ so not copying calendar app");
              this.opts.bundleId = "com.apple.mobilecal";
              this.opts.app = null;
            }
            context$2$0.next = 34;
            break;

          case 10:
            if (!this.isSafari()) {
              context$2$0.next = 27;
              break;
            }

            if (this.isRealDevice()) {
              context$2$0.next = 15;
              break;
            }

            if (parseFloat(this.opts.platformVersion) >= 8) {
              _logger2['default'].debug("We are on iOS8+ so not copying Safari app");
              this.opts.bundleId = _commandsSafari.SAFARI_BUNDLE;
              this.opts.app = null;
            }
            context$2$0.next = 25;
            break;

          case 15:
            context$2$0.next = 17;
            return _regeneratorRuntime.awrap(this.realDevice.isInstalled(this.opts.bundleId));

          case 17:
            if (context$2$0.sent) {
              context$2$0.next = 25;
              break;
            }

            context$2$0.next = 20;
            return _regeneratorRuntime.awrap((0, _safariLauncher.needsInstall)());

          case 20:
            if (!context$2$0.sent) {
              context$2$0.next = 24;
              break;
            }

            _logger2['default'].debug('SafariLauncher not found, building...');
            context$2$0.next = 24;
            return _regeneratorRuntime.awrap((0, _safariLauncher.install)());

          case 24:
            this.opts.bundleId = _safariLauncher.SAFARI_LAUNCHER_BUNDLE;

          case 25:
            context$2$0.next = 34;
            break;

          case 27:
            if (!(this.opts.bundleId && _utils2['default'].appIsPackageOrBundle(this.opts.bundleId) && (this.opts.app === "" || _utils2['default'].appIsPackageOrBundle(this.opts.app)))) {
              context$2$0.next = 31;
              break;
            }

            // we have a bundle ID, but no app, or app is also a bundle
            _logger2['default'].debug("App is an iOS bundle, will attempt to run as pre-existing");
            context$2$0.next = 34;
            break;

          case 31:
            context$2$0.next = 33;
            return _regeneratorRuntime.awrap(this.helpers.configureApp(this.opts.app, '.app'));

          case 33:
            this.opts.app = context$2$0.sent;

          case 34:
            context$2$0.next = 40;
            break;

          case 36:
            context$2$0.prev = 36;
            context$2$0.t0 = context$2$0['catch'](0);

            _logger2['default'].error(context$2$0.t0);
            throw new Error('Bad app: ' + this.opts.app + '. App paths need to be absolute, or relative to the appium ' + "server install dir, or a URL to compressed file, or a special app name.");

          case 40:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[0, 36]]);
    }
  }, {
    key: 'startSimulator',
    value: function startSimulator() {
      var timeout, availableDevices, iosSimUdid, dString;
      return _regeneratorRuntime.async(function startSimulator$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(_utils2['default'].removeInstrumentsSocket(this.sock));

          case 2:
            if (this.xcodeVersion) {
              context$2$0.next = 8;
              break;
            }

            _logger2['default'].debug("Setting Xcode version");
            context$2$0.next = 6;
            return _regeneratorRuntime.awrap(_utils2['default'].getAndCheckXcodeVersion(this.opts));

          case 6:
            this.xcodeVersion = context$2$0.sent;

            _logger2['default'].debug('Xcode version set to ' + this.xcodeVersion.versionString);

          case 8:

            _logger2['default'].debug("Setting iOS SDK Version");
            context$2$0.next = 11;
            return _regeneratorRuntime.awrap(_utils2['default'].getAndCheckIosSdkVersion());

          case 11:
            this.iosSdkVersion = context$2$0.sent;

            _logger2['default'].debug('iOS SDK Version set to ' + this.iosSdkVersion);

            timeout = _lodash2['default'].isObject(this.opts.launchTimeout) ? this.opts.launchTimeout.global : this.opts.launchTimeout;
            context$2$0.next = 16;
            return _regeneratorRuntime.awrap((0, _asyncbox.retry)(3, _instruments.instrumentsUtils.getAvailableDevices, timeout));

          case 16:
            availableDevices = context$2$0.sent;
            context$2$0.next = 19;
            return _regeneratorRuntime.awrap((0, _device.checkSimulatorAvailable)(this.opts, this.iosSdkVersion, availableDevices));

          case 19:
            iosSimUdid = context$2$0.sent;
            context$2$0.next = 22;
            return _regeneratorRuntime.awrap((0, _appiumIosSimulator.getSimulator)(iosSimUdid, this.xcodeVersion.versionString));

          case 22:
            this.sim = context$2$0.sent;
            context$2$0.next = 25;
            return _regeneratorRuntime.awrap((0, _device.moveBuiltInApp)(this.sim));

          case 25:
            context$2$0.next = 27;
            return _regeneratorRuntime.awrap(_utils2['default'].parseLocalizableStrings(this.opts));

          case 27:
            context$2$0.next = 29;
            return _regeneratorRuntime.awrap(_utils2['default'].setBundleIdFromApp(this.opts));

          case 29:
            context$2$0.next = 31;
            return _regeneratorRuntime.awrap(this.createInstruments());

          case 31:
            // previously setDeviceInfo()
            this.shouldPrelaunchSimulator = _utils2['default'].shouldPrelaunchSimulator(this.opts, this.iosSdkVersion);
            context$2$0.next = 34;
            return _regeneratorRuntime.awrap((0, _device.getAdjustedDeviceName)(this.opts));

          case 34:
            dString = context$2$0.sent;

            if (!this.caps.app) {
              context$2$0.next = 38;
              break;
            }

            context$2$0.next = 38;
            return _regeneratorRuntime.awrap(_utils2['default'].setDeviceTypeInInfoPlist(this.opts.app, dString));

          case 38:
            context$2$0.next = 40;
            return _regeneratorRuntime.awrap((0, _device.runSimulatorReset)(this.sim, this.opts, this.keepAppToRetainPrefs));

          case 40:
            if (!(this.caps.customSSLCert && !this.isRealDevice())) {
              context$2$0.next = 43;
              break;
            }

            context$2$0.next = 43;
            return _regeneratorRuntime.awrap((0, _appiumIosSimulator.installSSLCert)(this.caps.customSSLCert, this.sim.udid));

          case 43:
            if (!(this.opts.enableAsyncExecuteFromHttps && !this.isRealDevice())) {
              context$2$0.next = 46;
              break;
            }

            context$2$0.next = 46;
            return _regeneratorRuntime.awrap(this.startHttpsAsyncServer());

          case 46:
            context$2$0.next = 48;
            return _regeneratorRuntime.awrap((0, _device.isolateSimulatorDevice)(this.sim, this.opts));

          case 48:
            context$2$0.next = 50;
            return _regeneratorRuntime.awrap((0, _settings.setLocale)(this.sim, this.opts, this.localConfig, this.isSafari()));

          case 50:
            this.localConfig = context$2$0.sent;
            context$2$0.next = 53;
            return _regeneratorRuntime.awrap((0, _settings.setPreferences)(this.sim, this.opts, this.isSafari()));

          case 53:
            context$2$0.next = 55;
            return _regeneratorRuntime.awrap(this.startLogCapture(this.sim));

          case 55:
            context$2$0.next = 57;
            return _regeneratorRuntime.awrap(this.prelaunchSimulator());

          case 57:
            context$2$0.next = 59;
            return _regeneratorRuntime.awrap(this.startInstruments());

          case 59:
            context$2$0.next = 61;
            return _regeneratorRuntime.awrap(this.onInstrumentsLaunch());

          case 61:
            context$2$0.next = 63;
            return _regeneratorRuntime.awrap(this.configureBootstrap());

          case 63:
            context$2$0.next = 65;
            return _regeneratorRuntime.awrap(this.setBundleId());

          case 65:
            context$2$0.next = 67;
            return _regeneratorRuntime.awrap(this.setInitialOrientation());

          case 67:
            context$2$0.next = 69;
            return _regeneratorRuntime.awrap(this.initAutoWebview());

          case 69:
            context$2$0.next = 71;
            return _regeneratorRuntime.awrap(this.waitForAppLaunched());

          case 71:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'startRealDevice',
    value: function startRealDevice() {
      return _regeneratorRuntime.async(function startRealDevice$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(_utils2['default'].removeInstrumentsSocket(this.sock));

          case 2:
            context$2$0.next = 4;
            return _regeneratorRuntime.awrap(_utils2['default'].parseLocalizableStrings(this.opts));

          case 4:
            context$2$0.next = 6;
            return _regeneratorRuntime.awrap(_utils2['default'].setBundleIdFromApp(this.opts));

          case 6:
            context$2$0.next = 8;
            return _regeneratorRuntime.awrap(this.createInstruments());

          case 8:
            context$2$0.next = 10;
            return _regeneratorRuntime.awrap((0, _device.runRealDeviceReset)(this.realDevice, this.opts));

          case 10:
            context$2$0.next = 12;
            return _regeneratorRuntime.awrap(this.startLogCapture());

          case 12:
            context$2$0.next = 14;
            return _regeneratorRuntime.awrap(this.installToRealDevice());

          case 14:
            context$2$0.next = 16;
            return _regeneratorRuntime.awrap(this.startInstruments());

          case 16:
            context$2$0.next = 18;
            return _regeneratorRuntime.awrap(this.onInstrumentsLaunch());

          case 18:
            context$2$0.next = 20;
            return _regeneratorRuntime.awrap(this.configureBootstrap());

          case 20:
            context$2$0.next = 22;
            return _regeneratorRuntime.awrap(this.setBundleId());

          case 22:
            context$2$0.next = 24;
            return _regeneratorRuntime.awrap(this.setInitialOrientation());

          case 24:
            context$2$0.next = 26;
            return _regeneratorRuntime.awrap(this.initAutoWebview());

          case 26:
            context$2$0.next = 28;
            return _regeneratorRuntime.awrap(this.waitForAppLaunched());

          case 28:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'installToRealDevice',
    value: function installToRealDevice() {
      var ext, msg;
      return _regeneratorRuntime.async(function installToRealDevice$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            if (!(this.opts.autoLaunch === false)) {
              context$2$0.next = 2;
              break;
            }

            return context$2$0.abrupt('return');

          case 2:

            // if we have an ipa file, set it in opts
            if (this.opts.app) {
              ext = this.opts.app.substring(this.opts.app.length - 3).toLowerCase();

              if (ext === 'ipa') {
                this.opts.ipa = this.opts.app;
              }
            }

            if (!this.opts.udid) {
              context$2$0.next = 38;
              break;
            }

            context$2$0.next = 6;
            return _regeneratorRuntime.awrap(this.realDevice.isInstalled(this.opts.bundleId));

          case 6:
            if (!context$2$0.sent) {
              context$2$0.next = 16;
              break;
            }

            _logger2['default'].debug("App is installed.");

            if (!this.opts.fullReset) {
              context$2$0.next = 12;
              break;
            }

            _logger2['default'].debug("fullReset requested. Forcing app install.");
            context$2$0.next = 14;
            break;

          case 12:
            _logger2['default'].debug("fullReset not requested. No need to install.");
            return context$2$0.abrupt('return');

          case 14:
            context$2$0.next = 17;
            break;

          case 16:
            _logger2['default'].debug("App is not installed. Will try to install.");

          case 17:
            if (!(this.opts.ipa && this.opts.bundleId)) {
              context$2$0.next = 23;
              break;
            }

            context$2$0.next = 20;
            return _regeneratorRuntime.awrap(this.installIpa());

          case 20:
            _logger2['default'].debug('App installed.');
            context$2$0.next = 36;
            break;

          case 23:
            if (!this.opts.ipa) {
              context$2$0.next = 29;
              break;
            }

            msg = "You specified a UDID and ipa but did not include the bundle id";

            _logger2['default'].warn(msg);
            throw new _appiumBaseDriver.errors.UnknownError(msg);

          case 29:
            if (!this.opts.app) {
              context$2$0.next = 35;
              break;
            }

            context$2$0.next = 32;
            return _regeneratorRuntime.awrap(this.realDevice.install(this.opts.app));

          case 32:
            _logger2['default'].debug('App installed.');
            context$2$0.next = 36;
            break;

          case 35:
            _logger2['default'].debug("Real device specified but no ipa or app path, assuming bundle ID is " + "on device");

          case 36:
            context$2$0.next = 39;
            break;

          case 38:
            _logger2['default'].debug("No device id or app, not installing to real device.");

          case 39:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'getIDeviceObj',
    value: function getIDeviceObj() {
      var idiPath = _path2['default'].resolve(__dirname, "../../../build/", "libimobiledevice-macosx/ideviceinstaller");
      _logger2['default'].debug('Creating iDevice object with udid ' + this.opts.udid);
      try {
        return iDevice(this.opts.udid);
      } catch (e1) {
        _logger2['default'].debug('Couldn\'t find ideviceinstaller, trying built-in at ' + idiPath);
        try {
          return iDevice(this.opts.udid, { cmd: idiPath });
        } catch (e2) {
          var msg = "Could not initialize ideviceinstaller; make sure it is " + "installed and works on your system";
          _logger2['default'].error(msg);
          throw new Error(msg);
        }
      }
    }
  }, {
    key: 'installIpa',
    value: function installIpa() {
      return _regeneratorRuntime.async(function installIpa$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            _logger2['default'].debug('Installing ipa found at ' + this.opts.ipa);
            context$2$0.next = 3;
            return _regeneratorRuntime.awrap(this.realDevice.isInstalled(this.opts.bundleId));

          case 3:
            if (!context$2$0.sent) {
              context$2$0.next = 9;
              break;
            }

            _logger2['default'].debug("Bundle found on device, removing before reinstalling.");
            context$2$0.next = 7;
            return _regeneratorRuntime.awrap(this.realDevice.remove(this.opts.bundleId));

          case 7:
            context$2$0.next = 10;
            break;

          case 9:
            _logger2['default'].debug("Nothing found on device, going ahead and installing.");

          case 10:
            context$2$0.next = 12;
            return _regeneratorRuntime.awrap(this.realDevice.installAndWait(this.opts.ipa, this.opts.bundleId));

          case 12:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'validateDesiredCaps',
    value: function validateDesiredCaps(caps) {
      // check with the base class, and return if it fails
      var res = _get(Object.getPrototypeOf(IosDriver.prototype), 'validateDesiredCaps', this).call(this, caps);
      if (!res) return res; // eslint-disable-line curly

      return (0, _desiredCaps.desiredCapValidation)(caps);
    }
  }, {
    key: 'prelaunchSimulator',
    value: function prelaunchSimulator() {
      return _regeneratorRuntime.async(function prelaunchSimulator$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            if (this.shouldPrelaunchSimulator) {
              context$2$0.next = 3;
              break;
            }

            _logger2['default'].debug("Not pre-launching simulator");
            return context$2$0.abrupt('return');

          case 3:
            context$2$0.next = 5;
            return _regeneratorRuntime.awrap((0, _device.endSimulator)(this.sim));

          case 5:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'onInstrumentsLaunch',

    // TODO: implement prelaunch sim in simulator package
    value: function onInstrumentsLaunch() {
      return _regeneratorRuntime.async(function onInstrumentsLaunch$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            _logger2['default'].debug('Instruments launched. Starting poll loop for new commands.');

            if (!this.opts.origAppPath) {
              context$2$0.next = 6;
              break;
            }

            _logger2['default'].debug("Copying app back to its original place");
            context$2$0.next = 5;
            return _regeneratorRuntime.awrap(_appiumSupport.fs.copyFile(this.opts.app, this.opts.origAppPath));

          case 5:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 6:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'setBundleId',
    value: function setBundleId() {
      var bId;
      return _regeneratorRuntime.async(function setBundleId$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            if (!this.opts.bundleId) {
              context$2$0.next = 4;
              break;
            }

            return context$2$0.abrupt('return');

          case 4:
            context$2$0.next = 6;
            return _regeneratorRuntime.awrap(this.uiAutoClient.sendCommand('au.bundleId()'));

          case 6:
            bId = context$2$0.sent;

            _logger2['default'].debug('Bundle ID for open app is ' + bId.value);
            this.opts.bundleId = bId.value;

          case 9:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'startIWDP',
    value: function startIWDP() {
      return _regeneratorRuntime.async(function startIWDP$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            if (!this.opts.startIWDP) {
              context$2$0.next = 4;
              break;
            }

            this.iwdpServer = new _iwdp.IWDP(this.opts.webkitDebugProxyPort, this.opts.udid);
            context$2$0.next = 4;
            return _regeneratorRuntime.awrap(this.iwdpServer.start());

          case 4:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'stopIWDP',
    value: function stopIWDP() {
      return _regeneratorRuntime.async(function stopIWDP$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            if (!this.iwdpServer) {
              context$2$0.next = 4;
              break;
            }

            context$2$0.next = 3;
            return _regeneratorRuntime.awrap(this.iwdpServer.stop());

          case 3:
            delete this.iwdpServer;

          case 4:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'setInitialOrientation',
    value: function setInitialOrientation() {
      var command;
      return _regeneratorRuntime.async(function setInitialOrientation$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            if (!(typeof this.opts.initialOrientation === "string" && _lodash2['default'].includes(["LANDSCAPE", "PORTRAIT"], this.opts.initialOrientation.toUpperCase()))) {
              context$2$0.next = 12;
              break;
            }

            _logger2['default'].debug('Setting initial orientation to ' + this.opts.initialOrientation);
            command = 'au.setScreenOrientation(\'' + this.opts.initialOrientation.toUpperCase() + '\')';
            context$2$0.prev = 3;
            context$2$0.next = 6;
            return _regeneratorRuntime.awrap(this.uiAutoClient.sendCommand(command));

          case 6:
            this.opts.curOrientation = this.opts.initialOrientation;
            context$2$0.next = 12;
            break;

          case 9:
            context$2$0.prev = 9;
            context$2$0.t0 = context$2$0['catch'](3);

            _logger2['default'].warn('Setting initial orientation failed with: ' + context$2$0.t0);

          case 12:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[3, 9]]);
    }
  }, {
    key: 'isRealDevice',
    value: function isRealDevice() {
      return !!this.opts.udid;
    }
  }, {
    key: 'isSafari',
    value: function isSafari() {
      return this.opts.safari;
    }
  }, {
    key: 'waitForAppLaunched',
    value: function waitForAppLaunched() {
      var condFn;
      return _regeneratorRuntime.async(function waitForAppLaunched$(context$2$0) {
        var _this = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            condFn = undefined;

            if (!this.opts.waitForAppScript) {
              context$2$0.next = 6;
              break;
            }

            // the default getSourceForElementForXML does not fit some use case, so making this customizable.
            // TODO: collect script from customer and propose several options, please comment in issue #4190.
            _logger2['default'].debug('Using custom script to wait for app start: ' + this.opts.waitForAppScript);
            condFn = function callee$2$0() {
              var res;
              return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
                while (1) switch (context$3$0.prev = context$3$0.next) {
                  case 0:
                    res = undefined;
                    context$3$0.prev = 1;
                    context$3$0.next = 4;
                    return _regeneratorRuntime.awrap(this.uiAutoClient.sendCommand('try{\n' + this.opts.waitForAppScript + '\n} catch(err) { $.log("waitForAppScript err: " + error); false; };'));

                  case 4:
                    res = context$3$0.sent;
                    context$3$0.next = 11;
                    break;

                  case 7:
                    context$3$0.prev = 7;
                    context$3$0.t0 = context$3$0['catch'](1);

                    _logger2['default'].debug('Cannot eval waitForAppScript script, err: ' + context$3$0.t0);
                    return context$3$0.abrupt('return', false);

                  case 11:
                    if (!(typeof res !== 'boolean')) {
                      context$3$0.next = 14;
                      break;
                    }

                    _logger2['default'].debug('Unexpected return type in waitForAppScript script');
                    return context$3$0.abrupt('return', false);

                  case 14:
                    return context$3$0.abrupt('return', res);

                  case 15:
                  case 'end':
                    return context$3$0.stop();
                }
              }, null, _this, [[1, 7]]);
            };
            context$2$0.next = 18;
            break;

          case 6:
            if (!this.isSafari()) {
              context$2$0.next = 16;
              break;
            }

            if (!this.isRealDevice()) {
              context$2$0.next = 10;
              break;
            }

            context$2$0.next = 10;
            return _regeneratorRuntime.awrap(this.clickButtonToLaunchSafari());

          case 10:
            _logger2['default'].debug('Waiting for initial webview');
            context$2$0.next = 13;
            return _regeneratorRuntime.awrap(this.navToInitialWebview());

          case 13:
            condFn = function callee$2$0() {
              return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
                while (1) switch (context$3$0.prev = context$3$0.next) {
                  case 0:
                    return context$3$0.abrupt('return', true);

                  case 1:
                  case 'end':
                    return context$3$0.stop();
                }
              }, null, _this);
            };
            context$2$0.next = 18;
            break;

          case 16:
            _logger2['default'].debug("Waiting for app source to contain elements");
            condFn = function callee$2$0() {
              var source, appEls;
              return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
                while (1) switch (context$3$0.prev = context$3$0.next) {
                  case 0:
                    context$3$0.prev = 0;
                    context$3$0.next = 3;
                    return _regeneratorRuntime.awrap(this.getSourceForElementForXML());

                  case 3:
                    source = context$3$0.sent;

                    source = JSON.parse(source || "{}");
                    appEls = (source.UIAApplication || {})['>'];
                    return context$3$0.abrupt('return', appEls && appEls.length > 0 && !IosDriver.isSpringBoard(source.UIAApplication));

                  case 9:
                    context$3$0.prev = 9;
                    context$3$0.t0 = context$3$0['catch'](0);

                    _logger2['default'].warn('Couldn\'t extract app element from source, error was: ' + context$3$0.t0);
                    return context$3$0.abrupt('return', false);

                  case 13:
                  case 'end':
                    return context$3$0.stop();
                }
              }, null, _this, [[0, 9]]);
            };

          case 18:
            context$2$0.prev = 18;
            context$2$0.next = 21;
            return _regeneratorRuntime.awrap((0, _asyncbox.waitForCondition)(condFn, { logger: _logger2['default'], waitMs: 10000, intervalMs: 500 }));

          case 21:
            context$2$0.next = 31;
            break;

          case 23:
            context$2$0.prev = 23;
            context$2$0.t0 = context$2$0['catch'](18);

            if (!(context$2$0.t0.message && context$2$0.t0.message.match(/Condition unmet/))) {
              context$2$0.next = 30;
              break;
            }

            _logger2['default'].warn('Initial spin timed out, continuing but the app might not be ready.');
            _logger2['default'].debug('Initial spin error was: ' + context$2$0.t0);
            context$2$0.next = 31;
            break;

          case 30:
            throw context$2$0.t0;

          case 31:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[18, 23]]);
    }
  }, {
    key: 'createInstruments',
    value: function createInstruments() {
      return _regeneratorRuntime.async(function createInstruments$(context$2$0) {
        var _this2 = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            _logger2['default'].debug("Creating instruments");
            this.uiAutoClient = new _uiautoUiauto.UIAutoClient(this.sock);
            context$2$0.next = 4;
            return _regeneratorRuntime.awrap(this.makeInstruments());

          case 4:
            this.instruments = context$2$0.sent;

            this.instruments.onShutdown['catch'](function callee$2$0() {
              return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
                while (1) switch (context$3$0.prev = context$3$0.next) {
                  case 0:
                    context$3$0.next = 2;
                    return _regeneratorRuntime.awrap(this.startUnexpectedShutdown(new _appiumBaseDriver.errors.UnknownError('Abnormal Instruments termination!')));

                  case 2:
                  case 'end':
                    return context$3$0.stop();
                }
              }, null, _this2);
            }).done();

          case 6:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'shouldIgnoreInstrumentsExit',
    value: function shouldIgnoreInstrumentsExit() {
      return this.safari && this.isRealDevice();
    }
  }, {
    key: 'makeInstruments',
    value: function makeInstruments() {
      var bootstrapPath, instruments;
      return _regeneratorRuntime.async(function makeInstruments$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap((0, _uiautoUiauto.prepareBootstrap)({
              sock: this.sock,
              interKeyDelay: this.opts.interKeyDelay,
              justLoopInfinitely: false,
              autoAcceptAlerts: this.opts.autoAcceptAlerts,
              autoDismissAlerts: this.opts.autoDismissAlerts,
              sendKeyStrategy: this.opts.sendKeyStrategy || (this.isRealDevice() ? 'grouped' : 'oneByOne')
            }));

          case 2:
            bootstrapPath = context$2$0.sent;
            context$2$0.t0 = _instruments.Instruments;
            context$2$0.t1 = (!this.isRealDevice() ? this.opts.app : null) || this.opts.bundleId;
            context$2$0.t2 = this.opts.udid;
            context$2$0.t3 = this.opts.processArguments;
            context$2$0.t4 = this.shouldIgnoreInstrumentsExit();
            context$2$0.t5 = bootstrapPath;
            context$2$0.t6 = this.opts.automationTraceTemplatePath;
            context$2$0.t7 = this.opts.instrumentsPath;
            context$2$0.t8 = this.opts.withoutDelay;
            context$2$0.t9 = this.opts.platformVersion;
            context$2$0.t10 = this.opts.webSocket;
            context$2$0.t11 = this.opts.launchTimeout;
            context$2$0.t12 = this.opts.backendRetries;
            context$2$0.t13 = this.isRealDevice();

            if (!(this.iosSdkVersion >= 7.1)) {
              context$2$0.next = 23;
              break;
            }

            context$2$0.next = 20;
            return _regeneratorRuntime.awrap((0, _device.getAdjustedDeviceName)(this.opts));

          case 20:
            context$2$0.t14 = context$2$0.sent;
            context$2$0.next = 24;
            break;

          case 23:
            context$2$0.t14 = null;

          case 24:
            context$2$0.t15 = context$2$0.t14;
            context$2$0.t16 = _path2['default'].resolve(this.opts.tmpDir || '/tmp', 'appium-instruments');
            context$2$0.t17 = this.opts.traceDir;
            context$2$0.t18 = this.opts.locale;
            context$2$0.t19 = this.opts.language;
            context$2$0.t20 = {
              app: context$2$0.t1,
              udid: context$2$0.t2,
              processArguments: context$2$0.t3,
              ignoreStartupExit: context$2$0.t4,
              bootstrap: context$2$0.t5,
              template: context$2$0.t6,
              instrumentsPath: context$2$0.t7,
              withoutDelay: context$2$0.t8,
              platformVersion: context$2$0.t9,
              webSocket: context$2$0.t10,
              launchTimeout: context$2$0.t11,
              flakeyRetries: context$2$0.t12,
              realDevice: context$2$0.t13,
              simulatorSdkAndDevice: context$2$0.t15,
              tmpDir: context$2$0.t16,
              traceDir: context$2$0.t17,
              locale: context$2$0.t18,
              language: context$2$0.t19
            };
            instruments = new context$2$0.t0(context$2$0.t20);
            return context$2$0.abrupt('return', instruments);

          case 32:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'startInstruments',
    value: function startInstruments() {
      return _regeneratorRuntime.async(function startInstruments$(context$2$0) {
        var _this3 = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            _logger2['default'].debug("Starting UIAutoClient, and launching Instruments.");

            context$2$0.next = 3;
            return _regeneratorRuntime.awrap(_bluebird2['default'].all([this.uiAutoClient.start().then(function () {
              _this3.instruments.registerLaunch();
            }), this.instruments.launch()]));

          case 3:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'configureBootstrap',
    value: function configureBootstrap() {
      var isVerbose, cmd;
      return _regeneratorRuntime.async(function configureBootstrap$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            _logger2['default'].debug("Setting bootstrap config keys/values");
            isVerbose = true;
            cmd = 'target = $.target();\n';

            cmd += 'au = $;\n';
            cmd += '$.isVerbose = ' + isVerbose + ';\n';
            // Not using uiauto grace period because of bug.
            // cmd += '$.target().setTimeout(1);\n';
            context$2$0.next = 7;
            return _regeneratorRuntime.awrap(this.uiAutoClient.sendCommand(cmd));

          case 7:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'getSourceForElementForXML',
    value: function getSourceForElementForXML(ctx) {
      var source;
      return _regeneratorRuntime.async(function getSourceForElementForXML$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            source = undefined;

            if (ctx) {
              context$2$0.next = 7;
              break;
            }

            context$2$0.next = 4;
            return _regeneratorRuntime.awrap(this.uiAutoClient.sendCommand("au.mainApp().getTreeForXML()"));

          case 4:
            source = context$2$0.sent;
            context$2$0.next = 10;
            break;

          case 7:
            context$2$0.next = 9;
            return _regeneratorRuntime.awrap(this.uiAutoClient.sendCommand('au.getElement(\'' + ctx + '\').getTreeForXML()'));

          case 9:
            source = context$2$0.sent;

          case 10:
            if (!source) {
              context$2$0.next = 14;
              break;
            }

            return context$2$0.abrupt('return', JSON.stringify(source));

          case 14:
            throw new Error('Bad response from getTreeForXML. res was ' + JSON.stringify(source));

          case 15:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'realDevice',
    get: function get() {
      this._realDevice = this._realDevice || this.getIDeviceObj();
      return this._realDevice;
    },
    set: function set(rd) {
      this._realDevice = rd;
    }
  }], [{
    key: 'isSpringBoard',
    value: function isSpringBoard(uiAppObj) {
      // TODO: move to helpers
      // Test for iOS homescreen (SpringBoard). AUT occassionally start the sim, but fails to load
      // the app. If that occurs, getSourceForElementFoXML will return a doc object that meets our
      // app-check conditions, resulting in a false positive. This function tests the UiApplication
      // property's meta data to ensure that the Appium doesn't confuse SpringBoard with the app
      // under test.
      return _lodash2['default'].propertyOf(uiAppObj['@'])('name') === 'SpringBoard';
    }
  }]);

  return IosDriver;
})(_appiumBaseDriver.BaseDriver);

var _iteratorNormalCompletion = true;
var _didIteratorError = false;
var _iteratorError = undefined;

try {

  for (var _iterator = _getIterator(_lodash2['default'].toPairs(_commandsIndex2['default'])), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
    var _step$value = _slicedToArray(_step.value, 2);

    var cmd = _step$value[0];
    var fn = _step$value[1];

    IosDriver.prototype[cmd] = fn;
  }
} catch (err) {
  _didIteratorError = true;
  _iteratorError = err;
} finally {
  try {
    if (!_iteratorNormalCompletion && _iterator['return']) {
      _iterator['return']();
    }
  } finally {
    if (_didIteratorError) {
      throw _iteratorError;
    }
  }
}

exports.IosDriver = IosDriver;
exports.defaultServerCaps = defaultServerCaps;
exports['default'] = IosDriver;

// appium-ios-driver uses Instruments to automate the device
// but Xcode 8 does not have Instruments, so short circuit

// on real device, need to check if safari launcher exists
// first check if it is already on the device

// it's not on the device, so check if we need to build

// await this.sim.shutdown();

// if user has passed in desiredCaps.autoLaunch = false
// meaning they will manage app install / launching

// We already have a bundle Id

// on iOS8 in particular, we can get a working session before the app
// is ready to respond to commands; in that case the source will be empty
// so we just spin until it's not
// eslint-disable-line promise/catch-or-return
// unexpected exit

// at the moment all the logging in uiauto is at debug level

// on real devices bundleId is always used
// TODO: level was configured according to logger

// TODO: all this json/xml logic is very expensive, we need
// to use a SAX parser instead.

// this should never happen but we've received bug reports; this will help us track down
// what's wrong in getTreeForXML
//# sourceMappingURL=data:application/json;charset=utf8;base64,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QUMsRUFBRSxFQUFFO0FBQ2xCLFVBQUksQ0FBQyxXQUFXLEdBQUcsRUFBRSxDQUFDO0tBQ3ZCOzs7V0F2R29CLHVCQUFDLFFBQVEsRUFBRTs7Ozs7OztBQU85QixhQUFPLG9CQUFFLFVBQVUsQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsS0FBSyxhQUFhLENBQUM7S0FDOUQ7OztTQXZoQkcsU0FBUzs7Ozs7Ozs7O0FBeW5CZixvQ0FBc0Isb0JBQUUsT0FBTyw0QkFBVSw0R0FBRTs7O1FBQWpDLEdBQUc7UUFBRSxFQUFFOztBQUNmLGFBQVMsQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLEdBQUcsRUFBRSxDQUFDO0dBQy9COzs7Ozs7Ozs7Ozs7Ozs7O1FBR1EsU0FBUyxHQUFULFNBQVM7UUFBRSxpQkFBaUIsR0FBakIsaUJBQWlCO3FCQUN0QixTQUFTIiwiZmlsZSI6ImxpYi9kcml2ZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBCYXNlRHJpdmVyLCBEZXZpY2VTZXR0aW5ncywgZXJyb3JzIH0gZnJvbSAnYXBwaXVtLWJhc2UtZHJpdmVyJztcbmltcG9ydCB1dGlscyBmcm9tICcuL3V0aWxzJztcbmltcG9ydCBsb2dnZXIgZnJvbSAnLi9sb2dnZXInO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IEIgZnJvbSAnYmx1ZWJpcmQnO1xuaW1wb3J0IHsgZnMgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5pbXBvcnQgeyBnZXRTaW11bGF0b3IsIGluc3RhbGxTU0xDZXJ0LCB1bmluc3RhbGxTU0xDZXJ0IH0gZnJvbSAnYXBwaXVtLWlvcy1zaW11bGF0b3InO1xuaW1wb3J0IHsgcHJlcGFyZUJvb3RzdHJhcCwgVUlBdXRvQ2xpZW50IH0gZnJvbSAnLi91aWF1dG8vdWlhdXRvJztcbmltcG9ydCB7IEluc3RydW1lbnRzLCBpbnN0cnVtZW50c1V0aWxzIH0gZnJvbSAnLi9pbnN0cnVtZW50cyc7XG5pbXBvcnQgeyByZXRyeSwgd2FpdEZvckNvbmRpdGlvbiB9IGZyb20gJ2FzeW5jYm94JztcbmltcG9ydCBjb21tYW5kcyBmcm9tICcuL2NvbW1hbmRzL2luZGV4JztcbmltcG9ydCB7IGRlc2lyZWRDYXBDb25zdHJhaW50cywgZGVzaXJlZENhcFZhbGlkYXRpb24gfSBmcm9tICcuL2Rlc2lyZWQtY2Fwcyc7XG5pbXBvcnQgX2lEZXZpY2UgZnJvbSAnbm9kZS1pZGV2aWNlJztcbmltcG9ydCB7IFNBRkFSSV9CVU5ETEUgfSBmcm9tICcuL2NvbW1hbmRzL3NhZmFyaSc7XG5pbXBvcnQgeyBpbnN0YWxsLCBuZWVkc0luc3RhbGwsIFNBRkFSSV9MQVVOQ0hFUl9CVU5ETEUgfSBmcm9tICcuL3NhZmFyaS1sYXVuY2hlcic7XG5pbXBvcnQgeyBzZXRMb2NhbGUsIHNldFByZWZlcmVuY2VzIH0gZnJvbSAnLi9zZXR0aW5ncyc7XG5pbXBvcnQgeyBydW5TaW11bGF0b3JSZXNldCwgaXNvbGF0ZVNpbXVsYXRvckRldmljZSwgY2hlY2tTaW11bGF0b3JBdmFpbGFibGUsXG4gICAgICAgICBtb3ZlQnVpbHRJbkFwcCwgZ2V0QWRqdXN0ZWREZXZpY2VOYW1lLCBlbmRTaW11bGF0b3IsIHJ1blJlYWxEZXZpY2VSZXNldCB9IGZyb20gJy4vZGV2aWNlJztcbmltcG9ydCB7IElXRFAgfSBmcm9tICcuL2l3ZHAnO1xuXG5cbi8vIHByb21pc2lmeSBfaURldmljZVxubGV0IGlEZXZpY2UgPSBmdW5jdGlvbiAoLi4uYXJncykge1xuICBsZXQgZGV2aWNlID0gX2lEZXZpY2UoLi4uYXJncyk7XG4gIGxldCBwcm9taXNpZmllZCA9IHt9O1xuICBmb3IgKGxldCBtIG9mIFsnaW5zdGFsbCcsICdpbnN0YWxsQW5kV2FpdCcsICdyZW1vdmUnLCAnaXNJbnN0YWxsZWQnXSkge1xuICAgIHByb21pc2lmaWVkW21dID0gQi5wcm9taXNpZnkoZGV2aWNlW21dLmJpbmQoZGV2aWNlKSk7XG4gIH1cbiAgcmV0dXJuIHByb21pc2lmaWVkO1xufTtcblxuY29uc3QgZGVmYXVsdFNlcnZlckNhcHMgPSB7XG4gIHdlYlN0b3JhZ2VFbmFibGVkOiBmYWxzZSxcbiAgbG9jYXRpb25Db250ZXh0RW5hYmxlZDogZmFsc2UsXG4gIGJyb3dzZXJOYW1lOiAnJyxcbiAgcGxhdGZvcm06ICdNQUMnLFxuICBqYXZhc2NyaXB0RW5hYmxlZDogdHJ1ZSxcbiAgZGF0YWJhc2VFbmFibGVkOiBmYWxzZSxcbiAgdGFrZXNTY3JlZW5zaG90OiB0cnVlLFxuICBuZXR3b3JrQ29ubmVjdGlvbkVuYWJsZWQ6IGZhbHNlLFxufTtcblxuY29uc3QgTE9HX0xPQ0FUSU9OUyA9IFtcbiAgcGF0aC5yZXNvbHZlKCcvJywgJ0xpYnJhcnknLCAnQ2FjaGVzJywgJ2NvbS5hcHBsZS5kdC5pbnN0cnVtZW50cycpLFxuXTtcbmlmIChwcm9jZXNzLmVudi5IT01FKSB7XG4gIExPR19MT0NBVElPTlMucHVzaChwYXRoLnJlc29sdmUocHJvY2Vzcy5lbnYuSE9NRSwgJ0xpYnJhcnknLCAnTG9ncycsICdDb3JlU2ltdWxhdG9yJykpO1xufVxuXG5jbGFzcyBJb3NEcml2ZXIgZXh0ZW5kcyBCYXNlRHJpdmVyIHtcbiAgcmVzZXRJb3MgKCkge1xuICAgIHRoaXMuYXBwRXh0ID0gXCIuYXBwXCI7XG4gICAgdGhpcy54Y29kZVZlcnNpb24gPSBudWxsO1xuICAgIHRoaXMuaW9zU2RrVmVyc2lvbiA9IG51bGw7XG4gICAgdGhpcy5sb2dzID0ge307XG4gICAgdGhpcy5pbnN0cnVtZW50cyA9IG51bGw7XG4gICAgdGhpcy51aUF1dG9DbGllbnQgPSBudWxsO1xuICAgIHRoaXMub25JbnN0cnVtZW50c0RpZSA9IGZ1bmN0aW9uICgpIHt9O1xuICAgIHRoaXMuc3RvcHBpbmcgPSBmYWxzZTtcbiAgICB0aGlzLmNiRm9yQ3VycmVudENtZCA9IG51bGw7XG4gICAgdGhpcy5yZW1vdGUgPSBudWxsO1xuICAgIHRoaXMuY3VyQ29udGV4dCA9IG51bGw7XG4gICAgdGhpcy5jdXJXZWJGcmFtZXMgPSBbXTtcbiAgICB0aGlzLnNlbGVjdGluZ05ld1BhZ2UgPSBmYWxzZTtcbiAgICB0aGlzLndpbmRvd0hhbmRsZUNhY2hlID0gW107XG4gICAgdGhpcy53ZWJFbGVtZW50SWRzID0gW107XG4gICAgdGhpcy5pbXBsaWNpdFdhaXRNcyA9IDA7XG4gICAgdGhpcy5hc3luY2xpYldhaXRNcyA9IDA7XG4gICAgdGhpcy5wYWdlTG9hZE1zID0gNjAwMDtcbiAgICB0aGlzLmFzeW5jbGliUmVzcG9uc2VDYiA9IG51bGw7XG4gICAgdGhpcy5yZXR1cm5lZEZyb21FeGVjdXRlQXRvbSA9IHt9O1xuICAgIHRoaXMuZXhlY3V0ZWRBdG9tc0NvdW50ZXIgPSAwO1xuICAgIHRoaXMuY3VyQ29vcmRzID0gbnVsbDtcbiAgICB0aGlzLmN1cldlYkNvb3JkcyA9IG51bGw7XG4gICAgdGhpcy5sYW5kc2NhcGVXZWJDb29yZHNPZmZzZXQgPSAwO1xuICAgIHRoaXMua2VlcEFwcFRvUmV0YWluUHJlZnMgPSBmYWxzZTtcbiAgICB0aGlzLnJlYWR5ID0gZmFsc2U7XG4gICAgdGhpcy5hc3luY1dhaXRNcyA9IDA7XG5cbiAgICB0aGlzLnNldHRpbmdzID0gbmV3IERldmljZVNldHRpbmdzKHt9LCBfLm5vb3ApO1xuXG4gICAgdGhpcy5sb2NhdG9yU3RyYXRlZ2llcyA9IFtcbiAgICAgICd4cGF0aCcsXG4gICAgICAnaWQnLFxuICAgICAgJ2NsYXNzIG5hbWUnLFxuICAgICAgJy1pb3MgdWlhdXRvbWF0aW9uJyxcbiAgICAgICdhY2Nlc3NpYmlsaXR5IGlkJ1xuICAgIF07XG4gICAgdGhpcy53ZWJMb2NhdG9yU3RyYXRlZ2llcyA9IFtcbiAgICAgICdsaW5rIHRleHQnLFxuICAgICAgJ2NzcyBzZWxlY3RvcicsXG4gICAgICAndGFnIG5hbWUnLFxuICAgICAgJ3BhcnRpYWwgbGluayB0ZXh0J1xuICAgIF07XG4gIH1cblxuICBjb25zdHJ1Y3RvciAob3B0cywgc2hvdWxkVmFsaWRhdGVDYXBzKSB7XG4gICAgc3VwZXIob3B0cywgc2hvdWxkVmFsaWRhdGVDYXBzKTtcblxuICAgIHRoaXMuZGVzaXJlZENhcENvbnN0cmFpbnRzID0gZGVzaXJlZENhcENvbnN0cmFpbnRzO1xuICAgIHRoaXMucmVzZXRJb3MoKTtcbiAgfVxuXG4gIHZhbGlkYXRlTG9jYXRvclN0cmF0ZWd5IChzdHJhdGVneSkge1xuICAgIHN1cGVyLnZhbGlkYXRlTG9jYXRvclN0cmF0ZWd5KHN0cmF0ZWd5LCB0aGlzLmlzV2ViQ29udGV4dCgpKTtcbiAgfVxuXG4gIGFzeW5jIHN0YXJ0ICgpIHtcbiAgICBpZiAodGhpcy5pc1JlYWxEZXZpY2UoKSkge1xuICAgICAgYXdhaXQgdGhpcy5zdGFydFJlYWxEZXZpY2UoKTtcbiAgICB9IGVsc2Uge1xuICAgICAgYXdhaXQgdGhpcy5zdGFydFNpbXVsYXRvcigpO1xuICAgIH1cbiAgICB0aGlzLnJlYWR5ID0gdHJ1ZTtcbiAgfVxuXG4gIGFzeW5jIGNyZWF0ZVNlc3Npb24gKC4uLmFyZ3MpIHtcbiAgICBsZXQgW3Nlc3Npb25JZCwgY2Fwc10gPSBhd2FpdCBzdXBlci5jcmVhdGVTZXNzaW9uKC4uLmFyZ3MpO1xuXG4gICAgLy8gYXBwaXVtLWlvcy1kcml2ZXIgdXNlcyBJbnN0cnVtZW50cyB0byBhdXRvbWF0ZSB0aGUgZGV2aWNlXG4gICAgLy8gYnV0IFhjb2RlIDggZG9lcyBub3QgaGF2ZSBJbnN0cnVtZW50cywgc28gc2hvcnQgY2lyY3VpdFxuICAgIHRoaXMueGNvZGVWZXJzaW9uID0gYXdhaXQgdXRpbHMuZ2V0QW5kQ2hlY2tYY29kZVZlcnNpb24odGhpcy5vcHRzKTtcbiAgICBsb2dnZXIuZGVidWcoYFhjb2RlIHZlcnNpb24gc2V0IHRvICR7dGhpcy54Y29kZVZlcnNpb24udmVyc2lvblN0cmluZ31gKTtcbiAgICBpZiAodGhpcy54Y29kZVZlcnNpb24ubWFqb3IgPj0gOCkge1xuICAgICAgbGV0IG1zZyA9IGBBcHBpdW0ncyBJb3NEcml2ZXIgZG9lcyBub3Qgc3VwcG9ydCB4Y29kZSB2ZXJzaW9uICR7dGhpcy54Y29kZVZlcnNpb24udmVyc2lvblN0cmluZ30uIGAgK1xuICAgICAgICAgICAgICAgICdBcHBsZSBoYXMgZGVwcmVjYXRlZCBVSUF1dG9tYXRpb24uIFVzZSB0aGUgXCJYQ1VJVGVzdFwiIGF1dG9tYXRpb25OYW1lIGNhcGFiaWxpdHkgaW5zdGVhZC4nO1xuICAgICAgbG9nZ2VyLmVycm9yQW5kVGhyb3cobmV3IGVycm9ycy5TZXNzaW9uTm90Q3JlYXRlZEVycm9yKG1zZykpO1xuICAgIH1cblxuICAgIC8vIG1lcmdlIHNlcnZlciBjYXBhYmlsaXRpZXMgKyBkZXNpcmVkIGNhcGFiaWxpdGllc1xuICAgIHRoaXMuY2FwcyA9IE9iamVjdC5hc3NpZ24oe30sIGRlZmF1bHRTZXJ2ZXJDYXBzLCB0aGlzLmNhcHMpO1xuICAgIHRoaXMuY2Fwcy5kZXNpcmVkID0gY2FwcztcblxuICAgIGF3YWl0IHV0aWxzLmRldGVjdFVkaWQodGhpcy5vcHRzKTtcbiAgICBhd2FpdCB1dGlscy5wcmVwYXJlSW9zT3B0cyh0aGlzLm9wdHMpO1xuICAgIHRoaXMucmVhbERldmljZSA9IG51bGw7XG4gICAgdGhpcy51c2VSb2JvdCA9IHRoaXMub3B0cy51c2VSb2JvdDtcbiAgICB0aGlzLnNhZmFyaSA9IHRoaXMub3B0cy5zYWZhcmk7XG4gICAgdGhpcy5vcHRzLmN1ck9yaWVudGF0aW9uID0gdGhpcy5vcHRzLmluaXRpYWxPcmllbnRhdGlvbjtcblxuICAgIHRoaXMuc29jayA9IHBhdGgucmVzb2x2ZSh0aGlzLm9wdHMudG1wRGlyIHx8ICcvdG1wJywgJ2luc3RydW1lbnRzX3NvY2snKTtcblxuICAgIHRyeSB7XG4gICAgICBhd2FpdCB0aGlzLmNvbmZpZ3VyZUFwcCgpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgbG9nZ2VyLmVycm9yKGBCYWQgYXBwOiAnJHt0aGlzLm9wdHMuYXBwfScuIEFwcCBwYXRocyBuZWVkIHRvIGAgK1xuICAgICAgICAgICAgICAgICAgIGBiZSBhYnNvbHV0ZSwgb3IgcmVsYXRpdmUgdG8gdGhlIGFwcGl1bSBzZXJ2ZXIgYCArXG4gICAgICAgICAgICAgICAgICAgYGluc3RhbGwgZGlyLCBvciBhIFVSTCB0byBjb21wcmVzc2VkIGZpbGUsIG9yIGEgYCArXG4gICAgICAgICAgICAgICAgICAgYHNwZWNpYWwgYXBwIG5hbWUuYCk7XG4gICAgICB0aHJvdyBlcnI7XG4gICAgfVxuXG4gICAgYXdhaXQgdGhpcy5zdGFydCgpO1xuXG4gICAgLy8gVE9ETzogdGhpcyBzaG91bGQgYmUgaW4gQmFzZURyaXZlci5wb3N0Q3JlYXRlU2Vzc2lvblxuICAgIHRoaXMuc3RhcnROZXdDb21tYW5kVGltZW91dCgnY3JlYXRlU2Vzc2lvbicpO1xuICAgIHJldHVybiBbc2Vzc2lvbklkLCB0aGlzLmNhcHNdO1xuICB9XG5cbiAgYXN5bmMgc3RvcCAoKSB7XG4gICAgdGhpcy5yZWFkeSA9IGZhbHNlO1xuXG4gICAgaWYgKHRoaXMudWlBdXRvQ2xpZW50KSB7XG4gICAgICBhd2FpdCB0aGlzLnVpQXV0b0NsaWVudC5zaHV0ZG93bigpO1xuICAgIH1cblxuICAgIGlmICh0aGlzLmluc3RydW1lbnRzKSB7XG4gICAgICB0cnkge1xuICAgICAgICBhd2FpdCB0aGlzLmluc3RydW1lbnRzLnNodXRkb3duKCk7XG4gICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgbG9nZ2VyLmVycm9yKGBJbnN0cnVtZW50cyBkaWRuJ3Qgc2h1dCBkb3duLiAke2Vycn1gKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAodGhpcy5jYXBzICYmIHRoaXMuY2Fwcy5jdXN0b21TU0xDZXJ0ICYmICF0aGlzLmlzUmVhbERldmljZSgpKSB7XG4gICAgICBsb2dnZXIuZGVidWcoYFVuaW5zdGFsbGluZyBzc2wgY2VydGlmaWNhdGUgZm9yIHVkaWQgJyR7dGhpcy5zaW0udWRpZH0nYCk7XG4gICAgICBhd2FpdCB1bmluc3RhbGxTU0xDZXJ0KHRoaXMuY2Fwcy5jdXN0b21TU0xDZXJ0LCB0aGlzLnNpbS51ZGlkKTtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5vcHRzLmVuYWJsZUFzeW5jRXhlY3V0ZUZyb21IdHRwcyAmJiAhdGhpcy5pc1JlYWxEZXZpY2UoKSkge1xuICAgICAgYXdhaXQgdGhpcy5zdG9wSHR0cHNBc3luY1NlcnZlcigpO1xuICAgIH1cblxuICAgIHRoaXMudWlBdXRvQ2xpZW50ID0gbnVsbDtcbiAgICB0aGlzLmluc3RydW1lbnRzID0gbnVsbDtcbiAgICB0aGlzLnJlYWxEZXZpY2UgPSBudWxsO1xuXG4gICAgLy8gcG9zdGNsZWFudXBcbiAgICB0aGlzLmN1ckNvb3JkcyA9IG51bGw7XG4gICAgdGhpcy5vcHRzLmN1ck9yaWVudGF0aW9uID0gbnVsbDtcbiAgICBpZiAoIV8uaXNFbXB0eSh0aGlzLmxvZ3MpKSB7XG4gICAgICBhd2FpdCB0aGlzLmxvZ3Muc3lzbG9nLnN0b3BDYXB0dXJlKCk7XG4gICAgICB0aGlzLmxvZ3MgPSB7fTtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5yZW1vdGUpIHtcbiAgICAgIGF3YWl0IHRoaXMuc3RvcFJlbW90ZSgpO1xuICAgIH1cblxuICAgIGF3YWl0IHRoaXMuc3RvcElXRFAoKTtcbiAgfVxuXG4gIGFzeW5jIGRlbGV0ZVNlc3Npb24gKCkge1xuICAgIGxvZ2dlci5kZWJ1ZyhcIkRlbGV0aW5nIGlvcyBzZXNzaW9uXCIpO1xuXG4gICAgYXdhaXQgdGhpcy5zdG9wKCk7XG5cbiAgICBpZiAodGhpcy5vcHRzLmNsZWFyU3lzdGVtRmlsZXMpIHtcbiAgICAgIGF3YWl0IHV0aWxzLmNsZWFyTG9ncyhMT0dfTE9DQVRJT05TKTtcbiAgICB9IGVsc2Uge1xuICAgICAgbG9nZ2VyLmRlYnVnKCdOb3QgY2xlYXJpbmcgbG9nIGZpbGVzLiBVc2UgYGNsZWFyU3lzdGVtRmlsZXNgIGNhcGFiaWxpdHkgdG8gdHVybiBvbi4nKTtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5pc1JlYWxEZXZpY2UoKSkge1xuICAgICAgYXdhaXQgcnVuUmVhbERldmljZVJlc2V0KHRoaXMucmVhbERldmljZSwgdGhpcy5vcHRzKTtcbiAgICB9IGVsc2Uge1xuICAgICAgYXdhaXQgcnVuU2ltdWxhdG9yUmVzZXQodGhpcy5zaW0sIHRoaXMub3B0cywgdGhpcy5rZWVwQXBwVG9SZXRhaW5QcmVmcyk7XG4gICAgfVxuICAgIGF3YWl0IHN1cGVyLmRlbGV0ZVNlc3Npb24oKTtcbiAgfVxuXG4gIGFzeW5jIGV4ZWN1dGVDb21tYW5kIChjbWQsIC4uLmFyZ3MpIHtcbiAgICBsb2dnZXIuZGVidWcoYEV4ZWN1dGluZyBpT1MgY29tbWFuZCAnJHtjbWR9J2ApO1xuICAgIGlmIChjbWQgPT09ICdyZWNlaXZlQXN5bmNSZXNwb25zZScpIHtcbiAgICAgIHJldHVybiBhd2FpdCB0aGlzLnJlY2VpdmVBc3luY1Jlc3BvbnNlKC4uLmFyZ3MpO1xuICAgIH0gZWxzZSBpZiAodGhpcy5yZWFkeSB8fCBfLmluY2x1ZGVzKFsnbGF1bmNoQXBwJ10sIGNtZCkpIHtcbiAgICAgIHJldHVybiBhd2FpdCBzdXBlci5leGVjdXRlQ29tbWFuZChjbWQsIC4uLmFyZ3MpO1xuICAgIH1cblxuICAgIHRocm93IG5ldyBlcnJvcnMuTm9TdWNoRHJpdmVyRXJyb3IoYERyaXZlciBpcyBub3QgcmVhZHksIGNhbm5vdCBleGVjdXRlICR7Y21kfS5gKTtcbiAgfVxuXG4gIC8vIFRPRE86IHJlZm9ybWF0IHRoaXMuaGVscGVycyArIGNvbmZpZ3VyZUFwcFxuICBhc3luYyBjb25maWd1cmVBcHAgKCkge1xuICAgIHRyeSB7XG4gICAgICAvLyBpZiB0aGUgYXBwIG5hbWUgaXMgYSBidW5kbGVJZCBhc3NpZ24gaXQgdG8gdGhlIGJ1bmRsZUlkIHByb3BlcnR5XG4gICAgICBpZiAoIXRoaXMub3B0cy5idW5kbGVJZCAmJiB1dGlscy5hcHBJc1BhY2thZ2VPckJ1bmRsZSh0aGlzLm9wdHMuYXBwKSkge1xuICAgICAgICB0aGlzLm9wdHMuYnVuZGxlSWQgPSB0aGlzLm9wdHMuYXBwO1xuICAgICAgfVxuXG4gICAgICBpZiAodGhpcy5vcHRzLmFwcCAmJiB0aGlzLm9wdHMuYXBwLnRvTG93ZXJDYXNlKCkgPT09IFwic2V0dGluZ3NcIikge1xuICAgICAgICBpZiAocGFyc2VGbG9hdCh0aGlzLm9wdHMucGxhdGZvcm1WZXJzaW9uKSA+PSA4KSB7XG4gICAgICAgICAgbG9nZ2VyLmRlYnVnKFwiV2UgYXJlIG9uIGlPUzgrIHNvIG5vdCBjb3B5aW5nIHByZWZlcmVuY2VzIGFwcFwiKTtcbiAgICAgICAgICB0aGlzLm9wdHMuYnVuZGxlSWQgPSBcImNvbS5hcHBsZS5QcmVmZXJlbmNlc1wiO1xuICAgICAgICAgIHRoaXMub3B0cy5hcHAgPSBudWxsO1xuICAgICAgICB9XG4gICAgICB9IGVsc2UgaWYgKHRoaXMub3B0cy5hcHAgJiYgdGhpcy5vcHRzLmFwcC50b0xvd2VyQ2FzZSgpID09PSBcImNhbGVuZGFyXCIpIHtcbiAgICAgICAgaWYgKHBhcnNlRmxvYXQodGhpcy5vcHRzLnBsYXRmb3JtVmVyc2lvbikgPj0gOCkge1xuICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhcIldlIGFyZSBvbiBpT1M4KyBzbyBub3QgY29weWluZyBjYWxlbmRhciBhcHBcIik7XG4gICAgICAgICAgdGhpcy5vcHRzLmJ1bmRsZUlkID0gXCJjb20uYXBwbGUubW9iaWxlY2FsXCI7XG4gICAgICAgICAgdGhpcy5vcHRzLmFwcCA9IG51bGw7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSBpZiAodGhpcy5pc1NhZmFyaSgpKSB7XG4gICAgICAgIGlmICghdGhpcy5pc1JlYWxEZXZpY2UoKSkge1xuICAgICAgICAgIGlmIChwYXJzZUZsb2F0KHRoaXMub3B0cy5wbGF0Zm9ybVZlcnNpb24pID49IDgpIHtcbiAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhcIldlIGFyZSBvbiBpT1M4KyBzbyBub3QgY29weWluZyBTYWZhcmkgYXBwXCIpO1xuICAgICAgICAgICAgdGhpcy5vcHRzLmJ1bmRsZUlkID0gU0FGQVJJX0JVTkRMRTtcbiAgICAgICAgICAgIHRoaXMub3B0cy5hcHAgPSBudWxsO1xuICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAvLyBvbiByZWFsIGRldmljZSwgbmVlZCB0byBjaGVjayBpZiBzYWZhcmkgbGF1bmNoZXIgZXhpc3RzXG4gICAgICAgICAgLy8gZmlyc3QgY2hlY2sgaWYgaXQgaXMgYWxyZWFkeSBvbiB0aGUgZGV2aWNlXG4gICAgICAgICAgaWYgKCFhd2FpdCB0aGlzLnJlYWxEZXZpY2UuaXNJbnN0YWxsZWQodGhpcy5vcHRzLmJ1bmRsZUlkKSkge1xuICAgICAgICAgICAgLy8gaXQncyBub3Qgb24gdGhlIGRldmljZSwgc28gY2hlY2sgaWYgd2UgbmVlZCB0byBidWlsZFxuICAgICAgICAgICAgaWYgKGF3YWl0IG5lZWRzSW5zdGFsbCgpKSB7XG4gICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZygnU2FmYXJpTGF1bmNoZXIgbm90IGZvdW5kLCBidWlsZGluZy4uLicpO1xuICAgICAgICAgICAgICBhd2FpdCBpbnN0YWxsKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0aGlzLm9wdHMuYnVuZGxlSWQgPSBTQUZBUklfTEFVTkNIRVJfQlVORExFO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSBlbHNlIGlmICh0aGlzLm9wdHMuYnVuZGxlSWQgJiZcbiAgICAgICAgICAgICAgICAgdXRpbHMuYXBwSXNQYWNrYWdlT3JCdW5kbGUodGhpcy5vcHRzLmJ1bmRsZUlkKSAmJlxuICAgICAgICAgICAgICAgICAodGhpcy5vcHRzLmFwcCA9PT0gXCJcIiB8fCB1dGlscy5hcHBJc1BhY2thZ2VPckJ1bmRsZSh0aGlzLm9wdHMuYXBwKSkpIHtcbiAgICAgICAgLy8gd2UgaGF2ZSBhIGJ1bmRsZSBJRCwgYnV0IG5vIGFwcCwgb3IgYXBwIGlzIGFsc28gYSBidW5kbGVcbiAgICAgICAgbG9nZ2VyLmRlYnVnKFwiQXBwIGlzIGFuIGlPUyBidW5kbGUsIHdpbGwgYXR0ZW1wdCB0byBydW4gYXMgcHJlLWV4aXN0aW5nXCIpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5vcHRzLmFwcCA9IGF3YWl0IHRoaXMuaGVscGVycy5jb25maWd1cmVBcHAodGhpcy5vcHRzLmFwcCwgJy5hcHAnKTtcbiAgICAgIH1cbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGxvZ2dlci5lcnJvcihlcnIpO1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgQmFkIGFwcDogJHt0aGlzLm9wdHMuYXBwfS4gQXBwIHBhdGhzIG5lZWQgdG8gYmUgYWJzb2x1dGUsIG9yIHJlbGF0aXZlIHRvIHRoZSBhcHBpdW0gYCArXG4gICAgICAgIFwic2VydmVyIGluc3RhbGwgZGlyLCBvciBhIFVSTCB0byBjb21wcmVzc2VkIGZpbGUsIG9yIGEgc3BlY2lhbCBhcHAgbmFtZS5cIik7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgc3RhcnRTaW11bGF0b3IgKCkge1xuICAgIGF3YWl0IHV0aWxzLnJlbW92ZUluc3RydW1lbnRzU29ja2V0KHRoaXMuc29jayk7XG5cbiAgICBpZiAoIXRoaXMueGNvZGVWZXJzaW9uKSB7XG4gICAgICBsb2dnZXIuZGVidWcoXCJTZXR0aW5nIFhjb2RlIHZlcnNpb25cIik7XG4gICAgICB0aGlzLnhjb2RlVmVyc2lvbiA9IGF3YWl0IHV0aWxzLmdldEFuZENoZWNrWGNvZGVWZXJzaW9uKHRoaXMub3B0cyk7XG4gICAgICBsb2dnZXIuZGVidWcoYFhjb2RlIHZlcnNpb24gc2V0IHRvICR7dGhpcy54Y29kZVZlcnNpb24udmVyc2lvblN0cmluZ31gKTtcbiAgICB9XG5cbiAgICBsb2dnZXIuZGVidWcoXCJTZXR0aW5nIGlPUyBTREsgVmVyc2lvblwiKTtcbiAgICB0aGlzLmlvc1Nka1ZlcnNpb24gPSBhd2FpdCB1dGlscy5nZXRBbmRDaGVja0lvc1Nka1ZlcnNpb24oKTtcbiAgICBsb2dnZXIuZGVidWcoYGlPUyBTREsgVmVyc2lvbiBzZXQgdG8gJHt0aGlzLmlvc1Nka1ZlcnNpb259YCk7XG5cbiAgICBsZXQgdGltZW91dCA9IF8uaXNPYmplY3QodGhpcy5vcHRzLmxhdW5jaFRpbWVvdXQpID8gdGhpcy5vcHRzLmxhdW5jaFRpbWVvdXQuZ2xvYmFsIDogdGhpcy5vcHRzLmxhdW5jaFRpbWVvdXQ7XG4gICAgbGV0IGF2YWlsYWJsZURldmljZXMgPSBhd2FpdCByZXRyeSgzLCBpbnN0cnVtZW50c1V0aWxzLmdldEF2YWlsYWJsZURldmljZXMsIHRpbWVvdXQpO1xuXG4gICAgbGV0IGlvc1NpbVVkaWQgPSBhd2FpdCBjaGVja1NpbXVsYXRvckF2YWlsYWJsZSh0aGlzLm9wdHMsIHRoaXMuaW9zU2RrVmVyc2lvbiwgYXZhaWxhYmxlRGV2aWNlcyk7XG5cbiAgICB0aGlzLnNpbSA9IGF3YWl0IGdldFNpbXVsYXRvcihpb3NTaW1VZGlkLCB0aGlzLnhjb2RlVmVyc2lvbi52ZXJzaW9uU3RyaW5nKTtcblxuICAgIGF3YWl0IG1vdmVCdWlsdEluQXBwKHRoaXMuc2ltKTtcblxuICAgIGF3YWl0IHV0aWxzLnBhcnNlTG9jYWxpemFibGVTdHJpbmdzKHRoaXMub3B0cyk7XG5cbiAgICBhd2FpdCB1dGlscy5zZXRCdW5kbGVJZEZyb21BcHAodGhpcy5vcHRzKTtcblxuICAgIGF3YWl0IHRoaXMuY3JlYXRlSW5zdHJ1bWVudHMoKTtcblxuICAgIHtcbiAgICAgIC8vIHByZXZpb3VzbHkgc2V0RGV2aWNlSW5mbygpXG4gICAgICB0aGlzLnNob3VsZFByZWxhdW5jaFNpbXVsYXRvciA9IHV0aWxzLnNob3VsZFByZWxhdW5jaFNpbXVsYXRvcih0aGlzLm9wdHMsIHRoaXMuaW9zU2RrVmVyc2lvbik7XG4gICAgICBsZXQgZFN0cmluZyA9IGF3YWl0IGdldEFkanVzdGVkRGV2aWNlTmFtZSh0aGlzLm9wdHMpO1xuICAgICAgaWYgKHRoaXMuY2Fwcy5hcHApIHtcbiAgICAgICAgYXdhaXQgdXRpbHMuc2V0RGV2aWNlVHlwZUluSW5mb1BsaXN0KHRoaXMub3B0cy5hcHAsIGRTdHJpbmcpO1xuICAgICAgfVxuICAgIH1cblxuICAgIGF3YWl0IHJ1blNpbXVsYXRvclJlc2V0KHRoaXMuc2ltLCB0aGlzLm9wdHMsIHRoaXMua2VlcEFwcFRvUmV0YWluUHJlZnMpO1xuXG4gICAgaWYgKHRoaXMuY2Fwcy5jdXN0b21TU0xDZXJ0ICYmICF0aGlzLmlzUmVhbERldmljZSgpKSB7XG4gICAgICBhd2FpdCBpbnN0YWxsU1NMQ2VydCh0aGlzLmNhcHMuY3VzdG9tU1NMQ2VydCwgdGhpcy5zaW0udWRpZCk7XG4gICAgfVxuXG4gICAgaWYgKHRoaXMub3B0cy5lbmFibGVBc3luY0V4ZWN1dGVGcm9tSHR0cHMgJiYgIXRoaXMuaXNSZWFsRGV2aWNlKCkpIHtcbiAgICAgIC8vIGF3YWl0IHRoaXMuc2ltLnNodXRkb3duKCk7XG4gICAgICBhd2FpdCB0aGlzLnN0YXJ0SHR0cHNBc3luY1NlcnZlcigpO1xuICAgIH1cblxuICAgIGF3YWl0IGlzb2xhdGVTaW11bGF0b3JEZXZpY2UodGhpcy5zaW0sIHRoaXMub3B0cyk7XG4gICAgdGhpcy5sb2NhbENvbmZpZyA9IGF3YWl0IHNldExvY2FsZSh0aGlzLnNpbSwgdGhpcy5vcHRzLCB0aGlzLmxvY2FsQ29uZmlnLCB0aGlzLmlzU2FmYXJpKCkpO1xuICAgIGF3YWl0IHNldFByZWZlcmVuY2VzKHRoaXMuc2ltLCB0aGlzLm9wdHMsIHRoaXMuaXNTYWZhcmkoKSk7XG4gICAgYXdhaXQgdGhpcy5zdGFydExvZ0NhcHR1cmUodGhpcy5zaW0pO1xuICAgIGF3YWl0IHRoaXMucHJlbGF1bmNoU2ltdWxhdG9yKCk7XG4gICAgYXdhaXQgdGhpcy5zdGFydEluc3RydW1lbnRzKCk7XG4gICAgYXdhaXQgdGhpcy5vbkluc3RydW1lbnRzTGF1bmNoKCk7XG4gICAgYXdhaXQgdGhpcy5jb25maWd1cmVCb290c3RyYXAoKTtcbiAgICBhd2FpdCB0aGlzLnNldEJ1bmRsZUlkKCk7XG4gICAgYXdhaXQgdGhpcy5zZXRJbml0aWFsT3JpZW50YXRpb24oKTtcbiAgICBhd2FpdCB0aGlzLmluaXRBdXRvV2VidmlldygpO1xuICAgIGF3YWl0IHRoaXMud2FpdEZvckFwcExhdW5jaGVkKCk7XG4gIH1cblxuICBhc3luYyBzdGFydFJlYWxEZXZpY2UgKCkge1xuICAgIGF3YWl0IHV0aWxzLnJlbW92ZUluc3RydW1lbnRzU29ja2V0KHRoaXMuc29jayk7XG4gICAgYXdhaXQgdXRpbHMucGFyc2VMb2NhbGl6YWJsZVN0cmluZ3ModGhpcy5vcHRzKTtcbiAgICBhd2FpdCB1dGlscy5zZXRCdW5kbGVJZEZyb21BcHAodGhpcy5vcHRzKTtcbiAgICBhd2FpdCB0aGlzLmNyZWF0ZUluc3RydW1lbnRzKCk7XG4gICAgYXdhaXQgcnVuUmVhbERldmljZVJlc2V0KHRoaXMucmVhbERldmljZSwgdGhpcy5vcHRzKTtcbiAgICBhd2FpdCB0aGlzLnN0YXJ0TG9nQ2FwdHVyZSgpO1xuICAgIGF3YWl0IHRoaXMuaW5zdGFsbFRvUmVhbERldmljZSgpO1xuICAgIGF3YWl0IHRoaXMuc3RhcnRJbnN0cnVtZW50cygpO1xuICAgIGF3YWl0IHRoaXMub25JbnN0cnVtZW50c0xhdW5jaCgpO1xuICAgIGF3YWl0IHRoaXMuY29uZmlndXJlQm9vdHN0cmFwKCk7XG4gICAgYXdhaXQgdGhpcy5zZXRCdW5kbGVJZCgpO1xuICAgIGF3YWl0IHRoaXMuc2V0SW5pdGlhbE9yaWVudGF0aW9uKCk7XG4gICAgYXdhaXQgdGhpcy5pbml0QXV0b1dlYnZpZXcoKTtcbiAgICBhd2FpdCB0aGlzLndhaXRGb3JBcHBMYXVuY2hlZCgpO1xuICB9XG5cbiAgYXN5bmMgaW5zdGFsbFRvUmVhbERldmljZSAoKSB7XG4gICAgLy8gaWYgdXNlciBoYXMgcGFzc2VkIGluIGRlc2lyZWRDYXBzLmF1dG9MYXVuY2ggPSBmYWxzZVxuICAgIC8vIG1lYW5pbmcgdGhleSB3aWxsIG1hbmFnZSBhcHAgaW5zdGFsbCAvIGxhdW5jaGluZ1xuICAgIGlmICh0aGlzLm9wdHMuYXV0b0xhdW5jaCA9PT0gZmFsc2UpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICAvLyBpZiB3ZSBoYXZlIGFuIGlwYSBmaWxlLCBzZXQgaXQgaW4gb3B0c1xuICAgIGlmICh0aGlzLm9wdHMuYXBwKSB7XG4gICAgICBsZXQgZXh0ID0gdGhpcy5vcHRzLmFwcC5zdWJzdHJpbmcodGhpcy5vcHRzLmFwcC5sZW5ndGggLSAzKS50b0xvd2VyQ2FzZSgpO1xuICAgICAgaWYgKGV4dCA9PT0gJ2lwYScpIHtcbiAgICAgICAgdGhpcy5vcHRzLmlwYSA9IHRoaXMub3B0cy5hcHA7XG4gICAgICB9XG4gICAgfVxuXG4gICAgaWYgKHRoaXMub3B0cy51ZGlkKSB7XG4gICAgICBpZiAoYXdhaXQgdGhpcy5yZWFsRGV2aWNlLmlzSW5zdGFsbGVkKHRoaXMub3B0cy5idW5kbGVJZCkpIHtcbiAgICAgICAgbG9nZ2VyLmRlYnVnKFwiQXBwIGlzIGluc3RhbGxlZC5cIik7XG4gICAgICAgIGlmICh0aGlzLm9wdHMuZnVsbFJlc2V0KSB7XG4gICAgICAgICAgbG9nZ2VyLmRlYnVnKFwiZnVsbFJlc2V0IHJlcXVlc3RlZC4gRm9yY2luZyBhcHAgaW5zdGFsbC5cIik7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgbG9nZ2VyLmRlYnVnKFwiZnVsbFJlc2V0IG5vdCByZXF1ZXN0ZWQuIE5vIG5lZWQgdG8gaW5zdGFsbC5cIik7XG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBsb2dnZXIuZGVidWcoXCJBcHAgaXMgbm90IGluc3RhbGxlZC4gV2lsbCB0cnkgdG8gaW5zdGFsbC5cIik7XG4gICAgICB9XG5cbiAgICAgIGlmICh0aGlzLm9wdHMuaXBhICYmIHRoaXMub3B0cy5idW5kbGVJZCkge1xuICAgICAgICBhd2FpdCB0aGlzLmluc3RhbGxJcGEoKTtcbiAgICAgICAgbG9nZ2VyLmRlYnVnKCdBcHAgaW5zdGFsbGVkLicpO1xuICAgICAgfSBlbHNlIGlmICh0aGlzLm9wdHMuaXBhKSB7XG4gICAgICAgIGxldCBtc2cgPSBcIllvdSBzcGVjaWZpZWQgYSBVRElEIGFuZCBpcGEgYnV0IGRpZCBub3QgaW5jbHVkZSB0aGUgYnVuZGxlIGlkXCI7XG4gICAgICAgIGxvZ2dlci53YXJuKG1zZyk7XG4gICAgICAgIHRocm93IG5ldyBlcnJvcnMuVW5rbm93bkVycm9yKG1zZyk7XG4gICAgICB9IGVsc2UgaWYgKHRoaXMub3B0cy5hcHApIHtcbiAgICAgICAgYXdhaXQgdGhpcy5yZWFsRGV2aWNlLmluc3RhbGwodGhpcy5vcHRzLmFwcCk7XG4gICAgICAgIGxvZ2dlci5kZWJ1ZygnQXBwIGluc3RhbGxlZC4nKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGxvZ2dlci5kZWJ1ZyhcIlJlYWwgZGV2aWNlIHNwZWNpZmllZCBidXQgbm8gaXBhIG9yIGFwcCBwYXRoLCBhc3N1bWluZyBidW5kbGUgSUQgaXMgXCIgK1xuICAgICAgICAgICAgICAgICAgICAgXCJvbiBkZXZpY2VcIik7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIGxvZ2dlci5kZWJ1ZyhcIk5vIGRldmljZSBpZCBvciBhcHAsIG5vdCBpbnN0YWxsaW5nIHRvIHJlYWwgZGV2aWNlLlwiKTtcbiAgICB9XG4gIH1cblxuICBnZXRJRGV2aWNlT2JqICgpIHtcbiAgICBsZXQgaWRpUGF0aCA9IHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsIFwiLi4vLi4vLi4vYnVpbGQvXCIsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXCJsaWJpbW9iaWxlZGV2aWNlLW1hY29zeC9pZGV2aWNlaW5zdGFsbGVyXCIpO1xuICAgIGxvZ2dlci5kZWJ1ZyhgQ3JlYXRpbmcgaURldmljZSBvYmplY3Qgd2l0aCB1ZGlkICR7dGhpcy5vcHRzLnVkaWR9YCk7XG4gICAgdHJ5IHtcbiAgICAgIHJldHVybiBpRGV2aWNlKHRoaXMub3B0cy51ZGlkKTtcbiAgICB9IGNhdGNoIChlMSkge1xuICAgICAgbG9nZ2VyLmRlYnVnKGBDb3VsZG4ndCBmaW5kIGlkZXZpY2VpbnN0YWxsZXIsIHRyeWluZyBidWlsdC1pbiBhdCAke2lkaVBhdGh9YCk7XG4gICAgICB0cnkge1xuICAgICAgICByZXR1cm4gaURldmljZSh0aGlzLm9wdHMudWRpZCwge2NtZDogaWRpUGF0aH0pO1xuICAgICAgfSBjYXRjaCAoZTIpIHtcbiAgICAgICAgbGV0IG1zZyA9IFwiQ291bGQgbm90IGluaXRpYWxpemUgaWRldmljZWluc3RhbGxlcjsgbWFrZSBzdXJlIGl0IGlzIFwiICtcbiAgICAgICAgICAgICAgICAgIFwiaW5zdGFsbGVkIGFuZCB3b3JrcyBvbiB5b3VyIHN5c3RlbVwiO1xuICAgICAgICBsb2dnZXIuZXJyb3IobXNnKTtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKG1zZyk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgaW5zdGFsbElwYSAoKSB7XG4gICAgbG9nZ2VyLmRlYnVnKGBJbnN0YWxsaW5nIGlwYSBmb3VuZCBhdCAke3RoaXMub3B0cy5pcGF9YCk7XG4gICAgaWYgKGF3YWl0IHRoaXMucmVhbERldmljZS5pc0luc3RhbGxlZCh0aGlzLm9wdHMuYnVuZGxlSWQpKSB7XG4gICAgICBsb2dnZXIuZGVidWcoXCJCdW5kbGUgZm91bmQgb24gZGV2aWNlLCByZW1vdmluZyBiZWZvcmUgcmVpbnN0YWxsaW5nLlwiKTtcbiAgICAgIGF3YWl0IHRoaXMucmVhbERldmljZS5yZW1vdmUodGhpcy5vcHRzLmJ1bmRsZUlkKTtcbiAgICB9IGVsc2Uge1xuICAgICAgbG9nZ2VyLmRlYnVnKFwiTm90aGluZyBmb3VuZCBvbiBkZXZpY2UsIGdvaW5nIGFoZWFkIGFuZCBpbnN0YWxsaW5nLlwiKTtcbiAgICB9XG4gICAgYXdhaXQgdGhpcy5yZWFsRGV2aWNlLmluc3RhbGxBbmRXYWl0KHRoaXMub3B0cy5pcGEsIHRoaXMub3B0cy5idW5kbGVJZCk7XG4gIH1cblxuICB2YWxpZGF0ZURlc2lyZWRDYXBzIChjYXBzKSB7XG4gICAgLy8gY2hlY2sgd2l0aCB0aGUgYmFzZSBjbGFzcywgYW5kIHJldHVybiBpZiBpdCBmYWlsc1xuICAgIGxldCByZXMgPSBzdXBlci52YWxpZGF0ZURlc2lyZWRDYXBzKGNhcHMpO1xuICAgIGlmICghcmVzKSByZXR1cm4gcmVzOyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIGN1cmx5XG5cbiAgICByZXR1cm4gZGVzaXJlZENhcFZhbGlkYXRpb24oY2Fwcyk7XG4gIH1cblxuICBhc3luYyBwcmVsYXVuY2hTaW11bGF0b3IgKCkge1xuICAgIGlmICghdGhpcy5zaG91bGRQcmVsYXVuY2hTaW11bGF0b3IpIHtcbiAgICAgIGxvZ2dlci5kZWJ1ZyhcIk5vdCBwcmUtbGF1bmNoaW5nIHNpbXVsYXRvclwiKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgYXdhaXQgZW5kU2ltdWxhdG9yKHRoaXMuc2ltKTtcbiAgICAvLyBUT0RPOiBpbXBsZW1lbnQgcHJlbGF1bmNoIHNpbSBpbiBzaW11bGF0b3IgcGFja2FnZVxuICB9XG5cbiAgYXN5bmMgb25JbnN0cnVtZW50c0xhdW5jaCAoKSB7XG4gICAgbG9nZ2VyLmRlYnVnKCdJbnN0cnVtZW50cyBsYXVuY2hlZC4gU3RhcnRpbmcgcG9sbCBsb29wIGZvciBuZXcgY29tbWFuZHMuJyk7XG4gICAgaWYgKHRoaXMub3B0cy5vcmlnQXBwUGF0aCkge1xuICAgICAgbG9nZ2VyLmRlYnVnKFwiQ29weWluZyBhcHAgYmFjayB0byBpdHMgb3JpZ2luYWwgcGxhY2VcIik7XG4gICAgICByZXR1cm4gYXdhaXQgZnMuY29weUZpbGUodGhpcy5vcHRzLmFwcCwgdGhpcy5vcHRzLm9yaWdBcHBQYXRoKTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBzZXRCdW5kbGVJZCAoKSB7XG4gICAgaWYgKHRoaXMub3B0cy5idW5kbGVJZCkge1xuICAgICAgLy8gV2UgYWxyZWFkeSBoYXZlIGEgYnVuZGxlIElkXG4gICAgICByZXR1cm47XG4gICAgfSBlbHNlIHtcbiAgICAgIGxldCBiSWQgPSBhd2FpdCB0aGlzLnVpQXV0b0NsaWVudC5zZW5kQ29tbWFuZCgnYXUuYnVuZGxlSWQoKScpO1xuICAgICAgbG9nZ2VyLmRlYnVnKGBCdW5kbGUgSUQgZm9yIG9wZW4gYXBwIGlzICR7YklkLnZhbHVlfWApO1xuICAgICAgdGhpcy5vcHRzLmJ1bmRsZUlkID0gYklkLnZhbHVlO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIHN0YXJ0SVdEUCAoKSB7XG4gICAgaWYgKHRoaXMub3B0cy5zdGFydElXRFApIHtcbiAgICAgIHRoaXMuaXdkcFNlcnZlciA9IG5ldyBJV0RQKHRoaXMub3B0cy53ZWJraXREZWJ1Z1Byb3h5UG9ydCwgdGhpcy5vcHRzLnVkaWQpO1xuICAgICAgYXdhaXQgdGhpcy5pd2RwU2VydmVyLnN0YXJ0KCk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgc3RvcElXRFAgKCkge1xuICAgIGlmICh0aGlzLml3ZHBTZXJ2ZXIpIHtcbiAgICAgIGF3YWl0IHRoaXMuaXdkcFNlcnZlci5zdG9wKCk7XG4gICAgICBkZWxldGUgdGhpcy5pd2RwU2VydmVyO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIHNldEluaXRpYWxPcmllbnRhdGlvbiAoKSB7XG4gICAgaWYgKHR5cGVvZiB0aGlzLm9wdHMuaW5pdGlhbE9yaWVudGF0aW9uID09PSBcInN0cmluZ1wiICYmXG4gICAgICAgIF8uaW5jbHVkZXMoW1wiTEFORFNDQVBFXCIsIFwiUE9SVFJBSVRcIl0sXG4gICAgICAgICAgICAgICAgICAgdGhpcy5vcHRzLmluaXRpYWxPcmllbnRhdGlvbi50b1VwcGVyQ2FzZSgpKVxuICAgICAgICApIHtcbiAgICAgIGxvZ2dlci5kZWJ1ZyhgU2V0dGluZyBpbml0aWFsIG9yaWVudGF0aW9uIHRvICR7dGhpcy5vcHRzLmluaXRpYWxPcmllbnRhdGlvbn1gKTtcbiAgICAgIGxldCBjb21tYW5kID0gYGF1LnNldFNjcmVlbk9yaWVudGF0aW9uKCcke3RoaXMub3B0cy5pbml0aWFsT3JpZW50YXRpb24udG9VcHBlckNhc2UoKX0nKWA7XG4gICAgICB0cnkge1xuICAgICAgICBhd2FpdCB0aGlzLnVpQXV0b0NsaWVudC5zZW5kQ29tbWFuZChjb21tYW5kKTtcbiAgICAgICAgdGhpcy5vcHRzLmN1ck9yaWVudGF0aW9uID0gdGhpcy5vcHRzLmluaXRpYWxPcmllbnRhdGlvbjtcbiAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICBsb2dnZXIud2FybihgU2V0dGluZyBpbml0aWFsIG9yaWVudGF0aW9uIGZhaWxlZCB3aXRoOiAke2Vycn1gKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBpc1JlYWxEZXZpY2UgKCkge1xuICAgIHJldHVybiAhIXRoaXMub3B0cy51ZGlkO1xuICB9XG5cbiAgaXNTYWZhcmkgKCkge1xuICAgIHJldHVybiB0aGlzLm9wdHMuc2FmYXJpO1xuICB9XG5cbiAgYXN5bmMgd2FpdEZvckFwcExhdW5jaGVkICAoKSB7XG4gICAgLy8gb24gaU9TOCBpbiBwYXJ0aWN1bGFyLCB3ZSBjYW4gZ2V0IGEgd29ya2luZyBzZXNzaW9uIGJlZm9yZSB0aGUgYXBwXG4gICAgLy8gaXMgcmVhZHkgdG8gcmVzcG9uZCB0byBjb21tYW5kczsgaW4gdGhhdCBjYXNlIHRoZSBzb3VyY2Ugd2lsbCBiZSBlbXB0eVxuICAgIC8vIHNvIHdlIGp1c3Qgc3BpbiB1bnRpbCBpdCdzIG5vdFxuICAgIGxldCBjb25kRm47XG4gICAgaWYgKHRoaXMub3B0cy53YWl0Rm9yQXBwU2NyaXB0KSB7XG4gICAgICAvLyB0aGUgZGVmYXVsdCBnZXRTb3VyY2VGb3JFbGVtZW50Rm9yWE1MIGRvZXMgbm90IGZpdCBzb21lIHVzZSBjYXNlLCBzbyBtYWtpbmcgdGhpcyBjdXN0b21pemFibGUuXG4gICAgICAvLyBUT0RPOiBjb2xsZWN0IHNjcmlwdCBmcm9tIGN1c3RvbWVyIGFuZCBwcm9wb3NlIHNldmVyYWwgb3B0aW9ucywgcGxlYXNlIGNvbW1lbnQgaW4gaXNzdWUgIzQxOTAuXG4gICAgICBsb2dnZXIuZGVidWcoYFVzaW5nIGN1c3RvbSBzY3JpcHQgdG8gd2FpdCBmb3IgYXBwIHN0YXJ0OiAke3RoaXMub3B0cy53YWl0Rm9yQXBwU2NyaXB0fWApO1xuICAgICAgY29uZEZuID0gYXN5bmMgKCkgPT4ge1xuICAgICAgICBsZXQgcmVzO1xuICAgICAgICB0cnkge1xuICAgICAgICAgIHJlcyA9IGF3YWl0IHRoaXMudWlBdXRvQ2xpZW50LnNlbmRDb21tYW5kKGB0cnl7XFxuJHt0aGlzLm9wdHMud2FpdEZvckFwcFNjcmlwdH1gICtcbiAgICAgICAgICAgICAgICAgICAgIGBcXG59IGNhdGNoKGVycikgeyAkLmxvZyhcIndhaXRGb3JBcHBTY3JpcHQgZXJyOiBcIiArIGVycm9yKTsgZmFsc2U7IH07YCk7XG4gICAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhgQ2Fubm90IGV2YWwgd2FpdEZvckFwcFNjcmlwdCBzY3JpcHQsIGVycjogJHtlcnJ9YCk7XG4gICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9XG4gICAgICAgIGlmICh0eXBlb2YgcmVzICE9PSAnYm9vbGVhbicpIHtcbiAgICAgICAgICBsb2dnZXIuZGVidWcoJ1VuZXhwZWN0ZWQgcmV0dXJuIHR5cGUgaW4gd2FpdEZvckFwcFNjcmlwdCBzY3JpcHQnKTtcbiAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHJlcztcbiAgICAgIH07XG4gICAgfSBlbHNlIGlmICh0aGlzLmlzU2FmYXJpKCkpIHtcbiAgICAgIGlmICh0aGlzLmlzUmVhbERldmljZSgpKSB7XG4gICAgICAgIGF3YWl0IHRoaXMuY2xpY2tCdXR0b25Ub0xhdW5jaFNhZmFyaSgpO1xuICAgICAgfVxuICAgICAgbG9nZ2VyLmRlYnVnKCdXYWl0aW5nIGZvciBpbml0aWFsIHdlYnZpZXcnKTtcbiAgICAgIGF3YWl0IHRoaXMubmF2VG9Jbml0aWFsV2VidmlldygpO1xuICAgICAgY29uZEZuID0gYXN5bmMgKCkgPT4ge1xuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgIH07XG4gICAgfSBlbHNlIHtcbiAgICAgIGxvZ2dlci5kZWJ1ZyhcIldhaXRpbmcgZm9yIGFwcCBzb3VyY2UgdG8gY29udGFpbiBlbGVtZW50c1wiKTtcbiAgICAgIGNvbmRGbiA9IGFzeW5jICgpID0+IHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICBsZXQgc291cmNlID0gYXdhaXQgdGhpcy5nZXRTb3VyY2VGb3JFbGVtZW50Rm9yWE1MKCk7XG4gICAgICAgICAgc291cmNlID0gSlNPTi5wYXJzZShzb3VyY2UgfHwgXCJ7fVwiKTtcbiAgICAgICAgICBsZXQgYXBwRWxzID0gKHNvdXJjZS5VSUFBcHBsaWNhdGlvbiB8fCB7fSlbJz4nXTtcbiAgICAgICAgICByZXR1cm4gYXBwRWxzICYmIGFwcEVscy5sZW5ndGggPiAwICYmICFJb3NEcml2ZXIuaXNTcHJpbmdCb2FyZChzb3VyY2UuVUlBQXBwbGljYXRpb24pO1xuICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgbG9nZ2VyLndhcm4oYENvdWxkbid0IGV4dHJhY3QgYXBwIGVsZW1lbnQgZnJvbSBzb3VyY2UsIGVycm9yIHdhczogJHtlfWApO1xuICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuICAgICAgfTtcbiAgICB9XG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IHdhaXRGb3JDb25kaXRpb24oY29uZEZuLCB7bG9nZ2VyLCB3YWl0TXM6IDEwMDAwLCBpbnRlcnZhbE1zOiA1MDB9KTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGlmIChlcnIubWVzc2FnZSAmJiBlcnIubWVzc2FnZS5tYXRjaCgvQ29uZGl0aW9uIHVubWV0LykpIHtcbiAgICAgICAgbG9nZ2VyLndhcm4oJ0luaXRpYWwgc3BpbiB0aW1lZCBvdXQsIGNvbnRpbnVpbmcgYnV0IHRoZSBhcHAgbWlnaHQgbm90IGJlIHJlYWR5LicpO1xuICAgICAgICBsb2dnZXIuZGVidWcoYEluaXRpYWwgc3BpbiBlcnJvciB3YXM6ICR7ZXJyfWApO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhyb3cgZXJyO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHN0YXRpYyBpc1NwcmluZ0JvYXJkICh1aUFwcE9iaikge1xuICAvLyBUT0RPOiBtb3ZlIHRvIGhlbHBlcnNcbiAgLy8gVGVzdCBmb3IgaU9TIGhvbWVzY3JlZW4gKFNwcmluZ0JvYXJkKS4gQVVUIG9jY2Fzc2lvbmFsbHkgc3RhcnQgdGhlIHNpbSwgYnV0IGZhaWxzIHRvIGxvYWRcbiAgLy8gdGhlIGFwcC4gSWYgdGhhdCBvY2N1cnMsIGdldFNvdXJjZUZvckVsZW1lbnRGb1hNTCB3aWxsIHJldHVybiBhIGRvYyBvYmplY3QgdGhhdCBtZWV0cyBvdXJcbiAgLy8gYXBwLWNoZWNrIGNvbmRpdGlvbnMsIHJlc3VsdGluZyBpbiBhIGZhbHNlIHBvc2l0aXZlLiBUaGlzIGZ1bmN0aW9uIHRlc3RzIHRoZSBVaUFwcGxpY2F0aW9uXG4gIC8vIHByb3BlcnR5J3MgbWV0YSBkYXRhIHRvIGVuc3VyZSB0aGF0IHRoZSBBcHBpdW0gZG9lc24ndCBjb25mdXNlIFNwcmluZ0JvYXJkIHdpdGggdGhlIGFwcFxuICAvLyB1bmRlciB0ZXN0LlxuICAgIHJldHVybiBfLnByb3BlcnR5T2YodWlBcHBPYmpbJ0AnXSkoJ25hbWUnKSA9PT0gJ1NwcmluZ0JvYXJkJztcbiAgfVxuXG4gIGFzeW5jIGNyZWF0ZUluc3RydW1lbnRzICgpIHtcbiAgICBsb2dnZXIuZGVidWcoXCJDcmVhdGluZyBpbnN0cnVtZW50c1wiKTtcbiAgICB0aGlzLnVpQXV0b0NsaWVudCA9IG5ldyBVSUF1dG9DbGllbnQodGhpcy5zb2NrKTtcbiAgICB0aGlzLmluc3RydW1lbnRzID0gYXdhaXQgdGhpcy5tYWtlSW5zdHJ1bWVudHMoKTtcbiAgICB0aGlzLmluc3RydW1lbnRzLm9uU2h1dGRvd24uY2F0Y2goYXN5bmMgKCkgPT4geyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIHByb21pc2UvY2F0Y2gtb3ItcmV0dXJuXG4gICAgICAvLyB1bmV4cGVjdGVkIGV4aXRcbiAgICAgIGF3YWl0IHRoaXMuc3RhcnRVbmV4cGVjdGVkU2h1dGRvd24obmV3IGVycm9ycy5Vbmtub3duRXJyb3IoJ0Fibm9ybWFsIEluc3RydW1lbnRzIHRlcm1pbmF0aW9uIScpKTtcbiAgICB9KS5kb25lKCk7XG4gIH1cblxuICBzaG91bGRJZ25vcmVJbnN0cnVtZW50c0V4aXQgKCkge1xuICAgIHJldHVybiB0aGlzLnNhZmFyaSAmJiB0aGlzLmlzUmVhbERldmljZSgpO1xuICB9XG5cbiAgYXN5bmMgbWFrZUluc3RydW1lbnRzICgpIHtcbiAgICAvLyBhdCB0aGUgbW9tZW50IGFsbCB0aGUgbG9nZ2luZyBpbiB1aWF1dG8gaXMgYXQgZGVidWcgbGV2ZWxcbiAgICBsZXQgYm9vdHN0cmFwUGF0aCA9IGF3YWl0IHByZXBhcmVCb290c3RyYXAoe1xuICAgICAgc29jazogdGhpcy5zb2NrLFxuICAgICAgaW50ZXJLZXlEZWxheTogdGhpcy5vcHRzLmludGVyS2V5RGVsYXksXG4gICAgICBqdXN0TG9vcEluZmluaXRlbHk6IGZhbHNlLFxuICAgICAgYXV0b0FjY2VwdEFsZXJ0czogdGhpcy5vcHRzLmF1dG9BY2NlcHRBbGVydHMsXG4gICAgICBhdXRvRGlzbWlzc0FsZXJ0czogdGhpcy5vcHRzLmF1dG9EaXNtaXNzQWxlcnRzLFxuICAgICAgc2VuZEtleVN0cmF0ZWd5OiB0aGlzLm9wdHMuc2VuZEtleVN0cmF0ZWd5IHx8ICh0aGlzLmlzUmVhbERldmljZSgpID8gJ2dyb3VwZWQnIDogJ29uZUJ5T25lJylcbiAgICB9KTtcbiAgICBsZXQgaW5zdHJ1bWVudHMgPSBuZXcgSW5zdHJ1bWVudHMoe1xuICAgICAgLy8gb24gcmVhbCBkZXZpY2VzIGJ1bmRsZUlkIGlzIGFsd2F5cyB1c2VkXG4gICAgICBhcHA6ICghdGhpcy5pc1JlYWxEZXZpY2UoKSA/IHRoaXMub3B0cy5hcHAgOiBudWxsKSB8fCB0aGlzLm9wdHMuYnVuZGxlSWQsXG4gICAgICB1ZGlkOiB0aGlzLm9wdHMudWRpZCxcbiAgICAgIHByb2Nlc3NBcmd1bWVudHM6IHRoaXMub3B0cy5wcm9jZXNzQXJndW1lbnRzLFxuICAgICAgaWdub3JlU3RhcnR1cEV4aXQ6IHRoaXMuc2hvdWxkSWdub3JlSW5zdHJ1bWVudHNFeGl0KCksXG4gICAgICBib290c3RyYXA6IGJvb3RzdHJhcFBhdGgsXG4gICAgICB0ZW1wbGF0ZTogdGhpcy5vcHRzLmF1dG9tYXRpb25UcmFjZVRlbXBsYXRlUGF0aCxcbiAgICAgIGluc3RydW1lbnRzUGF0aDogdGhpcy5vcHRzLmluc3RydW1lbnRzUGF0aCxcbiAgICAgIHdpdGhvdXREZWxheTogdGhpcy5vcHRzLndpdGhvdXREZWxheSxcbiAgICAgIHBsYXRmb3JtVmVyc2lvbjogdGhpcy5vcHRzLnBsYXRmb3JtVmVyc2lvbixcbiAgICAgIHdlYlNvY2tldDogdGhpcy5vcHRzLndlYlNvY2tldCxcbiAgICAgIGxhdW5jaFRpbWVvdXQ6IHRoaXMub3B0cy5sYXVuY2hUaW1lb3V0LFxuICAgICAgZmxha2V5UmV0cmllczogdGhpcy5vcHRzLmJhY2tlbmRSZXRyaWVzLFxuICAgICAgcmVhbERldmljZTogdGhpcy5pc1JlYWxEZXZpY2UoKSxcbiAgICAgIHNpbXVsYXRvclNka0FuZERldmljZTogdGhpcy5pb3NTZGtWZXJzaW9uID49IDcuMSA/IGF3YWl0IGdldEFkanVzdGVkRGV2aWNlTmFtZSh0aGlzLm9wdHMpIDogbnVsbCxcbiAgICAgIHRtcERpcjogcGF0aC5yZXNvbHZlKHRoaXMub3B0cy50bXBEaXIgfHwgJy90bXAnLCAnYXBwaXVtLWluc3RydW1lbnRzJyksXG4gICAgICB0cmFjZURpcjogdGhpcy5vcHRzLnRyYWNlRGlyLFxuICAgICAgbG9jYWxlOiB0aGlzLm9wdHMubG9jYWxlLFxuICAgICAgbGFuZ3VhZ2U6IHRoaXMub3B0cy5sYW5ndWFnZVxuICAgIH0pO1xuICAgIHJldHVybiBpbnN0cnVtZW50cztcbiAgfVxuXG4gIGFzeW5jIHN0YXJ0SW5zdHJ1bWVudHMgKCkge1xuICAgIGxvZ2dlci5kZWJ1ZyhcIlN0YXJ0aW5nIFVJQXV0b0NsaWVudCwgYW5kIGxhdW5jaGluZyBJbnN0cnVtZW50cy5cIik7XG5cbiAgICBhd2FpdCBCLmFsbChbXG4gICAgICB0aGlzLnVpQXV0b0NsaWVudC5zdGFydCgpLnRoZW4oKCkgPT4geyB0aGlzLmluc3RydW1lbnRzLnJlZ2lzdGVyTGF1bmNoKCk7IH0pLFxuICAgICAgdGhpcy5pbnN0cnVtZW50cy5sYXVuY2goKVxuICAgIF0pO1xuICB9XG5cbiAgYXN5bmMgY29uZmlndXJlQm9vdHN0cmFwICgpIHtcbiAgICBsb2dnZXIuZGVidWcoXCJTZXR0aW5nIGJvb3RzdHJhcCBjb25maWcga2V5cy92YWx1ZXNcIik7XG4gICAgbGV0IGlzVmVyYm9zZSA9IHRydWU7IC8vIFRPRE86IGxldmVsIHdhcyBjb25maWd1cmVkIGFjY29yZGluZyB0byBsb2dnZXJcbiAgICBsZXQgY21kID0gJ3RhcmdldCA9ICQudGFyZ2V0KCk7XFxuJztcbiAgICBjbWQgKz0gJ2F1ID0gJDtcXG4nO1xuICAgIGNtZCArPSBgJC5pc1ZlcmJvc2UgPSAke2lzVmVyYm9zZX07XFxuYDtcbiAgICAvLyBOb3QgdXNpbmcgdWlhdXRvIGdyYWNlIHBlcmlvZCBiZWNhdXNlIG9mIGJ1Zy5cbiAgICAvLyBjbWQgKz0gJyQudGFyZ2V0KCkuc2V0VGltZW91dCgxKTtcXG4nO1xuICAgIGF3YWl0IHRoaXMudWlBdXRvQ2xpZW50LnNlbmRDb21tYW5kKGNtZCk7XG4gIH1cblxuICBhc3luYyBnZXRTb3VyY2VGb3JFbGVtZW50Rm9yWE1MIChjdHgpIHtcbiAgICBsZXQgc291cmNlO1xuICAgIGlmICghY3R4KSB7XG4gICAgICBzb3VyY2UgPSBhd2FpdCB0aGlzLnVpQXV0b0NsaWVudC5zZW5kQ29tbWFuZChcImF1Lm1haW5BcHAoKS5nZXRUcmVlRm9yWE1MKClcIik7XG4gICAgfSBlbHNlIHtcbiAgICAgIHNvdXJjZSA9IGF3YWl0IHRoaXMudWlBdXRvQ2xpZW50LnNlbmRDb21tYW5kKGBhdS5nZXRFbGVtZW50KCcke2N0eH0nKS5nZXRUcmVlRm9yWE1MKClgKTtcbiAgICB9XG4gICAgLy8gVE9ETzogYWxsIHRoaXMganNvbi94bWwgbG9naWMgaXMgdmVyeSBleHBlbnNpdmUsIHdlIG5lZWRcbiAgICAvLyB0byB1c2UgYSBTQVggcGFyc2VyIGluc3RlYWQuXG4gICAgaWYgKHNvdXJjZSkge1xuICAgICAgcmV0dXJuIEpTT04uc3RyaW5naWZ5KHNvdXJjZSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIHRoaXMgc2hvdWxkIG5ldmVyIGhhcHBlbiBidXQgd2UndmUgcmVjZWl2ZWQgYnVnIHJlcG9ydHM7IHRoaXMgd2lsbCBoZWxwIHVzIHRyYWNrIGRvd25cbiAgICAgIC8vIHdoYXQncyB3cm9uZyBpbiBnZXRUcmVlRm9yWE1MXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYEJhZCByZXNwb25zZSBmcm9tIGdldFRyZWVGb3JYTUwuIHJlcyB3YXMgJHtKU09OLnN0cmluZ2lmeShzb3VyY2UpfWApO1xuICAgIH1cbiAgfVxuXG4gIGdldCByZWFsRGV2aWNlICgpIHtcbiAgICB0aGlzLl9yZWFsRGV2aWNlID0gdGhpcy5fcmVhbERldmljZSB8fCB0aGlzLmdldElEZXZpY2VPYmooKTtcbiAgICByZXR1cm4gdGhpcy5fcmVhbERldmljZTtcbiAgfVxuXG4gIHNldCByZWFsRGV2aWNlIChyZCkge1xuICAgIHRoaXMuX3JlYWxEZXZpY2UgPSByZDtcbiAgfVxufVxuXG5mb3IgKGxldCBbY21kLCBmbl0gb2YgXy50b1BhaXJzKGNvbW1hbmRzKSkge1xuICBJb3NEcml2ZXIucHJvdG90eXBlW2NtZF0gPSBmbjtcbn1cblxuXG5leHBvcnQgeyBJb3NEcml2ZXIsIGRlZmF1bHRTZXJ2ZXJDYXBzIH07XG5leHBvcnQgZGVmYXVsdCBJb3NEcml2ZXI7XG4iXSwic291cmNlUm9vdCI6Ii4uLy4uIn0=
